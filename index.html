<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#16a34a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>ê°™ì´ ë†€ëŸ¬ê°€ì ğŸ•ï¸</title>

  <!-- íŒŒë¹„ì½˜ -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ•ï¸</text></svg>" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ•ï¸</text></svg>" />

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- Kakao SDK -->
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js" integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2vxfAAD0eZxzCKakxg55G4" crossorigin="anonymous"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior-y: contain; }
    
    @keyframes slideUp { 
      from { transform: translateY(100%);} 
      to { transform: translateY(0);} 
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    
    @keyframes sway {
      0%, 100% { transform: rotate(-3deg); }
      50% { transform: rotate(3deg); }
    }
    
    @keyframes flicker {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }
    
    .animate-slide-up { animation: slideUp 0.3s ease-out; }
    .animate-bounce { animation: bounce 2s ease-in-out infinite; }
    .animate-sway { animation: sway 3s ease-in-out infinite; }
    .animate-flicker { animation: flicker 1.5s ease-in-out infinite; }
    
    input, textarea, select { font-size: 16px !important; }

    /* ë‚ ì§œì…ë ¥ UI */
    .date-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    .date-input {
      width: 100%;
      min-width: 130px;
      display: block;
      padding: 0.7rem 0.6rem;
      font-size: 14px !important;
    }
    input[type="date"]::-webkit-date-and-time-value { min-height: 1.6em; }
    @media (max-width: 420px) {
      .date-grid { gap: 0.5rem; }
      .date-input { min-width: 110px; padding: 0.6rem 0.5rem; font-size: 13px !important; }
    }
    @media (max-width: 360px) { 
      .date-grid { gap: 0.4rem; }
      .date-input { 
        min-width: 100px; 
        padding: 0.5rem 0.6rem;
        font-size: 14px !important;
      }
    }

    /* sticky í—¤ë” */
    .app-header { position: sticky; top: 0; z-index: 10; }
    
    /* ë¡œë”© í™”ë©´ */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
    /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 50px;
      padding: 4px 2px;
    }
    
    .calendar-day:active {
      transform: scale(0.95);
    }
    
    .calendar-day.today {
      border: 2px solid #16a34a;
    }
    
    .calendar-day.selected {
      background-color: #16a34a;
      color: white;
    }
    
    .calendar-day.other-month {
      opacity: 0.3;
    }
    
    .calendar-day.has-schedule::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background-color: #3b82f6; /* íŒŒë€ìƒ‰ */
    }
    
    .calendar-day.is-holiday::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background-color: #ef4444; /* ë¹¨ê°„ìƒ‰ */
    }
    
    .calendar-day.selected.has-schedule::after,
    .calendar-day.selected.is-holiday::after {
      background-color: white;
    }
    
    .calendar-weekday {
      padding: 8px 0;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
    }
    
    .calendar-weekday.sunday {
      color: #ef4444;
    }
    
    .calendar-weekday.saturday {
      color: #3b82f6;
    }

    /* ì°¸ì—¬ì ì„ íƒ ë“œë¡­ë‹¤ìš´ */
    select[multiple] {
      appearance: none;
      background-color: white;
      font-size: 14px !important;
    }
    
    select[multiple] option {
      padding: 10px 12px;
      border-radius: 4px;
      margin: 2px 0;
      font-size: 14px;
    }
    
    select[multiple] option:checked {
      background: linear-gradient(0deg, #16a34a 0%, #16a34a 100%);
      color: white;
      font-weight: 600;
    }
  </style>

  <!-- flatpickr DatePicker for custom date range -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script>
    // Firebaseê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    let db;
    
    window.addEventListener('load', function() {
      /* Firebase ì„¤ì • */
      const firebaseConfig = {
        apiKey: "AIzaSyAu15qibhSy3rBEUYXOxRCqoBf-BlpLtJg",
        authDomain: "camp-4cd5d.firebaseapp.com",
        projectId: "camp-4cd5d",
        storageBucket: "camp-4cd5d.firebasestorage.app",
        messagingSenderId: "322221151055",
        appId: "1:322221151055:web:bf81c9f9310b4daf4f6b3a"
      };
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      
      // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
      if(window.Kakao && !Kakao.isInitialized()) {
        try {
          Kakao.init('cfa119df7c836dd3fa72269d16ee08f8');
          console.log('ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì™„ë£Œ');
        } catch(e) {
          console.warn('ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
        }
      }
      
      // Firebase ì´ˆê¸°í™” í›„ ì•± ì‹œì‘
      bootApp();
    });

    /* ìƒìˆ˜/ìƒíƒœ */
    const holidays = {
      // 2025ë…„
      '2025-01-01': 'ì‹ ì •','2025-01-28': 'ì„¤ë‚  ì—°íœ´','2025-01-29': 'ì„¤ë‚ ','2025-01-30': 'ì„¤ë‚  ì—°íœ´','2025-03-01': 'ì‚¼ì¼ì ˆ','2025-05-05': 'ì–´ë¦°ì´ë‚ ','2025-05-06': 'ëŒ€ì²´ê³µíœ´ì¼','2025-06-06': 'í˜„ì¶©ì¼','2025-08-15': 'ê´‘ë³µì ˆ','2025-10-03': 'ê°œì²œì ˆ','2025-10-05': 'ì¶”ì„ ì—°íœ´','2025-10-06': 'ì¶”ì„','2025-10-07': 'ì¶”ì„ ì—°íœ´','2025-10-08': 'ëŒ€ì²´ê³µíœ´ì¼','2025-10-09': 'í•œê¸€ë‚ ','2025-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
      // 2026ë…„
      '2026-01-01': 'ì‹ ì •','2026-02-16': 'ì„¤ë‚  ì—°íœ´','2026-02-17': 'ì„¤ë‚ ','2026-02-18': 'ì„¤ë‚  ì—°íœ´','2026-03-01': 'ì‚¼ì¼ì ˆ','2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼','2026-05-05': 'ì–´ë¦°ì´ë‚ ','2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ','2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼','2026-06-06': 'í˜„ì¶©ì¼','2026-08-15': 'ê´‘ë³µì ˆ','2026-09-24': 'ì¶”ì„ ì—°íœ´','2026-09-25': 'ì¶”ì„','2026-09-26': 'ì¶”ì„ ì—°íœ´','2026-10-03': 'ê°œì²œì ˆ','2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼','2026-10-09': 'í•œê¸€ë‚ ','2026-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
      // 2027ë…„
      '2027-01-01': 'ì‹ ì •','2027-02-06': 'ì„¤ë‚  ì—°íœ´','2027-02-07': 'ì„¤ë‚ ','2027-02-08': 'ì„¤ë‚  ì—°íœ´','2027-03-01': 'ì‚¼ì¼ì ˆ','2027-05-05': 'ì–´ë¦°ì´ë‚ ','2027-05-13': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ','2027-06-06': 'í˜„ì¶©ì¼','2027-06-07': 'ëŒ€ì²´ê³µíœ´ì¼','2027-08-15': 'ê´‘ë³µì ˆ','2027-08-16': 'ëŒ€ì²´ê³µíœ´ì¼','2027-09-14': 'ì¶”ì„ ì—°íœ´','2027-09-15': 'ì¶”ì„','2027-09-16': 'ì¶”ì„ ì—°íœ´','2027-10-03': 'ê°œì²œì ˆ','2027-10-04': 'ëŒ€ì²´ê³µíœ´ì¼','2027-10-09': 'í•œê¸€ë‚ ','2027-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
      // 2028ë…„
      '2028-01-01': 'ì‹ ì •','2028-01-26': 'ì„¤ë‚  ì—°íœ´','2028-01-27': 'ì„¤ë‚ ','2028-01-28': 'ì„¤ë‚  ì—°íœ´','2028-03-01': 'ì‚¼ì¼ì ˆ','2028-05-02': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ','2028-05-05': 'ì–´ë¦°ì´ë‚ ','2028-06-06': 'í˜„ì¶©ì¼','2028-08-15': 'ê´‘ë³µì ˆ','2028-10-02': 'ì¶”ì„ ì—°íœ´','2028-10-03': 'ì¶”ì„/ê°œì²œì ˆ','2028-10-04': 'ì¶”ì„ ì—°íœ´','2028-10-09': 'í•œê¸€ë‚ ','2028-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
      // 2029ë…„
      '2029-01-01': 'ì‹ ì •','2029-02-12': 'ì„¤ë‚  ì—°íœ´','2029-02-13': 'ì„¤ë‚ ','2029-02-14': 'ì„¤ë‚  ì—°íœ´','2029-03-01': 'ì‚¼ì¼ì ˆ','2029-05-05': 'ì–´ë¦°ì´ë‚ ','2029-05-20': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ','2029-05-21': 'ëŒ€ì²´ê³µíœ´ì¼','2029-06-06': 'í˜„ì¶©ì¼','2029-08-15': 'ê´‘ë³µì ˆ','2029-09-21': 'ì¶”ì„ ì—°íœ´','2029-09-22': 'ì¶”ì„','2029-09-23': 'ì¶”ì„ ì—°íœ´','2029-09-24': 'ëŒ€ì²´ê³µíœ´ì¼','2029-10-03': 'ê°œì²œì ˆ','2029-10-09': 'í•œê¸€ë‚ ','2029-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
      // 2030ë…„
      '2030-01-01': 'ì‹ ì •','2030-02-02': 'ì„¤ë‚  ì—°íœ´','2030-02-03': 'ì„¤ë‚ ','2030-02-04': 'ì„¤ë‚  ì—°íœ´','2030-03-01': 'ì‚¼ì¼ì ˆ','2030-05-05': 'ì–´ë¦°ì´ë‚ ','2030-05-06': 'ëŒ€ì²´ê³µíœ´ì¼','2030-05-09': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ','2030-06-06': 'í˜„ì¶©ì¼','2030-08-15': 'ê´‘ë³µì ˆ','2030-09-11': 'ì¶”ì„ ì—°íœ´','2030-09-12': 'ì¶”ì„','2030-09-13': 'ì¶”ì„ ì—°íœ´','2030-10-03': 'ê°œì²œì ˆ','2030-10-09': 'í•œê¸€ë‚ ','2030-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤'
    };
    const colorPalette = ['#6366f1','#ec4899','#10b981','#f59e0b','#8b5cf6','#06b6d4','#f97316','#14b8a6','#a855f7','#ef4444','#3b82f6','#84cc16'];

    let currentUser = null;
    let allUsers = [];
    let schedules = [];
    let campings = [];
    let prepItems = [];
    let expenses = []; // ì •ì‚° ë°ì´í„°
    let showModal = false;
    let selectedDate = null;
    let showCampingDetail = false;
    let selectedCamping = null;
    let showCampingModal = false;
    let editingCamping = null;
    let currentMonth = new Date();
    let showLoginModal = false;
    let isSignUp = false;
    let isLoading = false;
    let showAllSchedules = false; // ì „ì²´ ì¼ì • ë³´ê¸° íŒì—…
    let showPrepItemModal = false; // ì¤€ë¹„í•­ëª© ì‘ì„± ëª¨ë‹¬
    let showParticipantModal = false; // ì°¸ì—¬ì ì„ íƒ ëª¨ë‹¬
    let showExpenseModal = false; // ì •ì‚° ëª¨ë‹¬
    let tempSelectedParticipants = []; // ì„ì‹œ ì„ íƒëœ ì°¸ì—¬ì
    
    // Firebase ë¦¬ìŠ¤ë„ˆ unsubscribe í•¨ìˆ˜ë“¤
    let unsubscribeSchedules = null;
    let unsubscribeCampings = null;
    let unsubscribePrepItems = null;
    let unsubscribeExpenses = null;

    /* ìœ í‹¸ */
    const normalizePhone = (v)=> (v||'').replace(/\D/g,'');
    function formatDate(date){ const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
    function escapeHtml(text){ if(!text) return ''; return String(text).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ í•¨ìˆ˜ */
    window.customAlert = function(message){
      // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ëª¨ë‘ ì œê±°
      document.querySelectorAll('#customAlertModal').forEach(el => el.remove());
      
      // ìƒˆ ëª¨ë‹¬ ìƒì„±
      const modalHtml = `
        <div id="customAlertModal" class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl p-6 max-w-sm w-full animate-slide-up shadow-2xl">
            <div class="text-center mb-6">
              <div class="flex justify-center mb-3">
                <svg class="w-16 h-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div class="text-base text-gray-800 whitespace-pre-wrap">${escapeHtml(message)}</div>
            </div>
            <button onclick="closeCustomAlert()" 
              class="w-full py-3 bg-green-600 text-white rounded-lg font-medium active:bg-green-700">
              í™•ì¸
            </button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    window.closeCustomAlert = function(){
      // ëª¨ë“  alert ëª¨ë‹¬ ì œê±°
      document.querySelectorAll('#customAlertModal').forEach(el => el.remove());
    };

    window.customConfirm = function(message, callback){
      // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ëª¨ë‘ ì œê±°
      document.querySelectorAll('#customConfirmModal').forEach(el => el.remove());
      
      // ìƒˆ ëª¨ë‹¬ ìƒì„±
      const modalHtml = `
        <div id="customConfirmModal" class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl p-6 max-w-sm w-full animate-slide-up shadow-2xl">
            <div class="text-center mb-6">
              <div class="flex justify-center mb-3">
                <svg class="w-16 h-16 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div class="text-base text-gray-800 whitespace-pre-wrap">${escapeHtml(message)}</div>
            </div>
            <div class="flex gap-3">
              <button onclick="closeCustomConfirm(false)" 
                class="flex-1 py-3 border border-gray-300 rounded-lg font-medium active:bg-gray-100">
                ì·¨ì†Œ
              </button>
              <button onclick="closeCustomConfirm(true)" 
                class="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium active:bg-green-700">
                í™•ì¸
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // ì½œë°± ì €ì¥
      window._customConfirmCallback = callback;
    };

    window.closeCustomConfirm = function(confirmed){
      // ëª¨ë“  confirm ëª¨ë‹¬ ì œê±°
      document.querySelectorAll('#customConfirmModal').forEach(el => el.remove());
      
      if(confirmed && window._customConfirmCallback){
        window._customConfirmCallback();
      }
      window._customConfirmCallback = null;
    };
    function getCampingForDateRange(dateStr){ for (let i=0;i<campings.length;i++){ if(dateStr>=campings[i].startDate && dateStr<=campings[i].endDate){ return campings[i]; } } return null; }
    function getDaysDiffInclusive(startDate, endDate){ const s=new Date(startDate); const e=new Date(endDate); return Math.floor((e - s)/(1000*60*60*24)) + 1; }
    function getMonthYear(){ return `${currentMonth.getFullYear()}ë…„ ${currentMonth.getMonth()+1}ì›”`; }

    /* ì›” ì´ë™ */
    window.changeMonth = function(delta){ 
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+delta, 1); 
      selectedDate = null; // ì›” ë³€ê²½ ì‹œ ì„ íƒ í•´ì œ
      render(); 
    };

    /* ë‚ ì§œ ì„ íƒ */
    window.selectDate = function(dateStr) {
      selectedDate = dateStr;
      render();
    };

    /* Today ë²„íŠ¼ */
    window.goToToday = function() {
      const today = new Date();
      currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      selectedDate = formatDate(today);
      render();
    };

    /* ì „ì²´ ì¼ì • ë³´ê¸° */
    window.toggleAllSchedules = function() {
      showAllSchedules = !showAllSchedules;
      render();
    };

    /* ì¼ì • ëª©ë¡ì—ì„œ ìƒì„¸í˜ì´ì§€ ì—´ê¸° */
    window.openDetailFromList = function(campingId) {
      showAllSchedules = false; // ëª¨ë‹¬ ë‹«ê¸°
      openCampingDetail(campingId); // ìƒì„¸í˜ì´ì§€ ì—´ê¸°
    };

    /* ì¸ì¦ ëª¨ë‹¬ */
    window.openLoginModal = function(){ showLoginModal=true; isSignUp=false; render(); };
    window.openSignUpModal = function(){ showLoginModal=true; isSignUp=true; render(); };
    window.closeLoginModal = function(){ showLoginModal=false; isSignUp=false; render(); };
    window.toggleAuthMode = function(){ isSignUp=!isSignUp; render(); };

    /* ë¡œê·¸ì¸/íšŒì›ê°€ì… */
    window.handleAuth = function(){
      const teamName = document.getElementById('authTeamName').value.trim();
      const phoneRaw = document.getElementById('authPhone').value.trim();
      const phone = normalizePhone(phoneRaw);

      if(!teamName || !phone){ customAlert('íŒ€ ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      const phoneRegex = /^01[0-9]{8,9}$/;
      if(!phoneRegex.test(phone)){ customAlert('ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }

      if(isSignUp){
        db.collection('users').where('phone','==',phone).limit(1).get().then(sp=>{
          if(!sp.empty){ customAlert('ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'); throw 'dup-phone'; }
          return db.collection('users').where('name','==',teamName).limit(1).get();
        }).then(sn=>{
          if(!sn.empty){ customAlert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ íŒ€ ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); throw 'dup-name'; }
          const colorIndex = allUsers.length % colorPalette.length;
          const newUser = { name: teamName, phone: phone, colorIndex, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
          return db.collection('users').add(newUser);
        }).then(docRef=>{
          currentUser = { id: docRef.id, name: teamName, phone: phone, colorIndex: (allUsers.length % colorPalette.length) };
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          showLoginModal=false; isSignUp=false;
          init();
          render();
        }).catch(e=>{ if(e!=='dup-phone' && e!=='dup-name') customAlert('ì˜¤ë¥˜: '+e); });
      } else {
        db.collection('users').where('name','==',teamName).where('phone','==',phone).limit(1).get().then(snapshot=>{
          if(snapshot.empty){ customAlert('ì¼ì¹˜í•˜ëŠ” ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤. íšŒì›ê°€ì…í•´ì£¼ì„¸ìš”.'); return; }
          const doc = snapshot.docs[0];
          const u = doc.data();
          currentUser = { id: doc.id, name: u.name, phone: normalizePhone(u.phone), colorIndex: u.colorIndex };
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          showLoginModal=false;
          init();
          render();
        }).catch(e=>{ customAlert('ì˜¤ë¥˜: '+e); });
      }
    };

    /* ë¡œê·¸ì•„ì›ƒ */
    window.logout = function(){
      customConfirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(){
        currentUser=null;
        localStorage.removeItem('currentUser');
        render();
      });
    };

    /* ì¼ì • ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ */
    window.openCampingModal = function(dateStr=null){
      selectedDate = dateStr;
      editingCamping = null;
      showCampingModal = true;
      render();
    };

    window.editCampingModal = function(campingId){
      const c = campings.find(x=>x.id===campingId);
      if(!c) return;
      editingCamping = c;
      showCampingModal = true;
      render();
    };

    window.closeCampingModal = function(){
      showCampingModal = false;
      editingCamping = null;
      tempSelectedParticipants = [];
      render();
    };

    /* ì°¸ì—¬ì ì„ íƒ ëª¨ë‹¬ */
    window.openParticipantModal = function(){
      // âœ… í˜„ì¬ ì…ë ¥ í¼ ê°’ë“¤(ì´ë¦„/ì¥ì†Œ/ë©”ëª¨/ë‚ ì§œ ë“±)ì„ ë¨¼ì € ì €ì¥í•´ì„œ, ì°¸ì—¬ì ì„ íƒ ëª¨ë‹¬ì„ ì—´ì–´ë„ ê°’ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šë„ë¡ ì²˜ë¦¬
      const nameInput = document.getElementById('campingName');
      const startDateInput = document.getElementById('campingStartDate');
      const endDateInput = document.getElementById('campingEndDate');
      const addressInput = document.getElementById('campingAddress');
      const websiteInput = document.getElementById('campingWebsite');
      const infoInput = document.getElementById('campingInfo');

      if (!editingCamping) {
        editingCamping = {};
      }

      if (nameInput) editingCamping.name = nameInput.value;
      if (startDateInput) editingCamping.startDate = startDateInput.value;
      if (endDateInput) editingCamping.endDate = endDateInput.value;
      if (addressInput) editingCamping.address = addressInput.value;
      if (websiteInput) editingCamping.website = websiteInput.value;
      if (infoInput) editingCamping.info = infoInput.value;

      // í˜„ì¬ ì„ íƒëœ ì°¸ì—¬ìë¥¼ ì„ì‹œ ë°°ì—´ë¡œ ë³µì‚¬
      if(editingCamping && editingCamping.participants) {
        tempSelectedParticipants = [...editingCamping.participants];
      } else {
        tempSelectedParticipants = [];
      }
      showParticipantModal = true;
      render();
    };

    window.closeParticipantModal = function(){
      showParticipantModal = false;
      tempSelectedParticipants = [];
      render();
    };

    window.toggleParticipant = function(userId){
      const index = tempSelectedParticipants.indexOf(userId);
      if(index > -1) {
        tempSelectedParticipants.splice(index, 1);
      } else {
        tempSelectedParticipants.push(userId);
      }
      
      // ë²„íŠ¼ DOM ì§ì ‘ ì—…ë°ì´íŠ¸
      const button = event.currentTarget;
      const isSelected = tempSelectedParticipants.includes(userId);
      const user = allUsers.find(u => u.id === userId);
      if(!user) return;
      
      const color = colorPalette[user.colorIndex];
      
      // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      button.style.borderColor = isSelected ? color : '#e5e7eb';
      button.style.backgroundColor = isSelected ? color + '1a' : 'white';
      
      // ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
      const checkbox = button.querySelector('.w-5');
      if(checkbox) {
        checkbox.style.borderColor = color;
        checkbox.style.backgroundColor = isSelected ? color : 'white';
        checkbox.innerHTML = isSelected ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>' : '';
      }
      
      // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
      const counter = document.querySelector('.text-xs.text-gray-500.mb-4.text-center');
      if(counter) {
        counter.textContent = `${tempSelectedParticipants.length}ëª… ì„ íƒë¨`;
      }
    };

    window.confirmParticipantSelection = function(){
      if(tempSelectedParticipants.length === 0) {
        customAlert('ìµœì†Œ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì…ë ¥ëœ ë‚ ì§œ ì €ì¥ (render ì „ì— ì €ì¥í•´ì•¼ ê°’ì´ ìœ ì§€ë¨)
      const nameInput = document.getElementById('campingName');
      const startDateInput = document.getElementById('campingStartDate');
      const endDateInput = document.getElementById('campingEndDate');
      const addressInput = document.getElementById('campingAddress');
      const websiteInput = document.getElementById('campingWebsite');
      const infoInput = document.getElementById('campingInfo');
      
      // editingCampingì— ì €ì¥
      if(!editingCamping) {
        editingCamping = {};
      }
      
      editingCamping.participants = [...tempSelectedParticipants];
      
      // ì…ë ¥ í•„ë“œ ê°’ë“¤ ì €ì¥
      if(nameInput) editingCamping.name = nameInput.value;
      if(startDateInput) editingCamping.startDate = startDateInput.value;
      if(endDateInput) editingCamping.endDate = endDateInput.value;
      if(addressInput) editingCamping.address = addressInput.value;
      if(websiteInput) editingCamping.website = websiteInput.value;
      if(infoInput) editingCamping.info = infoInput.value;
      
      closeParticipantModal();
    };

    /* ì¼ì • ì €ì¥ */
    window.saveCamping = function(){
      const name = document.getElementById('campingName').value.trim();
      const startDate = document.getElementById('campingStartDate').value;
      const endDate = document.getElementById('campingEndDate').value;
      const address = document.getElementById('campingAddress').value.trim();
      const website = document.getElementById('campingWebsite').value.trim();
      const info = document.getElementById('campingInfo').value.trim();

      if(!name || !startDate || !endDate){ customAlert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      if(startDate > endDate){ customAlert('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }

      // ì°¸ì—¬ì ì„ íƒ (ëª¨ë‹¬ì—ì„œ ì„ íƒí•œ ì°¸ì—¬ì)
      const participants = editingCamping && editingCamping.participants ? editingCamping.participants : [];

      if(participants.length === 0) {
        customAlert('ì°¸ì—¬ìë¥¼ ìµœì†Œ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const data = {
        name, startDate, endDate, address, website, info,
        participants, // ì°¸ì—¬ì ë°°ì—´ ì¶”ê°€
        attendance: {}, // ì°¸ì—¬ ì—¬ë¶€ ê°ì²´ ì´ˆê¸°í™”
        createdBy: currentUser.id,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if(editingCamping && editingCamping.id){
        // ìˆ˜ì • ì‹œì—ëŠ” ê¸°ì¡´ ì°¸ì—¬ ì—¬ë¶€ ìœ ì§€
        data.attendance = editingCamping.attendance || {};
        db.collection('campings').doc(editingCamping.id).update(data).then(()=>{
          customAlert('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          // selectedCamping ì—…ë°ì´íŠ¸ (ì¼ì • ìƒì„¸ê°€ ì—´ë ¤ìˆëŠ” ê²½ìš°)
          if(showCampingDetail && selectedCamping && selectedCamping.id === editingCamping.id) {
            selectedCamping = Object.assign({}, selectedCamping, data, { id: editingCamping.id });
            updateCampingDetailDOM();
          }
          
          closeCampingModal();
        }).catch(e=>{ customAlert('ì˜¤ë¥˜: '+e); });
      } else {
        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        db.collection('campings').add(data).then(()=>{
          customAlert('ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeCampingModal();
        }).catch(e=>{ customAlert('ì˜¤ë¥˜: '+e); });
      }
    };

    /* ì¼ì • ìƒì„¸ DOM ë¶€ë¶„ ì—…ë°ì´íŠ¸ (ê¹œë¹¡ì„ ë°©ì§€) */
    function updateCampingDetailDOM(){
      if(!showCampingDetail || !selectedCamping) return;
      
      // ì œëª© ì—…ë°ì´íŠ¸
      const titleEl = document.querySelector('.bg-yellow-50 h4');
      if(titleEl) titleEl.textContent = selectedCamping.name;
      
      // ë‚ ì§œ ë° ì •ë³´ ì—…ë°ì´íŠ¸
      const infoContainer = document.querySelector('.bg-yellow-50 .text-sm.text-gray-600');
      if(infoContainer) {
        const start = new Date(selectedCamping.startDate);
        const end = new Date(selectedCamping.endDate);
        const days = Math.ceil((end - start) / (1000*60*60*24)) + 1;
        const daysText = days === 1 ? 'ë‹¹ì¼ì¹˜ê¸°' : `${days-1}ë°•${days}ì¼`;
        
        let html = `<div>${selectedCamping.startDate} ~ ${selectedCamping.endDate}</div>`;
        html += `<div>ğŸ—“ï¸ ${daysText}</div>`;
        if(selectedCamping.address) {
          html += `<div>${escapeHtml(selectedCamping.address)}</div>`;
        }
        if(selectedCamping.website) {
          html += `<div>ğŸ”— <a href="${escapeHtml(selectedCamping.website)}" target="_blank" class="text-blue-600 underline">ì›¹ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸°</a></div>`;
        }
        infoContainer.innerHTML = html;
      }
      
      // ë©”ëª¨ ì—…ë°ì´íŠ¸
      updateMemoSection();
      
      // ì¤€ë¹„í•­ëª© ì—…ë°ì´íŠ¸ (ì°¸ì—¬ì ë³€ê²½ ë°˜ì˜)
      updatePrepItemsSection();
    }

    /* ë©”ëª¨ ì„¹ì…˜ ì—…ë°ì´íŠ¸ */
    function updateMemoSection(){
      const existingMemo = document.querySelector('.bg-gray-50.rounded-lg.p-4');
      
      if(selectedCamping.info) {
        const memoHtml = `<div class="text-sm font-medium mb-2">ğŸ“ ì•ˆë‚´ ë° ë©”ëª¨</div><div class="text-sm whitespace-pre-wrap">${escapeHtml(selectedCamping.info)}</div>`;
        
        if(existingMemo && existingMemo.querySelector('.text-sm.font-medium')?.textContent.includes('ì•ˆë‚´ ë° ë©”ëª¨')) {
          existingMemo.innerHTML = memoHtml;
        } else {
          // ë©”ëª¨ ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ì¶”ê°€
          const yellowSection = document.querySelector('.bg-yellow-50');
          if(yellowSection && !existingMemo) {
            const newMemo = document.createElement('div');
            newMemo.className = 'bg-gray-50 rounded-lg p-4';
            newMemo.innerHTML = memoHtml;
            yellowSection.insertAdjacentElement('afterend', newMemo);
          }
        }
      } else {
        // ë©”ëª¨ê°€ ì—†ìœ¼ë©´ ì„¹ì…˜ ì œê±°
        if(existingMemo && existingMemo.querySelector('.text-sm.font-medium')?.textContent.includes('ì•ˆë‚´ ë° ë©”ëª¨')) {
          existingMemo.remove();
        }
      }
    }

    /* ì¤€ë¹„í•­ëª© ì„¹ì…˜ ì—…ë°ì´íŠ¸ (ì°¸ì—¬ì ë³€ê²½ ë°˜ì˜) */
    function updatePrepItemsSection(){
      const prepSection = Array.from(document.querySelectorAll('.bg-gray-50.rounded-lg.p-4'))
        .find(el => el.querySelector('.text-sm.font-medium')?.textContent.includes('ì¤€ë¹„í•­ëª©'));
      
      if(!prepSection) return;
      
      // ì¤€ë¹„í•­ëª© ì¬ìƒì„±
      let prepItemsHtml = '<div class="text-sm font-medium mb-4">ğŸ“¦ ì¤€ë¹„í•­ëª©</div>';
      
      if(selectedCamping.participants && selectedCamping.participants.length > 0) {
        prepItemsHtml += '<div class="space-y-3">';
        
        selectedCamping.participants.forEach(userId => {
          const u = allUsers.find(x => x.id === userId);
          if(!u) return;
          
          const color = colorPalette[u.colorIndex];
          const userPrepItem = prepItems.find(p => p.campingId === selectedCamping.id && p.userId === userId);
          const isMySection = userId === currentUser.id;
          
          prepItemsHtml += `<div class="bg-white rounded-lg p-3 border" style="border-color: ${color}33;">`;
          prepItemsHtml += '<div class="flex justify-between items-center mb-2">';
          prepItemsHtml += `<div class="font-medium text-sm" style="color: ${color}">${escapeHtml(u.name)}</div>`;
          
          if(isMySection) {
            prepItemsHtml += `<button onclick="openPrepItemModal('${selectedCamping.id}', '${userId}')" class="text-xs text-green-600 font-medium">âœï¸ ì‘ì„±</button>`;
          }
          
          prepItemsHtml += '</div>';
          
          if(userPrepItem && userPrepItem.content) {
            prepItemsHtml += `<div class="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 p-2 rounded">${escapeHtml(userPrepItem.content)}</div>`;
          } else {
            prepItemsHtml += `<div class="text-xs text-gray-400 italic">ì•„ì§ ì¤€ë¹„í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
          }
          
          prepItemsHtml += '</div>';
        });
        
        prepItemsHtml += '</div>';
      } else {
        prepItemsHtml += '<div class="text-xs text-gray-500 text-center py-4">ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      }
      
      prepSection.innerHTML = prepItemsHtml;
    }

    /* ì°¸ì—¬ì ëª©ë¡ DOM ì—…ë°ì´íŠ¸ */
    function updateParticipantListDOM(){
      // ì´ í•¨ìˆ˜ëŠ” ì¤€ë¹„í•­ëª© ì„¹ì…˜ì—ì„œ ì°¸ì—¬ìë¥¼ í‘œì‹œí•˜ë¯€ë¡œ updatePrepItemsSectionìœ¼ë¡œ ëŒ€ì²´
      updatePrepItemsSection();
    }

    /* ì¼ì • ì‚­ì œ */
    window.deleteCamping = function(campingId, createdBy){
      if(currentUser.id !== createdBy){ customAlert('ë³¸ì¸ì´ ë“±ë¡í•œ ì¼ì •ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
      
      customConfirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(){
        db.collection('prepItems').where('campingId','==',campingId).get().then(snap=>{
          const batch = db.batch();
          snap.forEach(doc=>{ batch.delete(doc.ref); });
          return batch.commit();
        }).then(()=>{
          return db.collection('campings').doc(campingId).delete();
        }).then(()=>{
          customAlert('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeCampingModal();
          closeCampingDetail();
        }).catch(e=>{ customAlert('ì˜¤ë¥˜: '+e); });
      });
    };

    /* ì¼ì • ìƒì„¸ */
    window.openCampingDetail = function(campingId){
      const c = campings.find(x=>x.id===campingId);
      if(!c) return;
      selectedCamping = c;
      showCampingDetail = true;
      render();
    };

    window.closeCampingDetail = function(){
      showCampingDetail = false;
      selectedCamping = null;
      render();
    };

    /* ì¹´ì¹´ì˜¤í†¡ ê³µìœ í•˜ê¸° */
    window.shareToKakao = function(campingId) {
      const camping = campings.find(c => c.id === campingId);
      if(!camping) {
        customAlert('ì¼ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if(!window.Kakao || !Kakao.isInitialized()) {
        customAlert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }

      const days = getDaysDiffInclusive(camping.startDate, camping.endDate);
      const daysText = days === 1 ? 'ë‹¹ì¼ì¹˜ê¸°' : `${days-1}ë°•${days}ì¼`;
      
      // ì°¸ì—¬ì ëª©ë¡
      let participantsText = '';
      if(camping.participants && camping.participants.length > 0) {
        const participantNames = camping.participants
          .map(userId => {
            const user = allUsers.find(u => u.id === userId);
            return user ? user.name : '';
          })
          .filter(name => name)
          .join(', ');
        participantsText = participantNames ? `\nğŸ‘¥ ì°¸ì—¬ì: ${participantNames}` : '';
      }

      const description = `${camping.startDate} ~ ${camping.endDate} (${daysText})${camping.address ? '\n' + camping.address : ''}${participantsText}`;

      try {
        Kakao.Share.sendDefault({
          objectType: 'feed',
          content: {
            title: `ğŸ•ï¸ ${camping.name}`,
            description: description,
            imageUrl: 'https://mud-kage.kakao.com/dn/NTmhS/btqfEUdFAUf/FjKzkZsnoeE4o19klTOVI1/openlink_640x640s.jpg',
            link: {
              mobileWebUrl: window.location.href,
              webUrl: window.location.href,
            },
          },
          buttons: [
            {
              title: 'ì¼ì • ë³´ê¸°',
              link: {
                mobileWebUrl: window.location.href,
                webUrl: window.location.href,
              },
            },
          ],
        });
      } catch(e) {
        console.error('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì˜¤ë¥˜:', e);
        customAlert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    };

    /* ìŠ¤ì¼€ì¤„ ë“±ë¡ */
    window.openScheduleModal = function(campingId, dateStr){
      showModal=true;
      const c = campings.find(x=>x.id===campingId);
      render();
      requestAnimationFrame(()=>{
        if(c) document.getElementById('modalCampingName').value = c.name;
        document.getElementById('modalDate').value = dateStr;
      });
    };

    window.closeModal = function(){ showModal=false; render(); };

    window.saveSchedule = function(){
      const campingName = document.getElementById('modalCampingName').value.trim();
      const date = document.getElementById('modalDate').value;
      const activity = document.getElementById('modalActivity').value.trim();

      if(!campingName || !date || !activity){ customAlert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      const camping = campings.find(c => c.name === campingName);
      if(!camping){ customAlert('ì¼ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

      const data = {
        campingId: camping.id,
        campingName,
        date,
        activity,
        participants: camping.participants || [], // ì¼ì •ì˜ ì°¸ì—¬ì ì •ë³´ ë³µì‚¬
        attendance: {},
        createdBy: currentUser.id,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection('schedules').add(data).then(()=>{
        customAlert('í™œë™ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeModal();
      }).catch(e=>{ customAlert('ì˜¤ë¥˜: '+e); });
    };

    window.deleteSchedule = function(scheduleId, createdBy){
      if(currentUser.id !== createdBy){ customAlert('ë³¸ì¸ì´ ë“±ë¡í•œ í™œë™ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
      
      customConfirm('ì´ í™œë™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(){
        db.collection('schedules').doc(scheduleId).delete().then(()=>{
          customAlert('í™œë™ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          render();
        }).catch(e=>{ customAlert('ì˜¤ë¥˜: '+e); });
      });
    };

    /* ì°¸ì—¬ì—¬ë¶€ (ì¼ì •) */
    window.updateCampingAttendance = function(campingId, status){
      const userId = currentUser.id;
      const updKey = `attendance.${userId}`;
      db.collection('campings').doc(campingId).update({
        [updKey]: status
      }).then(()=>{
        render();
      }).catch(e=>{ customAlert('ì˜¤ë¥˜: '+e); });
    };

    /* ì°¸ì—¬ì—¬ë¶€ (í™œë™) */
    window.updateAttendance = function(scheduleId, status){
      const userId = currentUser.id;
      const updKey = `attendance.${userId}`;
      db.collection('schedules').doc(scheduleId).update({
        [updKey]: status
      }).then(()=>{
        render();
      }).catch(e=>{ customAlert('ì˜¤ë¥˜: '+e); });
    };

    /* ì¤€ë¹„í•­ëª© ë“±ë¡/ìˆ˜ì • */
    let editingPrepItemUserId = null;

    window.openPrepItemModal = function(campingId, userId){
      editingPrepItemUserId = userId;
      showPrepItemModal = true;
      render();
    };

    window.closePrepItemModal = function(){
      showPrepItemModal = false;
      editingPrepItemUserId = null;
      render();
    };

    window.savePrepItem = function(campingId){
      const content = document.getElementById('prepItemContent').value.trim();
      
      if(!content){ 
        customAlert('ì¤€ë¹„í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); 
        return; 
      }

      // í•´ë‹¹ ì‚¬ìš©ìì˜ ê¸°ì¡´ ì¤€ë¹„í•­ëª© ì°¾ê¸°
      db.collection('prepItems')
        .where('campingId', '==', campingId)
        .where('userId', '==', editingPrepItemUserId)
        .get()
        .then(snapshot => {
          if(snapshot.empty) {
            // ìƒˆë¡œ ë“±ë¡
            const data = {
              campingId,
              userId: editingPrepItemUserId,
              content,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            return db.collection('prepItems').add(data);
          } else {
            // ìˆ˜ì •
            const doc = snapshot.docs[0];
            return db.collection('prepItems').doc(doc.id).update({
              content,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        })
        .then(() => {
          customAlert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closePrepItemModal();
        })
        .catch(e => { 
          customAlert('ì˜¤ë¥˜: ' + e); 
        });
    };

    /* ì¤€ë¹„í•­ëª© ì‚­ì œ */
    window.deletePrepItem = function(campingId, userId){
      if(currentUser.id !== userId){ 
        customAlert('ë³¸ì¸ì˜ ì¤€ë¹„í•­ëª©ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); 
        return; 
      }
      
      customConfirm('ì¤€ë¹„í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(){
        db.collection('prepItems')
          .where('campingId', '==', campingId)
          .where('userId', '==', userId)
          .get()
          .then(snapshot => {
            if(!snapshot.empty) {
              return db.collection('prepItems').doc(snapshot.docs[0].id).delete();
            }
          })
          .then(() => {
            customAlert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            render();
          })
          .catch(e => { 
            customAlert('ì˜¤ë¥˜: ' + e); 
          });
      });
    };

    /* ===== ì •ì‚° ê´€ë ¨ í•¨ìˆ˜ ===== */
    window.openExpenseModal = function(){
      showExpenseModal = true;
      render();
    };

    window.closeExpenseModal = function(){
      showExpenseModal = false;
      render();
    };

    // í•­ëª© ì¶”ê°€
    window.addExpenseItem = function(userId){
      if(!selectedCamping) return;
      const campingId = selectedCamping.id;
      const userExpenses = expenses.filter(e => e.campingId === campingId && e.userId === userId);
      
      const newItem = {
        campingId,
        userId,
        description: '',
        amount: 0,
        order: userExpenses.length,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      db.collection('expenses').add(newItem)
        .catch(e=>{customAlert('í•­ëª© ì¶”ê°€ ì‹¤íŒ¨');console.error(e);});
    };

    // í•­ëª© ìˆ˜ì • (render ì œê±° - Firebase ì‹¤ì‹œê°„ ë™ê¸°í™”ë¡œ ìë™ ì—…ë°ì´íŠ¸)
    window.updateExpenseItem = function(expenseId, field, value){
      const update = {};
      update[field] = value;
      update.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
      
      db.collection('expenses').doc(expenseId).update(update)
        .catch(e=>{console.error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', e);});
    };

    // ê¸ˆì•¡ ì…ë ¥ ì‹œ ì²œë‹¨ìœ„ ì½¤ë§ˆ í¬ë§·íŒ…
    window.formatAmountInput = function(input, expenseId){
      let value = input.value.replace(/,/g, ''); // ê¸°ì¡´ ì½¤ë§ˆ ì œê±°
      if(value === '') {
        updateExpenseItem(expenseId, 'amount', 0);
        return;
      }
      
      const numValue = parseInt(value) || 0;
      input.value = numValue.toLocaleString(); // ì²œë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
      updateExpenseItem(expenseId, 'amount', numValue);
    };

    // í•­ëª© ì‚­ì œ
    window.deleteExpenseItem = function(expenseId){
      customConfirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(){
        db.collection('expenses').doc(expenseId).delete()
          .catch(e=>{customAlert('ì‚­ì œ ì‹¤íŒ¨');console.error(e);});
      });
    };

    /* ë Œë”ë§ */
    function render(){
      const app = document.getElementById('app');

      // ë¡œë”© í™”ë©´
      if(isLoading){
        app.innerHTML = `
          <div class="loading-screen">
            <div class="text-6xl mb-4 animate-bounce">ğŸ•ï¸</div>
            <div class="text-white text-2xl font-bold">ê°™ì´ ë†€ëŸ¬ê°€ì</div>
            <div class="text-white/80 text-sm mt-2">ë¡œë”© ì¤‘...</div>
          </div>`;
        return;
      }

      // ë¡œê·¸ì¸ ì „
      if(!currentUser){
        app.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-green-400 to-blue-500 flex flex-col items-center justify-center p-4">
            <div class="text-center mb-8">
              <div class="text-7xl mb-4 animate-bounce">ğŸ•ï¸</div>
              <h1 class="text-4xl font-bold text-white mb-2">ê°™ì´ ë†€ëŸ¬ê°€ì</h1>
              <p class="text-white/90 text-sm">íŒ€ì›ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì¼ì • ê´€ë¦¬</p>
            </div>
            <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-2xl">
              <button onclick="openLoginModal()" class="w-full py-4 bg-green-600 text-white rounded-xl text-lg font-bold mb-3 active:bg-green-700">ë¡œê·¸ì¸</button>
              <button onclick="openSignUpModal()" class="w-full py-4 border-2 border-green-600 text-green-600 rounded-xl text-lg font-bold active:bg-green-50">íšŒì›ê°€ì…</button>
            </div>
          </div>
          ${showLoginModal ? renderLoginModal() : ''}`;
        return;
      }

      // ìº˜ë¦°ë” ë Œë”ë§
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const firstDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      // ì´ì „/ë‹¤ìŒ ë‹¬ ë‚ ì§œ ê³„ì‚°
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      const totalCells = Math.ceil((firstDayOfWeek + daysInMonth) / 7) * 7;

      let calendarDays = [];
      
      // ì´ì „ ë‹¬ ë‚ ì§œ
      for(let i = firstDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const date = new Date(year, month - 1, day);
        calendarDays.push({
          day,
          date: formatDate(date),
          isOtherMonth: true
        });
      }

      // í˜„ì¬ ë‹¬ ë‚ ì§œ
      for(let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        calendarDays.push({
          day,
          date: formatDate(date),
          isOtherMonth: false
        });
      }

      // ë‹¤ìŒ ë‹¬ ë‚ ì§œ
      const remainingCells = totalCells - calendarDays.length;
      for(let day = 1; day <= remainingCells; day++) {
        const date = new Date(year, month + 1, day);
        calendarDays.push({
          day,
          date: formatDate(date),
          isOtherMonth: true
        });
      }

      // ìº˜ë¦°ë” HTML ìƒì„±
      let calendarHtml = '<div class="calendar-grid">';
      
      // ìš”ì¼ í—¤ë”
      const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      weekdays.forEach((wd, idx) => {
        let className = 'calendar-weekday';
        if(idx === 0) className += ' sunday';
        if(idx === 6) className += ' saturday';
        calendarHtml += `<div class="${className}">${wd}</div>`;
      });

      // ë‚ ì§œ ì…€
      const today = formatDate(new Date());
      calendarDays.forEach((dayInfo, idx) => {
        const dayOfWeek = idx % 7;
        let className = 'calendar-day';
        
        if(dayInfo.isOtherMonth) {
          className += ' other-month';
        }
        
        if(dayInfo.date === today) {
          className += ' today';
        }
        
        if(selectedDate === dayInfo.date) {
          className += ' selected';
        }

        // í˜„ì¬ ì‚¬ìš©ìê°€ ì°¸ì—¬í•˜ëŠ” ì¼ì •ì´ ìˆëŠ”ì§€ í™•ì¸
        const hasSchedule = campings.some(c => {
          const isInDateRange = dayInfo.date >= c.startDate && dayInfo.date <= c.endDate;
          const isParticipant = c.participants && c.participants.includes(currentUser.id);
          return isInDateRange && isParticipant;
        });

        if(hasSchedule) {
          className += ' has-schedule';
        }

        // ê³µíœ´ì¼ í™•ì¸
        const holiday = holidays[dayInfo.date];
        const isHoliday = holiday && !dayInfo.isOtherMonth;
        
        if(isHoliday) {
          className += ' is-holiday';
        }

        let textColor = '';
        if(dayOfWeek === 0 && !dayInfo.isOtherMonth) textColor = 'text-red-500';
        if(dayOfWeek === 6 && !dayInfo.isOtherMonth) textColor = 'text-blue-500';
        if(isHoliday) textColor = 'text-red-500'; // ê³µíœ´ì¼ë„ ë¹¨ê°„ìƒ‰

        calendarHtml += `
          <div class="${className}" onclick="selectDate('${dayInfo.date}')">
            <div class="text-sm font-semibold ${textColor}">${dayInfo.day}</div>
          </div>`;
      });

      calendarHtml += '</div>';

      // ì„ íƒëœ ë‚ ì§œì˜ ì¼ì • í‘œì‹œ
      let scheduleListHtml = '';
      
      if(selectedDate) {
        // ê³µíœ´ì¼ í™•ì¸
        const selectedHoliday = holidays[selectedDate];
        let holidayHtml = '';
        
        if(selectedHoliday) {
          holidayHtml = `
            <div class="bg-red-50 rounded-xl p-4 mb-3 border-2 border-red-200">
              <div class="flex items-center gap-2">
                <div class="text-2xl">ğŸ‰</div>
                <div>
                  <div class="font-bold text-red-600">${escapeHtml(selectedHoliday)}</div>
                  <div class="text-xs text-red-500">ëŒ€í•œë¯¼êµ­ ê³µíœ´ì¼</div>
                </div>
              </div>
            </div>`;
        }
        
        // í•´ë‹¹ ë‚ ì§œì˜ ì¼ì • ì°¾ê¸° (ì‚¬ìš©ìê°€ ì°¸ì—¬í•˜ëŠ” ì¼ì •ë§Œ)
        const dateCampings = campings.filter(c => {
          const isInDateRange = selectedDate >= c.startDate && selectedDate <= c.endDate;
          const isParticipant = c.participants && c.participants.includes(currentUser.id);
          return isInDateRange && isParticipant;
        });

        const dateSchedules = schedules.filter(s => {
          const matchDate = s.date === selectedDate;
          const isParticipant = s.participants && s.participants.includes(currentUser.id);
          return matchDate && isParticipant;
        });

        if(dateCampings.length === 0 && dateSchedules.length === 0) {
          // ì¼ì •ì´ ì—†ëŠ” ê²½ìš°
          scheduleListHtml = holidayHtml + `
            <div class="bg-white rounded-xl p-6 text-center">
              <div class="text-4xl mb-3">ğŸ“…</div>
              <div class="text-gray-600 mb-4">ì´ ë‚ ì§œì— ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>
              <button onclick="openCampingModal('${selectedDate}')" class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium active:bg-green-700">
                + ì¼ì • ë“±ë¡í•˜ê¸°
              </button>
            </div>`;
        } else {
          // ì¼ì •ì´ ìˆëŠ” ê²½ìš°
          scheduleListHtml = holidayHtml + '<div class="space-y-3">';

          dateCampings.forEach(c => {
            const days = getDaysDiffInclusive(c.startDate, c.endDate);
            const creatorUser = allUsers.find(u => u.id === c.createdBy);
            const creatorName = creatorUser ? creatorUser.name : 'ì•Œ ìˆ˜ ì—†ìŒ';

            let addressHtml = c.address ? `<div>${escapeHtml(c.address)}</div>` : '';
            let websiteHtml = c.website ? `<div>ğŸ”— <a href="${escapeHtml(c.website)}" target="_blank" class="text-blue-600 underline">ì›¹ì‚¬ì´íŠ¸</a></div>` : '';

            // ë‚´ ì°¸ì—¬ ì—¬ë¶€
            const myAttendance = c.attendance && c.attendance[currentUser.id];
            let myAttendanceHtml = `
              <div class="mt-3 pt-3 border-t">
                <div class="text-sm font-medium mb-2">ë‚´ ì°¸ì—¬ ì—¬ë¶€</div>
                <div class="flex gap-2">
                  <button onclick="updateCampingAttendance('${c.id}', 'O')" 
                    class="flex-1 py-2 rounded-lg text-sm font-medium ${myAttendance === 'O' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700'}">
                    ì°¸ì—¬ O
                  </button>
                  <button onclick="updateCampingAttendance('${c.id}', 'X')" 
                    class="flex-1 py-2 rounded-lg text-sm font-medium ${myAttendance === 'X' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-700'}">
                    ë¶ˆì°¸ X
                  </button>
                  <button onclick="updateCampingAttendance('${c.id}', '?')" 
                    class="flex-1 py-2 rounded-lg text-sm font-medium ${myAttendance === '?' ? 'bg-yellow-600 text-white' : 'bg-gray-100 text-gray-700'}">
                    ë¯¸ì • ?
                  </button>
                </div>
              </div>`;

            // ì°¸ì—¬ì ëª©ë¡ ë° ì°¸ì—¬ í˜„í™©
            let participantsHtml = '';
            if(c.participants && c.participants.length > 0) {
              participantsHtml = '<div class="mt-3 pt-3 border-t"><div class="text-sm font-medium mb-2">ì°¸ì—¬ì í˜„í™©</div><div class="flex gap-1 flex-wrap">';
              c.participants.forEach(userId => {
                const u = allUsers.find(x => x.id === userId);
                if(u) {
                  const status = c.attendance && c.attendance[userId] ? c.attendance[userId] : '-';
                  const color = colorPalette[u.colorIndex];
                  participantsHtml += `<div class="px-2 py-1 rounded text-xs font-medium" style="background-color: ${color}33; color: ${color}; border: 1px solid ${color}">${escapeHtml(u.name)} ${status}</div>`;
                }
              });
              participantsHtml += '</div></div>';
            }

            scheduleListHtml += `
              <div class="bg-white rounded-xl p-4 border-2 border-green-200">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1">
                    <div class="font-bold text-lg mb-1">ğŸ•ï¸ ${escapeHtml(c.name)}</div>
                    <div class="text-sm text-gray-600 space-y-1">
                      <div>${c.startDate} ~ ${c.endDate} (${days === 1 ? 'ë‹¹ì¼ì¹˜ê¸°' : days-1+'ë°•'+days+'ì¼'})</div>
                      ${addressHtml}
                      ${websiteHtml}
                      <div class="text-xs text-gray-500">ë“±ë¡: ${creatorName}</div>
                    </div>
                  </div>
                  <button onclick="openCampingDetail('${c.id}')" class="text-sm font-bold text-green-600 whitespace-nowrap">ìƒì„¸ë³´ê¸°</button>
                </div>
                ${myAttendanceHtml}
                ${participantsHtml}
              </div>`;
          });

          // ìŠ¤ì¼€ì¤„ í‘œì‹œ
          dateSchedules.forEach(s => {
            const creator = allUsers.find(u => u.id === s.createdBy);
            const creatorName = creator ? creator.name : 'ì•Œ ìˆ˜ ì—†ìŒ';
            
            // ì°¸ì—¬ì—¬ë¶€ ë²„íŠ¼
            const myAttendance = s.attendance && s.attendance[currentUser.id];
            let attendanceHtml = `
              <div class="flex gap-2 mt-3">
                <button onclick="updateAttendance('${s.id}', 'O')" 
                  class="flex-1 py-2 rounded-lg text-sm font-medium ${myAttendance === 'O' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700'}">
                  ì°¸ì—¬ O
                </button>
                <button onclick="updateAttendance('${s.id}', 'X')" 
                  class="flex-1 py-2 rounded-lg text-sm font-medium ${myAttendance === 'X' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-700'}">
                  ë¶ˆì°¸ X
                </button>
                <button onclick="updateAttendance('${s.id}', '?')" 
                  class="flex-1 py-2 rounded-lg text-sm font-medium ${myAttendance === '?' ? 'bg-yellow-600 text-white' : 'bg-gray-100 text-gray-700'}">
                  ë¯¸ì • ?
                </button>
              </div>`;

            // ì°¸ì—¬ í˜„í™©
            let attendanceStatus = '<div class="flex gap-1 flex-wrap mt-2">';
            if(s.participants && s.participants.length > 0) {
              s.participants.forEach(userId => {
                const u = allUsers.find(x => x.id === userId);
                if(u) {
                  const status = s.attendance && s.attendance[userId] ? s.attendance[userId] : '';
                  const color = colorPalette[u.colorIndex];
                  attendanceStatus += `<div class="px-2 py-1 rounded text-xs" style="background-color: ${color}33; color: ${color}; border: 1px solid ${color}">${escapeHtml(u.name)} ${status}</div>`;
                }
              });
            }
            attendanceStatus += '</div>';

            const deleteBtn = s.createdBy === currentUser.id 
              ? `<button onclick="deleteSchedule('${s.id}', '${s.createdBy}')" class="text-red-500 text-sm">ì‚­ì œ</button>`
              : '';

            scheduleListHtml += `
              <div class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1">
                    <div class="font-bold mb-1">${escapeHtml(s.activity)}</div>
                    <div class="text-xs text-gray-600">ë“±ë¡: ${creatorName}</div>
                  </div>
                  ${deleteBtn}
                </div>
                ${attendanceHtml}
                ${attendanceStatus}
              </div>`;
          });

          scheduleListHtml += '</div>';
        }
      }

      // ì „ì²´ ì¼ì • ë³´ê¸° íŒì—…
      let allSchedulesHtml = '';
      if(showAllSchedules) {
        const todayDate = formatDate(new Date());
        const futureCampings = campings.filter(c => {
          const isFuture = c.endDate >= todayDate;
          const isParticipant = c.participants && c.participants.includes(currentUser.id);
          return isFuture && isParticipant;
        }).sort((a, b) => a.startDate.localeCompare(b.startDate));

        let futureListHtml = '';
        if(futureCampings.length === 0) {
          futureListHtml = '<div class="text-center text-gray-500 py-8">ë“±ë¡ëœ ë¯¸ë˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        } else {
          futureCampings.forEach(c => {
            const days = getDaysDiffInclusive(c.startDate, c.endDate);
            const creator = allUsers.find(u => u.id === c.createdBy);
            const creatorName = creator ? creator.name : 'ì•Œ ìˆ˜ ì—†ìŒ';

            futureListHtml += `
              <div class="bg-white rounded-lg p-4 border mb-3 cursor-pointer active:bg-gray-50" onclick="openDetailFromList('${c.id}')">
                <div class="font-bold mb-1">ğŸ•ï¸ ${escapeHtml(c.name)}</div>
                <div class="text-sm text-gray-600 space-y-1">
                  <div>${c.startDate} ~ ${c.endDate} (${days === 1 ? 'ë‹¹ì¼ì¹˜ê¸°' : days-1+'ë°•'+days+'ì¼'})</div>
                  ${c.address ? `<div>${escapeHtml(c.address)}</div>` : ''}
                  <div class="text-xs text-gray-500">ë“±ë¡: ${creatorName}</div>
                </div>
              </div>`;
          });
        }

        allSchedulesHtml = `
          <div class="fixed inset-0 bg-black/50 z-40 flex items-end" onclick="if(event.target===this)toggleAllSchedules()">
            <div class="bg-white w-full rounded-t-3xl p-5 max-h-[80vh] overflow-y-auto animate-slide-up">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ë“±ë¡ëœ ì¼ì •</h3>
                <button onclick="toggleAllSchedules()" class="text-3xl text-gray-500">Ã—</button>
              </div>
              <div>${futureListHtml}</div>
            </div>
          </div>`;
      }

      // ìŠ¤ì¼€ì¤„ ëª¨ë‹¬
      let modalHtml = '';
      if(showModal){
        modalHtml = `
          <div class="fixed inset-0 bg-black/50 z-40 flex items-end" onclick="if(event.target===this)closeModal()">
            <div class="bg-white w-full rounded-t-3xl p-5 max-h-[90vh] overflow-y-auto animate-slide-up">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">í™œë™ ë“±ë¡</h3>
                <button onclick="closeModal()" class="text-3xl text-gray-500">Ã—</button>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm mb-1 font-medium">ë†€ëŸ¬ê°€ëŠ” ê³³</label>
                  <input type="text" id="modalCampingName" readonly class="w-full px-4 py-3 border rounded-lg bg-gray-100">
                </div>
                <div>
                  <label class="block text-sm mb-1 font-medium">ë‚ ì§œ</label>
                  <input type="date" id="modalDate" readonly class="w-full px-4 py-3 border rounded-lg bg-gray-100">
                </div>
                <div>
                  <label class="block text-sm mb-1 font-medium">í™œë™ ë‚´ìš© *</label>
                  <input type="text" id="modalActivity" placeholder="ì˜ˆ: ì•„ì¹¨ ì‚°ì±…, ì €ë… ë°”ë¹„í" class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div class="flex gap-2 pt-2">
                  <button onclick="closeModal()" class="flex-1 py-3 border rounded-lg font-medium">ì·¨ì†Œ</button>
                  <button onclick="saveSchedule()" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium">ë“±ë¡</button>
                </div>
              </div>
            </div>
          </div>`;
      }

      // ì¼ì • ìƒì„¸ ëª¨ë‹¬
      let campingDetailHtml = '';
      if(showCampingDetail && selectedCamping){
        const days = getDaysDiffInclusive(selectedCamping.startDate, selectedCamping.endDate);
        const daysHtml = days === 1 ? '<div>ğŸ—“ï¸ ë‹¹ì¼ì¹˜ê¸°</div>' : `<div>ğŸ—“ï¸ ${days-1}ë°•${days}ì¼</div>`;
        const addressHtml = selectedCamping.address ? `<div>${escapeHtml(selectedCamping.address)}</div>` : '';
        const websiteHtml = selectedCamping.website ? `<div>ğŸ”— <a href="${escapeHtml(selectedCamping.website)}" target="_blank" class="text-blue-600 underline">ì›¹ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸°</a></div>` : '';
        const infoHtml = selectedCamping.info ? `<div class="bg-gray-50 rounded-lg p-4"><div class="text-sm font-medium mb-2">ğŸ“ ì•ˆë‚´ ë° ë©”ëª¨</div><div class="text-sm whitespace-pre-wrap">${escapeHtml(selectedCamping.info)}</div></div>` : '';
        
        const editButtonHtml = (selectedCamping.createdBy === currentUser.id)
          ? `<button onclick="editCampingModal('${selectedCamping.id}')" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium">ìˆ˜ì •</button>`
          : '';

        // ì¤€ë¹„í•­ëª© (íŒ€ë³„)
        let prepItemsHtml = '<div class="bg-gray-50 rounded-lg p-4">';
        prepItemsHtml += '<div class="text-sm font-medium mb-4">ğŸ“¦ ì¤€ë¹„í•­ëª©</div>';

        if(selectedCamping.participants && selectedCamping.participants.length > 0) {
          prepItemsHtml += '<div class="space-y-3">';
          
          selectedCamping.participants.forEach(userId => {
            const u = allUsers.find(x => x.id === userId);
            if(!u) return;
            
            const color = colorPalette[u.colorIndex];
            const userPrepItem = prepItems.find(p => p.campingId === selectedCamping.id && p.userId === userId);
            const isMySection = userId === currentUser.id;
            
            prepItemsHtml += `<div class="bg-white rounded-lg p-3 border" style="border-color: ${color}33;">`;
            
            // í—¤ë”
            prepItemsHtml += '<div class="flex justify-between items-center mb-2">';
            prepItemsHtml += `<div class="font-medium text-sm" style="color: ${color}">${escapeHtml(u.name)}</div>`;
            
            if(isMySection) {
              prepItemsHtml += `<button onclick="openPrepItemModal('${selectedCamping.id}', '${userId}')" class="text-xs text-green-600 font-medium">âœï¸ ì‘ì„±</button>`;
            }
            
            prepItemsHtml += '</div>';
            
            // ë‚´ìš©
            if(userPrepItem && userPrepItem.content) {
              prepItemsHtml += `<div class="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 p-2 rounded">${escapeHtml(userPrepItem.content)}</div>`;
            } else {
              prepItemsHtml += `<div class="text-xs text-gray-400 italic">ì•„ì§ ì¤€ë¹„í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
            }
            
            prepItemsHtml += '</div>';
          });
          
          prepItemsHtml += '</div>';
        } else {
          prepItemsHtml += '<div class="text-xs text-gray-500 text-center py-4">ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        }
        
        prepItemsHtml += '</div>';

        campingDetailHtml = `
          <div class="fixed inset-0 bg-black/50 z-40 flex items-end" onclick="if(event.target===this)closeCampingDetail()">
            <div class="bg-white w-full rounded-t-3xl p-5 max-h-[90vh] overflow-y-auto animate-slide-up">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ğŸ•ï¸ ë†€ëŸ¬ê°ˆê³³ ì •ë³´</h3>
                <button onclick="closeCampingDetail()" class="text-3xl text-gray-500">Ã—</button>
              </div>
              <div class="space-y-4">
                <div class="bg-yellow-50 rounded-lg p-4">
                  <h4 class="font-bold text-lg mb-2">${escapeHtml(selectedCamping.name)}</h4>
                  <div class="text-sm text-gray-600 space-y-1">
                    <div>${selectedCamping.startDate} ~ ${selectedCamping.endDate}</div>
                    ${daysHtml}
                    ${addressHtml}
                    ${websiteHtml}
                  </div>
                </div>
                ${infoHtml}
                ${prepItemsHtml}
                
                <div class="bg-white rounded-lg p-4 border-2 border-blue-200">
                  <button onclick="openExpenseModal()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold text-lg active:bg-blue-700 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    ì •ì‚°í•˜ê¸°
                  </button>
                </div>
                
                <div class="space-y-2">
                  <button onclick="shareToKakao('${selectedCamping.id}')" class="w-full py-3 bg-yellow-400 hover:bg-yellow-500 text-gray-800 rounded-lg font-medium flex items-center justify-center gap-2 active:bg-yellow-600">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 3C6.48 3 2 6.58 2 11c0 2.89 1.97 5.43 4.93 6.91-.21.78-.78 2.84-.9 3.31-.15.58.21.57.43.42.17-.12 2.54-1.77 3.51-2.45.66.09 1.34.14 2.03.14 5.52 0 10-3.58 10-8S17.52 3 12 3z"/>
                    </svg>
                    ì¹´ì¹´ì˜¤í†¡ ê³µìœ í•˜ê¸°
                  </button>
                  <div class="flex gap-2">
                    ${editButtonHtml}
                    <button onclick="closeCampingDetail()" class="flex-1 py-3 border border-gray-300 rounded-lg font-medium">ë‹«ê¸°</button>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
      }

      // í—¤ë” + ìº˜ë¦°ë” + ì¼ì • ë¦¬ìŠ¤íŠ¸
      const myColor = colorPalette[currentUser.colorIndex];
      app.innerHTML = `
        <div class="min-h-screen pb-20">
          <div class="app-header bg-green-600 text-white shadow-lg">
            <div class="p-4">
              <div class="flex items-center justify-between mb-3">
                <div><h1 class="text-2xl font-bold">ğŸ•ï¸ ê°™ì´ ë†€ëŸ¬ê°€ì</h1></div>
                <button onclick="logout()" class="text-xs bg-white/20 px-3 py-1 rounded-full">ë¡œê·¸ì•„ì›ƒ</button>
              </div>
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                  <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded text-xl hover:bg-white/30 active:bg-white/40">â†</button>
                  <h2 class="text-lg font-bold min-w-[100px] text-center">${getMonthYear()}</h2>
                  <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded text-xl hover:bg-white/30 active:bg-white/40">â†’</button>
                </div>
                <button onclick="goToToday()" class="px-3 py-1.5 bg-white text-green-700 rounded-lg text-sm font-semibold shadow-sm active:opacity-80">Today</button>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="w-3 h-3 rounded-full" style="background-color:${myColor}"></div>
                  <span class="text-sm">${escapeHtml(currentUser.name)}</span>
                </div>
                <button onclick="toggleAllSchedules()" class="px-3 py-1.5 bg-white/20 rounded-lg text-xs font-medium active:bg-white/30">
                  ì¼ì •ë³´ê¸°
                </button>
              </div>
            </div>
          </div>
          
          <div class="p-3 sm:p-4">
            <div class="bg-white rounded-xl p-3 sm:p-4 shadow-sm mb-4">
              ${calendarHtml}
            </div>
            
            ${selectedDate ? `
              <div class="mb-3">
                <h3 class="text-lg font-bold mb-2">${selectedDate}</h3>
              </div>
              ${scheduleListHtml}
            ` : `
              <div class="bg-white rounded-xl p-6 text-center">
                <div class="text-4xl mb-3">ğŸ“…</div>
                <div class="text-gray-600">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ì¼ì •ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
              </div>
            `}
          </div>
          
          ${modalHtml}
          ${campingDetailHtml}
          ${showCampingModal ? renderCampingModal() : ''}
          ${showPrepItemModal ? renderPrepItemModal() : ''}
          ${showParticipantModal ? renderParticipantModal() : ''}
          ${showExpenseModal ? renderExpenseModal() : ''}
          ${allSchedulesHtml}
        </div>`;
      if(showCampingModal){
        initDatePickers();
      }
    }

    
    // ë‚ ì§œ ì„ íƒìš© flatpickr ì´ˆê¸°í™”
    function initDatePickers(){
      try{
        if(typeof flatpickr === 'undefined') return;
      }catch(e){
        return;
      }
      const startEl = document.getElementById('campingStartDate');
      const endEl = document.getElementById('campingEndDate');
      if(!startEl) return;

      // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆë‹¤ë©´ ë‹¤ì‹œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ
      if(startEl._flatpickr){
        return;
      }

      let defaultDates = [];
      if(editingCamping && editingCamping.startDate && editingCamping.endDate){
        defaultDates = [editingCamping.startDate, editingCamping.endDate];
      }

      flatpickr(startEl, {
        mode: "range",
        dateFormat: "Y-m-d",
        defaultDate: defaultDates,
        onReady: function(selectedDates, dateStr, instance){
          // ëª¨ë‹¬ì´ ì²˜ìŒ ì—´ë¦´ ë•Œë„ ì‹œì‘ì¼ ì¸í’‹ì—ëŠ” í•­ìƒ ì‹œì‘ì¼ë§Œ ë³´ì´ë„ë¡ ì •ë¦¬
          if(editingCamping && editingCamping.startDate){
            startEl.value = editingCamping.startDate;
          }
          if(editingCamping && editingCamping.endDate && endEl){
            endEl.value = editingCamping.endDate;
          }
        },
        onChange: function(selectedDates){
          if(selectedDates.length === 0){
            if(endEl) endEl.value = '';
            if(editingCamping){
              editingCamping.startDate = '';
              editingCamping.endDate = '';
            }
          }
          if(selectedDates.length === 2){
            const [start, end] = selectedDates;
            const toStr = d => {
              const y = d.getFullYear();
              const m = String(d.getMonth() + 1).padStart(2, '0');
              const day = String(d.getDate()).padStart(2, '0');
              return `${y}-${m}-${day}`;
            };
            const startStr = toStr(start);
            const endStr = toStr(end);

            if(startEl) startEl.value = startStr;
            if(endEl) endEl.value = endStr;

            if(!editingCamping) editingCamping = {};
            editingCamping.startDate = startStr;
            editingCamping.endDate = endStr;
          }
        }
      });
    }

// ë¡œê·¸ì¸ ëª¨ë‹¬
    function renderLoginModal(){
      return `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-end" onclick="if(event.target===this)closeLoginModal()">
          <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold">${isSignUp ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}</h3>
              <button onclick="closeLoginModal()" class="text-3xl text-gray-500">Ã—</button>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm mb-1 font-medium">íŒ€ ì´ë¦„</label>
                <input type="text" id="authTeamName" placeholder="ì˜ˆ: ì„œí¬ë„¤" class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
              </div>
              <div>
                <label class="block text-sm mb-1 font-medium">íœ´ëŒ€í° ë²ˆí˜¸</label>
                <input type="tel" id="authPhone" placeholder="01012345678" class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
              </div>
              <button onclick="handleAuth()" class="w-full py-4 bg-green-600 text-white rounded-lg text-lg font-bold active:bg-green-700">
                ${isSignUp ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}
              </button>
              <div class="text-center">
                <button onclick="toggleAuthMode()" class="text-sm text-green-600">
                  ${isSignUp ? 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸' : 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…'}
                </button>
              </div>
            </div>
          </div>
        </div>`;
    }

    // ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬
    function renderCampingModal(){
      const editing = editingCamping;
      const isEdit = editing && editing.id;
      const deleteButtonHtml = (isEdit && editing.createdBy===currentUser.id)
        ? `<div class="pt-4 border-t"><button onclick="deleteCamping('${editing.id}', '${editing.createdBy}')" class="w-full py-2 bg-red-100 text-red-700 rounded-lg font-medium">ì¼ì • ì •ë³´ ì‚­ì œ</button></div>`
        : '';

      // ì°¸ì—¬ì ì„ íƒ ë“œë¡­ë‹¤ìš´ HTML
      let participantsOptionsHtml = '';
      allUsers.forEach(user => {
        const isSelected = editing && editing.participants && editing.participants.includes(user.id);
        const color = colorPalette[user.colorIndex];
        const isMe = user.id === currentUser.id ? ' (ë‚˜)' : '';
        participantsOptionsHtml += `<option value="${user.id}" ${isSelected ? 'selected' : ''}>${escapeHtml(user.name)}${isMe}</option>`;
      });
      
      // ì„ íƒëœ ì°¸ì—¬ì í‘œì‹œ
      const selectedParticipants = editing && editing.participants ? editing.participants : [];
      let participantDisplayHtml = '';
      if(selectedParticipants.length > 0) {
        participantDisplayHtml = '<div class="flex flex-wrap gap-2 mb-3">';
        selectedParticipants.forEach(userId => {
          const user = allUsers.find(u => u.id === userId);
          if(user) {
            const color = colorPalette[user.colorIndex];
            const isMe = user.id === currentUser.id ? ' (ë‚˜)' : '';
            participantDisplayHtml += `
              <div class="px-3 py-2 rounded-lg text-sm font-medium" style="background-color: ${color}33; color: ${color}; border: 1px solid ${color}">
                ${escapeHtml(user.name)}${isMe}
              </div>`;
          }
        });
        participantDisplayHtml += '</div>';
      }

      return `
      <div class="fixed inset-0 bg-black/50 z-50 flex items-end" onclick="if(event.target===this)closeCampingModal()">
        <div class="bg-white w-full rounded-t-3xl p-5 max-h-[90vh] overflow-y-auto animate-slide-up">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">ğŸ•ï¸ ì¼ì • ${editing && editing.id ? 'ìˆ˜ì •' : 'ë“±ë¡'}</h3>
            <button onclick="closeCampingModal()" class="text-3xl text-gray-500">Ã—</button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm mb-1 font-medium">ë†€ëŸ¬ê°€ëŠ” ê³³ *</label>
              <input type="text" id="campingName" value="${editing ? escapeHtml(editing.name) : ''}" placeholder="ë³„ë¹›ìº í•‘ì¥" class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
            </div>
            <div class="date-grid">
              <div>
                <label class="block text-sm mb-1 font-medium">ì‹œì‘ì¼ *</label>
                <input type="text" id="campingStartDate" value="${editing ? editing.startDate : (selectedDate || '')}" class="date-input px-4 py-3 border rounded-lg" autocomplete="off">
              </div>
              <div>
                <label class="block text-sm mb-1 font-medium">ì¢…ë£Œì¼ *</label>
                <input type="text" id="campingEndDate" value="${editing ? editing.endDate : (selectedDate || '')}" class="date-input px-4 py-3 border rounded-lg" autocomplete="off">
              </div>
            </div>
            <div class="text-xs text-gray-500 bg-blue-50 p-2 rounded">â€» ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„¤ì •í•˜ë©´ 2ë°•3ì¼, 3ë°•4ì¼ ë“±ì˜ ì¼ì •ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
            
            <div>
              <label class="block text-sm mb-2 font-medium">ì°¸ì—¬ì ì„ íƒ *</label>
              <div class="text-xs text-gray-500 mb-2">í•¨ê»˜ ê°€ëŠ” íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš” (ì„ íƒëœ íŒ€ì›ë§Œ ì´ ì¼ì •ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)</div>
              ${participantDisplayHtml}
              <button type="button" onclick="openParticipantModal()" class="w-full py-3 border-2 border-green-600 text-green-600 rounded-lg font-medium hover:bg-green-50 active:bg-green-100 flex items-center justify-center gap-2">
                ${selectedParticipants.length === 0 ? `
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                  </svg>
                  <span>ì°¸ì—¬ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span>
                ` : `
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                  <span>ì°¸ì—¬ì ë³€ê²½í•˜ê¸°</span>
                `}
              </button>
            </div>
            
            <div>
              <label class="block text-sm mb-1">ì£¼ì†Œ</label>
              <input type="text" id="campingAddress" value="${editing && editing.address ? escapeHtml(editing.address) : ''}" placeholder="ê²½ê¸°ë„ ê°€í‰êµ°..." class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
            </div>
            <div>
              <label class="block text-sm mb-1">ì›¹ì‚¬ì´íŠ¸</label>
              <input type="url" id="campingWebsite" value="${editing && editing.website ? escapeHtml(editing.website) : ''}" placeholder="https://..." class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
            </div>
            <div>
              <label class="block text-sm mb-1">ì•ˆë‚´ ë° ë©”ëª¨</label>
              <textarea id="campingInfo" maxlength="2000" placeholder="ìº í•‘ì¥ íŠ¹ì§•, ì£¼ì˜ì‚¬í•­ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš” (ìµœëŒ€ 2000ì)" class="w-full px-4 py-3 border rounded-lg resize-none" rows="5" autocomplete="off">${editing && editing.info ? escapeHtml(editing.info) : ''}</textarea>
            </div>
            <div class="flex gap-2 pt-2">
              <button onclick="closeCampingModal()" class="flex-1 py-3 border rounded-lg font-medium">ì·¨ì†Œ</button>
              <button onclick="saveCamping()" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium">ì €ì¥</button>
            </div>
            ${deleteButtonHtml}
          </div>
        </div>
      </div>`;
    }

    // ì°¸ì—¬ì ì„ íƒ ëª¨ë‹¬
    function renderParticipantModal(){
      if(!showParticipantModal) return '';
      
      return `
        <div class="fixed inset-0 bg-black/50 z-[60] flex items-end" onclick="if(event.target===this)closeParticipantModal()">
          <div class="bg-white w-full rounded-t-3xl p-5 max-h-[70vh] overflow-y-auto animate-slide-up">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                ì°¸ì—¬ì ì„ íƒ
              </h3>
              <button onclick="closeParticipantModal()" class="text-3xl text-gray-500">Ã—</button>
            </div>
            
            <div class="space-y-2 mb-4">
              ${allUsers.map(user => {
                const isSelected = tempSelectedParticipants.includes(user.id);
                const color = colorPalette[user.colorIndex];
                const isMe = user.id === currentUser.id ? ' (ë‚˜)' : '';
                return `
                  <button 
                    type="button"
                    onclick="toggleParticipant('${user.id}')" 
                    class="w-full p-3 rounded-lg border-2 text-left flex items-center justify-between active:opacity-70 transition-all"
                    style="border-color: ${isSelected ? color : '#e5e7eb'}; background-color: ${isSelected ? color + '1a' : 'white'}">
                    <div class="flex items-center gap-2">
                      <div class="w-5 h-5 rounded border-2 flex items-center justify-center" 
                        style="border-color: ${color}; background-color: ${isSelected ? color : 'white'}">
                        ${isSelected ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>' : ''}
                      </div>
                      <span class="font-medium" style="color: ${color}">${escapeHtml(user.name)}${isMe}</span>
                    </div>
                  </button>`;
              }).join('')}
            </div>
            
            <div class="text-xs text-gray-500 mb-4 text-center">
              ${tempSelectedParticipants.length}ëª… ì„ íƒë¨
            </div>
            
            <div class="flex gap-2">
              <button onclick="closeParticipantModal()" class="flex-1 py-3 border rounded-lg font-medium">ì·¨ì†Œ</button>
              <button onclick="confirmParticipantSelection()" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium active:bg-green-700">í™•ì¸</button>
            </div>
          </div>
        </div>
      `;
    }

    // ì¤€ë¹„í•­ëª© ì‘ì„± ëª¨ë‹¬
    function renderPrepItemModal(){
      if(!selectedCamping || !editingPrepItemUserId) return '';
      
      const user = allUsers.find(u => u.id === editingPrepItemUserId);
      if(!user) return '';
      
      const color = colorPalette[user.colorIndex];
      
      // ê¸°ì¡´ ì¤€ë¹„í•­ëª© ì°¾ê¸°
      const existingItem = prepItems.find(p => p.campingId === selectedCamping.id && p.userId === editingPrepItemUserId);
      const currentContent = existingItem ? existingItem.content : '';
      const charCount = currentContent.length;
      
      return `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-end" onclick="if(event.target===this)closePrepItemModal()">
          <div class="bg-white w-full rounded-t-3xl p-5 max-h-[90vh] overflow-y-auto animate-slide-up">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">ğŸ“¦ ì¤€ë¹„í•­ëª©</h3>
              <button onclick="closePrepItemModal()" class="text-3xl text-gray-500">Ã—</button>
            </div>
            
            <div class="space-y-4">
              <div class="bg-gray-50 rounded-lg p-3">
                <div class="font-medium mb-1" style="color: ${color}">${escapeHtml(user.name)}</div>
                <div class="text-xs text-gray-500">ë‹¤ë¥¸ ì‚¬ëŒë„ ëª¨ë‘ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
              </div>
              
              <div>
                <label class="block text-sm mb-2 font-medium">ì¤€ë¹„í•­ëª© ì…ë ¥</label>
                <div class="text-xs text-gray-500 mb-2">ì¤€ë¹„ë¬¼ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš” (ìµœëŒ€ 2000ì)</div>
                <textarea id="prepItemContent" maxlength="2000" 
                  oninput="updateCharCount(this)" 
                  placeholder="ì˜ˆ:&#10;- í…íŠ¸&#10;- ì¹¨ë‚­&#10;- ë²„ë„ˆ&#10;- ì‹ì¬ë£Œ (ê³ ê¸°, ì•¼ì±„)&#10;- ê·¸ë¦‡, ìˆ˜ì €&#10;- ì†ì „ë“±" 
                  class="w-full px-4 py-3 border rounded-lg resize-none" 
                  rows="10"
                  autocomplete="off">${escapeHtml(currentContent)}</textarea>
                <div class="text-xs text-gray-500 mt-1" id="charCount">${charCount}/2000</div>
              </div>
              
              <div class="flex gap-2">
                ${existingItem ? `<button onclick="deletePrepItem('${selectedCamping.id}', '${editingPrepItemUserId}')" class="px-4 py-3 border border-red-500 text-red-600 rounded-lg font-medium">ì‚­ì œ</button>` : ''}
                <button onclick="closePrepItemModal()" class="flex-1 py-3 border rounded-lg font-medium">ì·¨ì†Œ</button>
                <button onclick="savePrepItem('${selectedCamping.id}')" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium">ì €ì¥</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    /* ì •ì‚° ëª¨ë‹¬ */
    function renderExpenseModal(){
      if(!showExpenseModal || !selectedCamping) return '';
      
      const camping = selectedCamping;
      
      // í•´ë‹¹ ìº í•‘ì˜ ì°¸ì—¬ì ì°¾ê¸° (camping.participants ì‚¬ìš©)
      const participants = (camping.participants || [])
        .map(pid => allUsers.find(u => u.id === pid))
        .filter(u => u);
      
      // ìº í•‘ë³„ ì •ì‚° ë°ì´í„°
      const campingExpenses = expenses.filter(e => e.campingId === camping.id);
      
      // íŒ€ë³„ ì†Œê³„ ë° ì´ê³„ ê³„ì‚°
      let totalAmount = 0;
      const teamTotals = {};
      
      participants.forEach(user => {
        const userExpenses = campingExpenses.filter(e => e.userId === user.id);
        const teamTotal = userExpenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
        teamTotals[user.id] = teamTotal;
        totalAmount += teamTotal;
      });
      
      const perPerson = participants.length > 0 ? Math.floor((totalAmount / participants.length) / 100) * 100 : 0;
      
      return `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-end" onclick="if(event.target===this)closeExpenseModal()">
          <div class="bg-white w-full rounded-t-3xl p-3 sm:p-5 max-h-[85vh] overflow-y-auto animate-slide-up">
            <div class="flex justify-between items-center mb-3 sm:mb-4 sticky top-0 bg-white pb-2 sm:pb-3 border-b">
              <h3 class="text-lg sm:text-xl font-bold flex items-center gap-2">
                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                ì •ì‚°
              </h3>
              <button onclick="closeExpenseModal()" class="text-3xl text-gray-500">Ã—</button>
            </div>
            
            ${participants.length === 0 ? `
              <div class="text-center py-8 text-gray-400">
                <div class="flex justify-center mb-2">
                  <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                  </svg>
                </div>
                <div>ì°¸ì—¬ìë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”</div>
              </div>
            ` : `
            <div class="space-y-4 sm:space-y-6 mb-4 sm:mb-6">
              ${participants.map(user => {
                const color = colorPalette[user.colorIndex];
                const isMe = user.id === currentUser.id;
                const userExpenses = campingExpenses.filter(e => e.userId === user.id);
                const teamTotal = teamTotals[user.id] || 0;
                
                return `
                  <div class="border-2 rounded-xl p-3 sm:p-4" style="border-color: ${color}33" data-user-id="${user.id}">
                    <div class="flex justify-between items-center mb-2 sm:mb-3">
                      <div class="font-bold text-base sm:text-lg" style="color: ${color}">
                        ${escapeHtml(user.name)}${isMe ? ' (ë‚˜)' : ''}
                      </div>
                      ${isMe ? `
                        <button onclick="addExpenseItem('${user.id}')" 
                          class="px-2 sm:px-3 py-1 text-xs sm:text-sm rounded-lg font-medium"
                          style="background-color: ${color}22; color: ${color}">
                          + í•­ëª©ì¶”ê°€
                        </button>
                      ` : ''}
                    </div>
                    
                    <div class="space-y-2 mb-2 sm:mb-3">
                      ${userExpenses.length === 0 ? `
                        <div class="text-center py-4 text-gray-400 text-sm">
                          ${isMe ? 'ì§€ì¶œ í•­ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”' : 'ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤'}
                        </div>
                      ` : userExpenses.map(expense => {
                        const canEdit = isMe;
                        return `
                          <div class="flex items-center gap-1 sm:gap-2" data-expense-id="${expense.id}">
                            <input type="text" 
                              value="${escapeHtml(expense.description || '')}"
                              placeholder="ì§€ì¶œ ë‚´ìš©"
                              ${canEdit ? '' : 'readonly'}
                              ${canEdit ? `oninput="updateExpenseItem('${expense.id}', 'description', this.value)"` : ''}
                              class="flex-1 px-2 sm:px-3 py-2 border rounded-lg text-sm ${canEdit ? '' : 'bg-gray-50'}" 
                              autocomplete="off">
                            <input type="text" 
                              inputmode="numeric"
                              value="${expense.amount && expense.amount > 0 ? expense.amount.toLocaleString() : ''}"
                              placeholder="ê¸ˆì•¡"
                              ${canEdit ? '' : 'readonly'}
                              ${canEdit ? `oninput="formatAmountInput(this, '${expense.id}')"` : ''}
                              class="w-24 sm:w-28 px-2 sm:px-3 py-2 border rounded-lg text-sm text-right ${canEdit ? '' : 'bg-gray-50'}" 
                              autocomplete="off">
                            ${canEdit ? `
                              <button onclick="deleteExpenseItem('${expense.id}')" 
                                class="p-1.5 sm:p-2 text-red-600 hover:bg-red-50 rounded-lg active:bg-red-100 flex-shrink-0">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                              </button>
                            ` : ''}
                          </div>
                        `;
                      }).join('')}
                    </div>
                    
                    <div class="border-t pt-2 flex justify-between items-center font-bold" style="color: ${color}">
                      <span>ì†Œê³„</span>
                      <span class="text-lg">${teamTotal.toLocaleString()}ì›</span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            
            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-3 sm:p-4 space-y-1 sm:space-y-2 sticky bottom-0">
              <div class="flex justify-between items-center text-base sm:text-lg font-bold">
                <span>ì´ í•©ê³„</span>
                <span class="text-xl sm:text-2xl text-green-600">${totalAmount.toLocaleString()}ì›</span>
              </div>
              <div class="flex justify-between items-center text-base sm:text-lg font-bold">
                <span>1/n (${participants.length}ëª…)</span>
                <span class="text-xl sm:text-2xl text-blue-600">${perPerson.toLocaleString()}ì›</span>
              </div>
              <div class="text-xs text-gray-500 text-center pt-1">
                â€» 100ì› ë‹¨ìœ„ ì´í•˜ ì ˆì‚­ í•©ë‹ˆë‹¤.
              </div>
            </div>
            `}
            
            <div class="mt-3 sm:mt-4">
              <button onclick="closeExpenseModal()" 
                class="w-full py-3 bg-gray-500 text-white rounded-lg font-medium active:bg-gray-600">
                ë‹«ê¸°
              </button>
            </div>
          </div>
        </div>
      `;
    }

    /* ê¸€ì ìˆ˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸ */
    window.updateCharCount = function(textarea) {
      const charCount = document.getElementById('charCount');
      if(charCount) {
        charCount.textContent = textarea.value.length + '/2000';
      }
    };

    /* ì‹¤ì‹œê°„ êµ¬ë… & ë¶€íŒ… */
    function init(){
      // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ (ì¤‘ë³µ ë°©ì§€)
      if(unsubscribeSchedules) unsubscribeSchedules();
      if(unsubscribeCampings) unsubscribeCampings();
      if(unsubscribePrepItems) unsubscribePrepItems();
      if(unsubscribeExpenses) unsubscribeExpenses();
      
      unsubscribeSchedules = db.collection('schedules').onSnapshot(snap=>{ 
        schedules=[]; 
        snap.forEach(doc=>{ schedules.push(Object.assign({ id: doc.id }, doc.data())); }); 
        render(); 
      });
      
      unsubscribeCampings = db.collection('campings').onSnapshot(snap=>{ 
        campings=[]; 
        snap.forEach(doc=>{ campings.push(Object.assign({ id: doc.id }, doc.data())); }); 
        render(); 
      });

      unsubscribePrepItems = db.collection('prepItems').onSnapshot(snap=>{ 
        prepItems=[]; 
        snap.forEach(doc=>{ prepItems.push(Object.assign({ id: doc.id }, doc.data())); }); 
        render(); 
      });
      
      unsubscribeExpenses = db.collection('expenses').onSnapshot(snap=>{ 
        expenses=[]; 
        snap.forEach(doc=>{ expenses.push(Object.assign({ id: doc.id }, doc.data())); }); 
        
        // ì •ì‚° ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´
        if(showExpenseModal && selectedCamping) {
          const camping = selectedCamping;
          
          // ë³€ê²½ ë‚´ìš© ì²˜ë¦¬
          snap.docChanges().forEach(change => {
            const data = change.doc.data();
            
            // í˜„ì¬ ìº í•‘ì˜ expenseë§Œ ì²˜ë¦¬
            if(data.campingId === camping.id) {
              console.log('ë³€ê²½ ê°ì§€:', change.type, data);
              
              if(change.type === 'added') {
                // í•­ëª© ì¶”ê°€ - DOMì— ì§ì ‘ ì¶”ê°€
                addExpenseItemToDOM(change.doc.id, data);
              } else if(change.type === 'removed') {
                // í•­ëª© ì‚­ì œ - DOMì—ì„œ ì§ì ‘ ì œê±°
                removeExpenseItemFromDOM(change.doc.id);
              }
            }
          });
          
          // ëª¨ë“  ë³€ê²½ í›„ ì†Œê³„/ì´ê³„ ì—…ë°ì´íŠ¸
          updateExpenseModalContent();
        } else {
          render();
        }
      });
    }
    
    /* í•­ëª© DOM ì¶”ê°€ (ê¹œë¹¡ì„ ë°©ì§€) */
    function addExpenseItemToDOM(expenseId, data){
      // ì´ë¯¸ DOMì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
      if(document.querySelector(`[data-expense-id="${expenseId}"]`)) {
        console.log('í•­ëª©ì´ ì´ë¯¸ ì¡´ì¬í•¨, ì¶”ê°€ ìŠ¤í‚µ:', expenseId);
        return;
      }
      
      const user = allUsers.find(u => u.id === data.userId);
      if(!user) return;
      
      const isMe = user.id === currentUser.id;
      const canEdit = isMe;
      const color = colorPalette[user.colorIndex];
      
      // í•´ë‹¹ ìœ ì €ì˜ ì¹´ë“œ ì°¾ê¸°
      const teamCard = document.querySelector(`[data-user-id="${data.userId}"]`);
      if(!teamCard) return;
      
      // í•­ëª© ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
      let itemsContainer = teamCard.querySelector('.space-y-2');
      if(!itemsContainer) return;
      
      // "ì§€ì¶œ í•­ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”" ë©”ì‹œì§€ ì œê±°
      const emptyMessage = itemsContainer.querySelector('.text-center.py-4');
      if(emptyMessage) {
        emptyMessage.remove();
      }
      
      // ìƒˆ í•­ëª© HTML ìƒì„±
      const itemHtml = `
        <div class="flex items-center gap-1 sm:gap-2" data-expense-id="${expenseId}">
          <input type="text" 
            value="${escapeHtml(data.description || '')}"
            placeholder="ì§€ì¶œ ë‚´ìš©"
            ${canEdit ? '' : 'readonly'}
            ${canEdit ? `oninput="updateExpenseItem('${expenseId}', 'description', this.value)"` : ''}
            class="flex-1 px-2 sm:px-3 py-2 border rounded-lg text-sm ${canEdit ? '' : 'bg-gray-50'}" 
            autocomplete="off">
          <input type="text" 
            inputmode="numeric"
            value="${data.amount && data.amount > 0 ? data.amount.toLocaleString() : ''}"
            placeholder="ê¸ˆì•¡"
            ${canEdit ? '' : 'readonly'}
            ${canEdit ? `oninput="formatAmountInput(this, '${expenseId}')"` : ''}
            class="w-24 sm:w-28 px-2 sm:px-3 py-2 border rounded-lg text-sm text-right ${canEdit ? '' : 'bg-gray-50'}" 
            autocomplete="off">
          ${canEdit ? `
            <button onclick="deleteExpenseItem('${expenseId}')" 
              class="p-1.5 sm:p-2 text-red-600 hover:bg-red-50 rounded-lg active:bg-red-100 flex-shrink-0">
              <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          ` : ''}
        </div>
      `;
      
      // DOMì— ì¶”ê°€
      itemsContainer.insertAdjacentHTML('beforeend', itemHtml);
      console.log('í•­ëª© DOM ì¶”ê°€ ì™„ë£Œ:', expenseId);
    }
    
    /* í•­ëª© DOM ì œê±° (ê¹œë¹¡ì„ ë°©ì§€) */
    function removeExpenseItemFromDOM(expenseId){
      const itemElement = document.querySelector(`[data-expense-id="${expenseId}"]`);
      if(itemElement) {
        itemElement.remove();
        console.log('í•­ëª© DOM ì œê±° ì™„ë£Œ:', expenseId);
        
        // í•­ëª©ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
        const teamCard = itemElement.closest('[data-user-id]');
        if(teamCard) {
          const itemsContainer = teamCard.querySelector('.space-y-2');
          const remainingItems = itemsContainer.querySelectorAll('[data-expense-id]');
          
          // í•­ëª©ì´ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
          if(remainingItems.length === 0) {
            const userId = teamCard.getAttribute('data-user-id');
            const isMe = userId === currentUser.id;
            itemsContainer.innerHTML = `
              <div class="text-center py-4 text-gray-400 text-sm">
                ${isMe ? 'ì§€ì¶œ í•­ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”' : 'ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤'}
              </div>
            `;
          }
        }
      }
    }
    
    /* ì •ì‚° ëª¨ë‹¬ ë‚´ìš©ë§Œ ì—…ë°ì´íŠ¸ (ê¹œë¹¡ì„ ë°©ì§€) */
    function updateExpenseModalContent(){
      if(!showExpenseModal || !selectedCamping) return;
      
      const camping = selectedCamping;
      const participants = (camping.participants || [])
        .map(pid => allUsers.find(u => u.id === pid))
        .filter(u => u);
      
      const campingExpenses = expenses.filter(e => e.campingId === camping.id);
      
      // ê° íŒ€ë³„ ì†Œê³„ ë° ì´ê³„ ì¬ê³„ì‚°
      let totalAmount = 0;
      const teamTotals = {};
      
      participants.forEach(user => {
        const userExpenses = campingExpenses.filter(e => e.userId === user.id);
        const teamTotal = userExpenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
        teamTotals[user.id] = teamTotal;
        totalAmount += teamTotal;
      });
      
      const perPerson = participants.length > 0 ? Math.floor((totalAmount / participants.length) / 100) * 100 : 0;
      
      console.log('ì´ê³„ ì—…ë°ì´íŠ¸:', totalAmount, '1/n:', perPerson);
      console.log('íŒ€ë³„ ì†Œê³„:', teamTotals);
      
      // ì´ í•©ê³„ ì—…ë°ì´íŠ¸
      const totalContainer = document.querySelector('.bg-gradient-to-r.from-green-50');
      if(totalContainer) {
        const totalAmountSpan = totalContainer.querySelector('.text-green-600');
        if(totalAmountSpan) {
          totalAmountSpan.textContent = totalAmount.toLocaleString() + 'ì›';
          console.log('ì´ í•©ê³„ DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }
        
        const perPersonSpan = totalContainer.querySelector('.text-blue-600');
        if(perPersonSpan) {
          perPersonSpan.textContent = perPerson.toLocaleString() + 'ì›';
          console.log('1/n DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }
      }
      
      // ê° íŒ€ë³„ ì†Œê³„ ì—…ë°ì´íŠ¸
      participants.forEach(user => {
        const teamTotal = teamTotals[user.id] || 0;
        const teamCard = document.querySelector(`[data-user-id="${user.id}"]`);
        if(teamCard) {
          const subtotalSpan = teamCard.querySelector('.border-t span:last-child');
          if(subtotalSpan) {
            subtotalSpan.textContent = teamTotal.toLocaleString() + 'ì›';
            console.log(`${user.name} ì†Œê³„ ì—…ë°ì´íŠ¸:`, teamTotal);
          } else {
            console.log(`${user.name} ì†Œê³„ span ì—†ìŒ`);
          }
        } else {
          console.log(`${user.name} ì¹´ë“œ ì—†ìŒ`);
        }
      });
    }

    /* ìº˜ë¦°ë” ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ */
    function setupCalendarSwipe() {
      let touchStartX = 0;
      let touchEndX = 0;
      let touchStartY = 0;
      let touchEndY = 0;
      
      const handleSwipe = () => {
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;
        
        // ê°€ë¡œ ìŠ¤ì™€ì´í”„ê°€ ì„¸ë¡œ ìŠ¤ì™€ì´í”„ë³´ë‹¤ í¬ê³ , ìµœì†Œ 50px ì´ìƒ ì›€ì§ì˜€ì„ ë•Œë§Œ
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
          if (diffX > 0) {
            // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ â†’ ì´ì „ ë‹¬
            changeMonth(-1);
          } else {
            // ì™¼ìª½ ìŠ¤ì™€ì´í”„ â†’ ë‹¤ìŒ ë‹¬
            changeMonth(1);
          }
        }
      };
      
      // í„°ì¹˜ ì´ë²¤íŠ¸ëŠ” render í›„ DOMì´ ìƒì„±ëœ í›„ì— ì¶”ê°€ë˜ì–´ì•¼ í•¨
      const addTouchListeners = () => {
        const calendar = document.getElementById('calendarContainer');
        if (!calendar) {
          // DOMì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë‹¤ì‹œ ì‹œë„
          setTimeout(addTouchListeners, 100);
          return;
        }
        
        calendar.addEventListener('touchstart', (e) => {
          touchStartX = e.changedTouches[0].screenX;
          touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });
        
        calendar.addEventListener('touchend', (e) => {
          touchEndX = e.changedTouches[0].screenX;
          touchEndY = e.changedTouches[0].screenY;
          handleSwipe();
        }, { passive: true });
      };
      
      addTouchListeners();
    }

    // ì €ì¥ëœ ë¡œê·¸ì¸ ë³µì› ë° ì•± ì‹œì‘
    function bootApp(){
      // âœ… ìœ ì € ëª©ë¡ ìºì‹œëŠ” ë¡œê·¸ì¸ ë°©ì‹ê³¼ ìƒê´€ì—†ì´ í•­ìƒ ë¨¼ì € êµ¬ë…
      db.collection('users').onSnapshot(snapshot=>{
        allUsers = [];
        snapshot.forEach(doc=>{
          const u=doc.data();
          allUsers.push({ id: doc.id, name: u.name, phone: normalizePhone(u.phone), colorIndex: u.colorIndex });
        });
        render();
      });
      
      const saved = localStorage.getItem('currentUser');
      if(saved){
        try{
          currentUser = JSON.parse(saved);
          isLoading = true;
          render();
          setTimeout(() => {
            isLoading = false;
            // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„ íƒ
            selectedDate = formatDate(new Date());
            init();
            render();
          }, 1500);
          return;
        }catch(e){ localStorage.removeItem('currentUser'); }
      }
      render();
    }
  </script>
</body>
</html>
