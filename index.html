<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°™ì´ ë†€ëŸ¬ê°€ì ğŸ•ï¸</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior-y: contain; }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes sway {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-bounce { animation: bounce 2s ease-in-out infinite; }
        .animate-sway { animation: sway 3s ease-in-out infinite; }
        .animate-flicker { animation: flicker 1.5s ease-in-out infinite; }
        
        input, textarea, select { font-size: 16px !important; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-hover {
            transition: all 0.3s ease;
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100">
    <div id="app"></div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD_PbklnjhtT3u3UKLnVem7B9u4kYOIil8",
            authDomain: "camping-79469.firebaseapp.com",
            projectId: "camping-79469",
            storageBucket: "camping-79469.firebasestorage.app",
            messagingSenderId: "22038621532",
            appId: "1:22038621532:web:e4b0f5e5b8bc5c4ede9b65"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const holidays = {
            '2025-01-01': 'ì‹ ì •',
            '2025-01-28': 'ì„¤ë‚  ì—°íœ´',
            '2025-01-29': 'ì„¤ë‚ ',
            '2025-01-30': 'ì„¤ë‚  ì—°íœ´',
            '2025-03-01': 'ì‚¼ì¼ì ˆ',
            '2025-05-05': 'ì–´ë¦°ì´ë‚ ',
            '2025-05-06': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2025-06-06': 'í˜„ì¶©ì¼',
            '2025-08-15': 'ê´‘ë³µì ˆ',
            '2025-10-03': 'ê°œì²œì ˆ',
            '2025-10-05': 'ì¶”ì„ ì—°íœ´',
            '2025-10-06': 'ì¶”ì„',
            '2025-10-07': 'ì¶”ì„ ì—°íœ´',
            '2025-10-08': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2025-10-09': 'í•œê¸€ë‚ ',
            '2025-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
            '2026-01-01': 'ì‹ ì •',
            '2026-02-16': 'ì„¤ë‚  ì—°íœ´',
            '2026-02-17': 'ì„¤ë‚ ',
            '2026-02-18': 'ì„¤ë‚  ì—°íœ´',
            '2026-03-01': 'ì‚¼ì¼ì ˆ',
            '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-05-05': 'ì–´ë¦°ì´ë‚ ',
            '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
            '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-06-06': 'í˜„ì¶©ì¼',
            '2026-08-15': 'ê´‘ë³µì ˆ',
            '2026-09-24': 'ì¶”ì„ ì—°íœ´',
            '2026-09-25': 'ì¶”ì„',
            '2026-09-26': 'ì¶”ì„ ì—°íœ´',
            '2026-10-03': 'ê°œì²œì ˆ',
            '2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-10-09': 'í•œê¸€ë‚ ',
            '2026-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤'
        };

        const colorPalette = [
            '#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4',
            '#f97316', '#14b8a6', '#a855f7', '#ef4444', '#3b82f6', '#84cc16'
        ];

        let currentUser = null;
        let allUsers = [];
        let schedules = [];
        let campings = [];
        let showModal = false;
        let selectedDate = null;
        let showCampingDetail = false;
        let selectedCamping = null;
        let showCampingModal = false;
        let editingCamping = null;
        let currentMonth = new Date();
        let showLoginModal = false;
        let isSignUp = false;
        let isLoading = false;

        function formatDate(date) {
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return String(text).replace(/[&<>"']/g, function(m) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
            });
        }

        function getCampingForDateRange(dateStr) {
            for (var i = 0; i < campings.length; i++) {
                if (dateStr >= campings[i].startDate && dateStr <= campings[i].endDate) {
                    return campings[i];
                }
            }
            return null;
        }

        window.changeMonth = function(delta) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
            render();
        };

        function getMonthYear() {
            return currentMonth.getFullYear() + 'ë…„ ' + (currentMonth.getMonth() + 1) + 'ì›”';
        }
        window.openLoginModal = function() {
            showLoginModal = true;
            isSignUp = false;
            render();
        };

        window.openSignUpModal = function() {
            showLoginModal = true;
            isSignUp = true;
            render();
        };

        window.closeLoginModal = function() {
            showLoginModal = false;
            isSignUp = false;
            render();
        };

        window.toggleAuthMode = function() {
            isSignUp = !isSignUp;
            render();
        };

        window.handleAuth = function() {
            var teamName = document.getElementById('authTeamName').value.trim();
            var phone = document.getElementById('authPhone').value.trim();

            if (!teamName || !phone) {
                alert('íŒ€ ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            var phoneRegex = /^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$/;
            if (!phoneRegex.test(phone)) {
                alert('ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                return;
            }

            if (isSignUp) {
                // íšŒì›ê°€ì…
                var existingUserByPhone = allUsers.find(function(u) { return u.phone === phone; });
                if (existingUserByPhone) {
                    alert('ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                var existingUserByName = allUsers.find(function(u) { return u.name === teamName; });
                if (existingUserByName) {
                    alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ íŒ€ ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                var colorIndex = allUsers.length % colorPalette.length;
                var newUser = {
                    name: teamName,
                    phone: phone,
                    colorIndex: colorIndex,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                isLoading = true;
                showLoginModal = false;
                render();

                db.collection('users').add(newUser).then(function(docRef) {
                    // ìƒˆ ì‚¬ìš©ìë¥¼ allUsersì— ì¶”ê°€
                    var createdUser = {
                        id: docRef.id,
                        name: teamName,
                        phone: phone,
                        colorIndex: colorIndex
                    };
                    allUsers.push(createdUser);
                    
                    currentUser = createdUser;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    setTimeout(function() {
                        isLoading = false;
                        isSignUp = false;
                        init();
                    }, 2000);
                }).catch(function(error) {
                    isLoading = false;
                    alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    render();
                });
            } else {
                // ë¡œê·¸ì¸
                console.log('ë¡œê·¸ì¸ ì‹œë„:', teamName, phone);
                console.log('ì „ì²´ ì‚¬ìš©ì:', allUsers);
                
                var user = allUsers.find(function(u) { 
                    console.log('ë¹„êµ:', u.name, '===', teamName, '&&', u.phone, '===', phone);
                    return u.name === teamName && u.phone === phone; 
                });
                
                console.log('ì°¾ì€ ì‚¬ìš©ì:', user);
                
                if (!user) {
                    alert('íŒ€ ì´ë¦„ ë˜ëŠ” íœ´ëŒ€í° ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì…ë ¥í•œ ì •ë³´:\níŒ€ ì´ë¦„: ' + teamName + '\níœ´ëŒ€í°: ' + phone + '\n\në“±ë¡ëœ ì‚¬ìš©ì ìˆ˜: ' + allUsers.length + 'ëª…');
                    return;
                }

                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                isLoading = true;
                showLoginModal = false;
                render();
                
                setTimeout(function() {
                    isLoading = false;
                    init();
                }, 2000);
            }
        };

        window.logout = function() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            render();
        };
        window.openAddModal = function(dateStr) {
            selectedDate = dateStr;
            showModal = true;
            showCampingDetail = false;
            render();
        };

        window.closeModal = function() {
            showModal = false;
            selectedDate = null;
            render();
        };

        window.setStatus = function(status) {
            if (!currentUser || !selectedDate) return;
            
            var camping = getCampingForDateRange(selectedDate);
            var datesToUpdate = [];
            
            if (camping) {
                var start = new Date(camping.startDate);
                var end = new Date(camping.endDate);
                for (var d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    datesToUpdate.push(formatDate(new Date(d)));
                }
            } else {
                datesToUpdate.push(selectedDate);
            }
            
            var updatePromises = [];
            for (var i = 0; i < datesToUpdate.length; i++) {
                var dateStr = datesToUpdate[i];
                var existing = null;
                for (var j = 0; j < schedules.length; j++) {
                    if (schedules[j].date === dateStr && schedules[j].userId === currentUser.id) {
                        existing = schedules[j];
                        break;
                    }
                }
                
                var data = {
                    title: status, 
                    date: dateStr, 
                    userId: currentUser.id,
                    userName: currentUser.name, 
                    color: colorPalette[currentUser.colorIndex]
                };

                if (existing) {
                    updatePromises.push(db.collection('schedules').doc(existing.id).update(data));
                } else {
                    updatePromises.push(db.collection('schedules').add(data));
                }
            }
            
            Promise.all(updatePromises).then(function() {
                showModal = false;
                selectedDate = null;
                render();
            });
        };

        window.deleteStatus = function() {
            if (!currentUser || !selectedDate) return;
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            var camping = getCampingForDateRange(selectedDate);
            var datesToDelete = [];
            
            if (camping) {
                var start = new Date(camping.startDate);
                var end = new Date(camping.endDate);
                for (var d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    datesToDelete.push(formatDate(new Date(d)));
                }
            } else {
                datesToDelete.push(selectedDate);
            }
            
            var deletePromises = [];
            for (var i = 0; i < datesToDelete.length; i++) {
                var dateStr = datesToDelete[i];
                for (var j = 0; j < schedules.length; j++) {
                    if (schedules[j].date === dateStr && schedules[j].userId === currentUser.id) {
                        deletePromises.push(db.collection('schedules').doc(schedules[j].id).delete());
                    }
                }
            }
            
            Promise.all(deletePromises).then(function() {
                showModal = false;
                selectedDate = null;
                render();
            });
        };
        window.openCampingDetail = function(campingId) {
            selectedCamping = campings.find(function(c) { return c.id === campingId; });
            if (selectedCamping) {
                showCampingDetail = true;
                showModal = false;
                render();
            }
        };

        window.closeCampingDetail = function() {
            showCampingDetail = false;
            selectedCamping = null;
            render();
        };

        window.openCampingModal = function(dateStr, campingId) {
            if (campingId) {
                editingCamping = campings.find(function(c) { return c.id === campingId; });
            } else {
                editingCamping = null;
            }
            selectedDate = dateStr;
            showCampingModal = true;
            showCampingDetail = false;
            render();
        };

        window.closeCampingModal = function() {
            showCampingModal = false;
            editingCamping = null;
            render();
        };

        window.saveCamping = function() {
            var name = document.getElementById('campingName').value.trim();
            var startDate = document.getElementById('campingStartDate').value;
            var endDate = document.getElementById('campingEndDate').value;
            var address = document.getElementById('campingAddress').value.trim();
            var website = document.getElementById('campingWebsite').value.trim();
            var info = document.getElementById('campingInfo').value.trim();

            if (!name || !startDate || !endDate) {
                alert('ì¼ì • ì´ë¦„ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì•ì„œì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            var data = {
                name: name,
                startDate: startDate,
                endDate: endDate,
                address: address,
                website: website,
                info: info,
                createdBy: currentUser.id,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (editingCamping) {
                db.collection('campings').doc(editingCamping.id).update(data).then(function() {
                    showCampingModal = false;
                    editingCamping = null;
                    render();
                });
            } else {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                db.collection('campings').add(data).then(function() {
                    showCampingModal = false;
                    render();
                });
            }
        };

        window.deleteCamping = function(campingId, createdBy) {
            if (createdBy !== currentUser.id) {
                alert('ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                db.collection('campings').doc(campingId).delete().then(function() {
                    showCampingDetail = false;
                    showCampingModal = false;
                    selectedCamping = null;
                    editingCamping = null;
                    render();
                });
            }
        };
        function render() {
            var app = document.getElementById('app');

            if (isLoading) {
                app.innerHTML = '<div class="loading-screen">' +
                    '<div class="text-center mb-8">' +
                        '<div class="text-8xl mb-4 animate-sway">ğŸ•ï¸</div>' +
                        '<div class="text-6xl mb-4 animate-flicker">ğŸ”¥</div>' +
                        '<div class="text-5xl animate-bounce">ğŸš¶</div>' +
                    '</div>' +
                    '<h2 class="text-2xl font-bold text-white mb-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</h2>' +
                    '<p class="text-white/80">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤</p>' +
                '</div>';
                return;
            }

            if (!currentUser) {
                var loginModalHtml = '';
                if (showLoginModal) {
                    var colorNotice = isSignUp ? '<div class="text-xs text-indigo-700 bg-indigo-50 p-3 rounded-xl border border-indigo-200 font-medium">ğŸ¨ ìƒ‰ìƒì€ ê°€ì… ìˆœì„œëŒ€ë¡œ ìë™ìœ¼ë¡œ ë°°ì •ë©ë‹ˆë‹¤</div>' : '';
                    
                    loginModalHtml = '<div class="fixed inset-0 bg-black/60 z-50 flex items-end animate-fade-in" onclick="if(event.target===this)closeLoginModal()">' +
                        '<div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up shadow-2xl max-h-[90vh] overflow-y-auto">' +
                            '<div class="flex justify-between items-center mb-5">' +
                                '<h3 class="text-xl font-bold text-slate-800">' + (isSignUp ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸') + '</h3>' +
                                '<button onclick="closeLoginModal()" class="text-3xl text-slate-400 hover:text-slate-600 transition-colors">Ã—</button>' +
                            '</div>' +
                            '<div class="space-y-4">' +
                                '<div>' +
                                    '<label class="block text-sm mb-2 font-bold text-slate-700">íŒ€ ì´ë¦„</label>' +
                                    '<input type="text" id="authTeamName" placeholder="ì˜ˆ) ì„œí•˜ë„¤, ë‹¤ì€ì´ë„¤" class="w-full px-4 py-3.5 border-2 border-slate-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">' +
                                '</div>' +
                                '<div>' +
                                    '<label class="block text-sm mb-2 font-bold text-slate-700">íœ´ëŒ€í° ë²ˆí˜¸</label>' +
                                    '<input type="tel" id="authPhone" placeholder="010-1234-5678" class="w-full px-4 py-3.5 border-2 border-slate-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">' +
                                '</div>' +
                                colorNotice +
                                '<button onclick="handleAuth()" class="w-full py-3.5 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all btn-hover">' + (isSignUp ? 'ê°€ì…í•˜ê¸°' : 'ë¡œê·¸ì¸') + '</button>' +
                                '<button onclick="toggleAuthMode()" class="w-full text-sm text-slate-600 hover:text-slate-800 transition-colors">' + (isSignUp ? 'ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”? ë¡œê·¸ì¸' : 'ê³„ì •ì´ ì—†ë‚˜ìš”? íšŒì›ê°€ì…') + '</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }

                app.innerHTML = '<div class="min-h-screen flex flex-col items-center justify-center p-6 gradient-bg">' +
                    '<div class="text-center mb-8 animate-fade-in">' +
                        '<h1 class="text-6xl mb-4">ğŸ•ï¸</h1>' +
                        '<h2 class="text-4xl font-bold text-white mb-2 drop-shadow-lg">ê°™ì´ ë†€ëŸ¬ê°€ì</h2>' +
                        '<p class="text-white/90 text-lg">ìš°ë¦¬ ê°€ì¡± ì¼ì •ì„ í•¨ê»˜ ê´€ë¦¬í•´ìš”</p>' +
                    '</div>' +
                    '<div class="w-full max-w-sm space-y-3 animate-slide-up">' +
                        '<button onclick="openLoginModal()" class="w-full py-4 bg-white rounded-2xl shadow-lg font-bold text-lg btn-hover transition-all text-indigo-600">ë¡œê·¸ì¸</button>' +
                        '<button onclick="openSignUpModal()" class="w-full py-4 glass rounded-2xl font-bold text-lg text-white btn-hover">íšŒì›ê°€ì…</button>' +
                    '</div>' +
                    loginModalHtml +
                '</div>';
                return;
            }
            var firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            var lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            var dates = [];
            
            for (var d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d));
            }

            var datesHtml = '';
            for (var idx = 0; idx < dates.length; idx++) {
                var date = dates[idx];
                var dateStr = formatDate(date);
                var dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                var isWeekend = date.getDay() === 0 || date.getDay() === 6;
                var isToday = dateStr === formatDate(new Date());
                var holiday = holidays[dateStr];
                
                var camping = getCampingForDateRange(dateStr);
                var dateSchedules = schedules.filter(function(s) { return s.date === dateStr; });

                var attendingUsers = dateSchedules.filter(function(s) { return s.title === 'ì°¸ì„'; });
                var notAttendingUsers = dateSchedules.filter(function(s) { return s.title === 'ë¶ˆì°¸'; });
                var pendingUsers = dateSchedules.filter(function(s) { return s.title === 'ë³´ë¥˜'; });

                var membersStatusHtml = '';
                var chunks = [];
                for (var i = 0; i < allUsers.length; i += 3) {
                    chunks.push(allUsers.slice(i, i + 3));
                }
                
                for (var c = 0; c < chunks.length; c++) {
                    var chunk = chunks[c];
                    membersStatusHtml += '<div class="flex gap-1.5 mt-2">';
                    
                    for (var m = 0; m < chunk.length; m++) {
                        var member = chunk[m];
                        var userSchedule = dateSchedules.find(function(s) { return s.userId === member.id; });
                        var bgColor = 'bg-slate-100';
                        var textColor = 'text-slate-400';
                        var borderColor = 'border-slate-200';
                        
                        if (userSchedule) {
                            if (userSchedule.title === 'ì°¸ì„') {
                                bgColor = 'bg-emerald-100';
                                textColor = 'text-emerald-700';
                                borderColor = 'border-emerald-300';
                            } else if (userSchedule.title === 'ë³´ë¥˜') {
                                bgColor = 'bg-amber-100';
                                textColor = 'text-amber-700';
                                borderColor = 'border-amber-300';
                            } else {
                                bgColor = 'bg-rose-100';
                                textColor = 'text-rose-700';
                                borderColor = 'border-rose-300';
                            }
                        }
                        
                        membersStatusHtml += '<div class="flex-1 text-center py-1.5 rounded-lg text-xs ' + bgColor + ' ' + textColor + ' ' + borderColor + ' border font-medium">' + escapeHtml(member.name) + '</div>';
                    }
                    
                    var emptySlots = 3 - chunk.length;
                    for (var e = 0; e < emptySlots; e++) {
                        membersStatusHtml += '<div class="flex-1 py-1.5 rounded-lg bg-slate-50 border border-slate-200"></div>';
                    }
                    membersStatusHtml += '</div>';
                }

                var statusSummary = '';
                if (attendingUsers.length > 0 || notAttendingUsers.length > 0 || pendingUsers.length > 0) {
                    statusSummary = '<div class="text-xs text-slate-600 mt-2 flex items-center gap-2">';
                    if (attendingUsers.length > 0) {
                        statusSummary += '<span class="text-emerald-600 font-medium">ğŸ‘ ' + attendingUsers.length + '</span>';
                    }
                    if (pendingUsers.length > 0) {
                        statusSummary += '<span class="text-amber-600 font-medium">â¸ï¸ ' + pendingUsers.length + '</span>';
                    }
                    if (notAttendingUsers.length > 0) {
                        statusSummary += '<span class="text-rose-600 font-medium">ğŸ‘ ' + notAttendingUsers.length + '</span>';
                    }
                    statusSummary += '</div>';
                }

                var campingHtml = '';
                if (camping) {
                    campingHtml = '<div onclick="openCampingDetail(\'' + camping.id + '\')" class="mt-2 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl p-2.5 cursor-pointer active:scale-95 transition-transform">' +
                        '<div class="flex items-center gap-2">' +
                            '<span class="text-lg">ğŸ•ï¸</span>' +
                            '<div class="flex-1 min-w-0">' +
                                '<div class="font-bold text-sm text-amber-900 truncate">' + escapeHtml(camping.name) + '</div>' +
                                '<div class="text-xs text-amber-700 font-medium">' + camping.startDate + ' ~ ' + camping.endDate + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }

                var buttonHtml = '<div class="flex items-center gap-2 ml-2">';
                buttonHtml += '<button onclick="openAddModal(\'' + dateStr + '\')" class="px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold hover:bg-indigo-200 transition-colors border border-indigo-300">ë“±ë¡</button>';
                
                if (!camping) {
                    buttonHtml += '<button onclick="openCampingModal(\'' + dateStr + '\', null)" class="px-2.5 py-1.5 bg-amber-100 text-amber-700 rounded-lg text-xs font-bold hover:bg-amber-200 transition-colors border border-amber-300">ì¼ì •</button>';
                }
                buttonHtml += '</div>';

                var holidayHtml = holiday ? '<div class="text-xs text-rose-500 font-semibold mt-1 flex items-center gap-1"><span>ğŸ‰</span>' + holiday + '</div>' : '';
                var todayBadge = isToday ? '<span class="text-xs bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-2.5 py-0.5 rounded-full ml-1 font-medium">ì˜¤ëŠ˜</span>' : '';

                datesHtml += '<div class="bg-white rounded-2xl p-4 shadow-sm border-2 transition-all hover:shadow-md ' + (isToday ? 'border-indigo-400 shadow-indigo-100' : 'border-slate-200') + '">' +
                    '<div class="flex items-start justify-between mb-2">' +
                        '<div class="flex-1">' +
                            '<div class="flex items-center gap-2">' +
                                '<span class="text-2xl font-bold ' + (isWeekend || holiday ? 'text-rose-500' : 'text-slate-800') + '">' + date.getDate() + '</span>' +
                                '<span class="text-sm font-medium ' + (isWeekend || holiday ? 'text-rose-500' : 'text-slate-500') + '">' + dayOfWeek + '</span>' +
                                todayBadge +
                            '</div>' +
                            holidayHtml +
                            campingHtml +
                        '</div>' +
                        buttonHtml +
                    '</div>' +
                    membersStatusHtml +
                    statusSummary +
                '</div>';
            }
            var modalHtml = '';
            if (showModal) {
                var mySchedule = schedules.find(function(s) { return s.date === selectedDate && s.userId === currentUser.id; });
                var modalContent = '';
                
                if (mySchedule) {
                    modalContent = '<div class="space-y-3">' +
                        '<div class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">' +
                            '<div class="text-sm text-slate-600 mb-1 font-medium">í˜„ì¬ ìƒíƒœ</div>' +
                            '<div class="text-lg font-bold text-indigo-600">' + mySchedule.title + '</div>' +
                        '</div>' +
                        '<div class="grid grid-cols-3 gap-2">' +
                            '<button onclick="setStatus(\'ì°¸ì„\')" class="py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:shadow-xl transition-all btn-hover text-sm">ğŸ‘ ì°¸ì„</button>' +
                            '<button onclick="setStatus(\'ë³´ë¥˜\')" class="py-3 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-xl font-bold shadow-lg shadow-amber-200 hover:shadow-xl transition-all btn-hover text-sm">â¸ï¸ ë³´ë¥˜</button>' +
                            '<button onclick="setStatus(\'ë¶ˆì°¸\')" class="py-3 bg-gradient-to-r from-rose-500 to-rose-600 text-white rounded-xl font-bold shadow-lg shadow-rose-200 hover:shadow-xl transition-all btn-hover text-sm">ğŸ‘ ë¶ˆì°¸</button>' +
                        '</div>' +
                        '<button onclick="deleteStatus()" class="w-full py-3 border-2 border-slate-300 rounded-xl font-medium text-slate-700 mt-2 hover:bg-slate-50 transition-colors">ì‚­ì œ</button>' +
                    '</div>';
                } else {
                    modalContent = '<div class="grid grid-cols-3 gap-2">' +
                        '<button onclick="setStatus(\'ì°¸ì„\')" class="py-4 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-2xl font-bold shadow-xl shadow-emerald-200 hover:shadow-2xl transition-all btn-hover">ğŸ‘<br>ì°¸ì„</button>' +
                        '<button onclick="setStatus(\'ë³´ë¥˜\')" class="py-4 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-2xl font-bold shadow-xl shadow-amber-200 hover:shadow-2xl transition-all btn-hover">â¸ï¸<br>ë³´ë¥˜</button>' +
                        '<button onclick="setStatus(\'ë¶ˆì°¸\')" class="py-4 bg-gradient-to-r from-rose-500 to-rose-600 text-white rounded-2xl font-bold shadow-xl shadow-rose-200 hover:shadow-2xl transition-all btn-hover">ğŸ‘<br>ë¶ˆì°¸</button>' +
                    '</div>';
                }
                
                modalHtml = '<div class="fixed inset-0 bg-black/60 z-40 flex items-end animate-fade-in" onclick="if(event.target===this)closeModal()">' +
                    '<div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up shadow-2xl">' +
                        '<div class="flex justify-between items-center mb-5">' +
                            '<h3 class="text-xl font-bold text-slate-800">' + selectedDate + '</h3>' +
                            '<button onclick="closeModal()" class="text-3xl text-slate-400 hover:text-slate-600 w-10 h-10 transition-colors">Ã—</button>' +
                        '</div>' +
                        modalContent +
                    '</div>' +
                '</div>';
            }

            var campingDetailHtml = '';
            if (showCampingDetail && selectedCamping) {
                var addressHtml = selectedCamping.address ? '<div class="flex items-start gap-2"><span>ğŸ“</span><span>' + escapeHtml(selectedCamping.address) + '</span></div>' : '';
                var websiteHtml = selectedCamping.website ? '<div class="flex items-start gap-2"><span>ğŸ”—</span><a href="' + selectedCamping.website + '" target="_blank" class="text-indigo-600 hover:text-indigo-700 underline break-all">' + escapeHtml(selectedCamping.website) + '</a></div>' : '';
                var infoHtml = selectedCamping.info ? '<div class="bg-slate-50 rounded-2xl p-5 border-2 border-slate-200"><h5 class="font-bold mb-3 text-slate-800 flex items-center gap-2"><span>ğŸ“</span>ì•ˆë‚´ì‚¬í•­</h5><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">' + escapeHtml(selectedCamping.info) + '</div></div>' : '';
                var editButtonHtml = selectedCamping.createdBy === currentUser.id ? '<button onclick="openCampingModal(\'' + selectedCamping.startDate + '\', \'' + selectedCamping.id + '\')" class="flex-1 py-3.5 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all btn-hover">ìˆ˜ì •</button>' : '';
                
                campingDetailHtml = '<div class="fixed inset-0 bg-black/60 z-40 flex items-end animate-fade-in" onclick="if(event.target===this)closeCampingDetail()">' +
                    '<div class="bg-white w-full rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto animate-slide-up shadow-2xl">' +
                        '<div class="flex justify-between items-center mb-5">' +
                            '<h3 class="text-xl font-bold text-slate-800">ğŸ•ï¸ ì¼ì • ì •ë³´</h3>' +
                            '<button onclick="closeCampingDetail()" class="text-3xl text-slate-400 hover:text-slate-600 transition-colors">Ã—</button>' +
                        '</div>' +
                        '<div class="space-y-4">' +
                            '<div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-5 border-2 border-amber-200">' +
                                '<h4 class="font-bold text-xl mb-3 text-amber-900">' + escapeHtml(selectedCamping.name) + '</h4>' +
                                '<div class="text-sm text-slate-700 space-y-2">' +
                                    '<div class="flex items-center gap-2"><span>ğŸ“…</span><span class="font-medium">' + selectedCamping.startDate + ' ~ ' + selectedCamping.endDate + '</span></div>' +
                                    addressHtml +
                                    websiteHtml +
                                '</div>' +
                            '</div>' +
                            infoHtml +
                            '<div class="flex gap-3 pt-2">' +
                                editButtonHtml +
                                '<button onclick="closeCampingDetail()" class="flex-1 py-3.5 border-2 border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50 transition-colors">ë‹«ê¸°</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }

            var campingModalHtml = '';
            if (showCampingModal) {
                var deleteButtonHtml = '';
                if (editingCamping && editingCamping.createdBy === currentUser.id) {
                    deleteButtonHtml = '<div class="pt-4 border-t-2 border-slate-200">' +
                        '<button onclick="deleteCamping(\'' + editingCamping.id + '\', \'' + editingCamping.createdBy + '\')" class="w-full py-3 bg-rose-100 text-rose-700 rounded-xl font-bold border-2 border-rose-300 hover:bg-rose-200 transition-colors">ì¼ì • ì •ë³´ ì‚­ì œ</button>' +
                    '</div>';
                }
                
                campingModalHtml = '<div class="fixed inset-0 bg-black/60 z-50 flex items-end animate-fade-in" onclick="if(event.target===this)closeCampingModal()">' +
                    '<div class="bg-white w-full rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto animate-slide-up shadow-2xl">' +
                        '<div class="flex justify-between items-center mb-5">' +
                            '<h3 class="text-xl font-bold text-slate-800">ğŸ•ï¸ ì¼ì • ' + (editingCamping ? 'ìˆ˜ì •' : 'ë“±ë¡') + '</h3>' +
                            '<button onclick="closeCampingModal()" class="text-3xl text-slate-400 hover:text-slate-600 transition-colors">Ã—</button>' +
                        '</div>' +
                        '<div class="space-y-4">' +
                            '<div>' +
                                '<label class="block text-sm mb-2 font-bold text-slate-700">ì¼ì • ì´ë¦„ *</label>' +
                                '<input type="text" id="campingName" value="' + (editingCamping ? escapeHtml(editingCamping.name) : '') + '" placeholder="ë³„ë¹›ìº í•‘ì¥" class="w-full px-4 py-3.5 border-2 border-slate-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">' +
                            '</div>' +
                            '<div class="space-y-3">' +
                                '<div>' +
                                    '<label class="block text-sm mb-2 font-bold text-slate-700">ì‹œì‘ì¼ *</label>' +
                                    '<input type="date" id="campingStartDate" value="' + (editingCamping ? editingCamping.startDate : selectedDate || '') + '" class="w-full px-4 py-3.5 border-2 border-slate-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">' +
                                '</div>' +
                                '<div>' +
                                    '<label class="block text-sm mb-2 font-bold text-slate-700">ì¢…ë£Œì¼ *</label>' +
                                    '<input type="date" id="campingEndDate" value="' + (editingCamping ? editingCamping.endDate : selectedDate || '') + '" class="w-full px-4 py-3.5 border-2 border-slate-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">' +
                                '</div>' +
                            '</div>' +
                            '<div class="text-xs text-indigo-700 bg-indigo-50 p-3 rounded-xl border border-indigo-200 font-medium">ğŸ’¡ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„¤ì •í•˜ë©´ 2ë°•3ì¼, 3ë°•4ì¼ ë“±ì˜ ì¼ì •ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>' +
                            '<div>' +
                                '<label class="block text-sm mb-2 font-bold text-slate-700">ì£¼ì†Œ</label>' +
                                '<input type="text" id="campingAddress" value="' + (editingCamping && editingCamping.address ? escapeHtml(editingCamping.address) : '') + '" placeholder="ê²½ê¸°ë„ ê°€í‰êµ°..." class="w-full px-4 py-3.5 border-2 border-slate-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">' +
                            '</div>' +
                            '<div>' +
                                '<label class="block text-sm mb-2 font-bold text-slate-700">ì›¹ì‚¬ì´íŠ¸</label>' +
                                '<input type="url" id="campingWebsite" value="' + (editingCamping && editingCamping.website ? escapeHtml(editingCamping.website) : '') + '" placeholder="https://..." class="w-full px-4 py-3.5 border-2 border-slate-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">' +
                            '</div>' +
                            '<div>' +
                                '<label class="block text-sm mb-2 font-bold text-slate-700">ì•ˆë‚´ ë° ë©”ëª¨</label>' +
                                '<textarea id="campingInfo" maxlength="2000" placeholder="ì¼ì • íŠ¹ì§•, ì£¼ì˜ì‚¬í•­ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš” (ìµœëŒ€ 2000ì)" class="w-full px-4 py-3.5 border-2 border-slate-300 rounded-xl resize-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all" rows="5">' + (editingCamping && editingCamping.info ? escapeHtml(editingCamping.info) : '') + '</textarea>' +
                            '</div>' +
                            '<div class="flex gap-3 pt-2">' +
                                '<button onclick="closeCampingModal()" class="flex-1 py-3.5 border-2 border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50 transition-colors">ì·¨ì†Œ</button>' +
                                '<button onclick="saveCamping()" class="flex-1 py-3.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all btn-hover">ì €ì¥</button>' +
                            '</div>' +
                            deleteButtonHtml +
                        '</div>' +
                    '</div>' +
                '</div>';
            }
            var myColor = colorPalette[currentUser.colorIndex];

            app.innerHTML = '<div class="min-h-screen pb-20">' +
                '<div class="sticky top-0 z-30 gradient-bg text-white shadow-xl">' +
                    '<div class="p-5">' +
                        '<div class="flex items-center justify-between mb-4">' +
                            '<div>' +
                                '<h1 class="text-2xl font-bold drop-shadow-lg">ğŸ•ï¸ ê°™ì´ ë†€ëŸ¬ê°€ì</h1>' +
                            '</div>' +
                            '<button onclick="logout()" class="text-xs bg-white/20 px-4 py-2 rounded-full hover:bg-white/30 transition-all font-medium backdrop-blur">ë¡œê·¸ì•„ì›ƒ</button>' +
                        '</div>' +
                        '<div class="flex items-center justify-between">' +
                            '<button onclick="changeMonth(-1)" class="px-5 py-2.5 glass rounded-xl hover:bg-white/20 transition-all font-bold text-lg">â†</button>' +
                            '<h2 class="text-xl font-bold drop-shadow">' + getMonthYear() + '</h2>' +
                            '<button onclick="changeMonth(1)" class="px-5 py-2.5 glass rounded-xl hover:bg-white/20 transition-all font-bold text-lg">â†’</button>' +
                        '</div>' +
                        '<div class="mt-3 flex items-center gap-2.5 bg-white/10 px-3 py-2 rounded-xl backdrop-blur">' +
                            '<div class="w-3 h-3 rounded-full shadow-lg" style="background-color:' + myColor + '"></div>' +
                            '<span class="text-sm font-medium">' + escapeHtml(currentUser.name) + '</span>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="p-4 space-y-3">' + datesHtml + '</div>' +
                modalHtml +
                campingDetailHtml +
                campingModalHtml +
            '</div>';
        }

        function init() {
            db.collection('schedules').onSnapshot(function(snapshot) {
                schedules = [];
                snapshot.forEach(function(doc) {
                    schedules.push(Object.assign({ id: doc.id }, doc.data()));
                });
                render();
            });

            db.collection('campings').onSnapshot(function(snapshot) {
                campings = [];
                snapshot.forEach(function(doc) {
                    campings.push(Object.assign({ id: doc.id }, doc.data()));
                });
                render();
            });
        }

        // ì‚¬ìš©ì ëª©ë¡ì„ ë¨¼ì € ë¡œë“œí•œ í›„ì— ìë™ ë¡œê·¸ì¸ ì‹œë„
        var usersLoaded = false;
        db.collection('users').onSnapshot(function(snapshot) {
            allUsers = [];
            snapshot.forEach(function(doc) {
                var userData = doc.data();
                allUsers.push({
                    id: doc.id,
                    name: userData.name,
                    phone: userData.phone,
                    colorIndex: userData.colorIndex
                });
            });
            
            console.log('Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¨ ì‚¬ìš©ì:', allUsers);
            usersLoaded = true;
            
            // localStorageì— ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë¡œ ìë™ ë¡œê·¸ì¸ ì‹œë„
            var saved = localStorage.getItem('currentUser');
            if (saved && !currentUser) {
                var savedUser = JSON.parse(saved);
                console.log('ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´:', savedUser);
                
                currentUser = allUsers.find(function(u) { 
                    return u.id === savedUser.id; 
                });
                
                console.log('ì°¾ì€ í˜„ì¬ ì‚¬ìš©ì:', currentUser);
                
                if (currentUser) {
                    isLoading = true;
                    render();
                    setTimeout(function() {
                        isLoading = false;
                        init();
                    }, 1500);
                } else {
                    // ì €ì¥ëœ ì •ë³´ê°€ DBì— ì—†ìœ¼ë©´ localStorage í´ë¦¬ì–´
                    localStorage.removeItem('currentUser');
                    render();
                }
            } else {
                render();
            }
        });
    </script>
</body>
</html>
