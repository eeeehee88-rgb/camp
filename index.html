<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°™ì´ ë†€ëŸ¬ê°€ì ğŸ•ï¸</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior-y: contain; }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        input, textarea, select { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD_PbklnjhtT3u3UKLnVem7B9u4kYOIil8",
            authDomain: "camping-79469.firebaseapp.com",
            projectId: "camping-79469",
            storageBucket: "camping-79469.firebasestorage.app",
            messagingSenderId: "22038621532",
            appId: "1:22038621532:web:e4b0f5e5b8bc5c4ede9b65"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const holidays = {
            '2025-01-01': 'ì‹ ì •',
            '2025-01-28': 'ì„¤ë‚  ì—°íœ´',
            '2025-01-29': 'ì„¤ë‚ ',
            '2025-01-30': 'ì„¤ë‚  ì—°íœ´',
            '2025-03-01': 'ì‚¼ì¼ì ˆ',
            '2025-05-05': 'ì–´ë¦°ì´ë‚ ',
            '2025-05-06': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2025-06-06': 'í˜„ì¶©ì¼',
            '2025-08-15': 'ê´‘ë³µì ˆ',
            '2025-10-03': 'ê°œì²œì ˆ',
            '2025-10-05': 'ì¶”ì„ ì—°íœ´',
            '2025-10-06': 'ì¶”ì„',
            '2025-10-07': 'ì¶”ì„ ì—°íœ´',
            '2025-10-08': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2025-10-09': 'í•œê¸€ë‚ ',
            '2025-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
            '2026-01-01': 'ì‹ ì •',
            '2026-02-16': 'ì„¤ë‚  ì—°íœ´',
            '2026-02-17': 'ì„¤ë‚ ',
            '2026-02-18': 'ì„¤ë‚  ì—°íœ´',
            '2026-03-01': 'ì‚¼ì¼ì ˆ',
            '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-05-05': 'ì–´ë¦°ì´ë‚ ',
            '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
            '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-06-06': 'í˜„ì¶©ì¼',
            '2026-08-15': 'ê´‘ë³µì ˆ',
            '2026-09-24': 'ì¶”ì„ ì—°íœ´',
            '2026-09-25': 'ì¶”ì„',
            '2026-09-26': 'ì¶”ì„ ì—°íœ´',
            '2026-10-03': 'ê°œì²œì ˆ',
            '2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-10-09': 'í•œê¸€ë‚ ',
            '2026-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤'
        };

        const colorPalette = [
            '#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4',
            '#f97316', '#14b8a6', '#a855f7', '#ef4444', '#3b82f6', '#84cc16'
        ];

        let currentUser = null;
        let allUsers = [];
        let schedules = [];
        let campings = [];
        let showModal = false;
        let selectedDate = null;
        let showCampingDetail = false;
        let selectedCamping = null;
        let showCampingModal = false;
        let editingCamping = null;
        let currentMonth = new Date();
        let showLoginModal = false;
        let isSignUp = false;

        function formatDate(date) {
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return String(text).replace(/[&<>"']/g, function(m) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
            });
        }

        function getCampingForDateRange(dateStr) {
            for (var i = 0; i < campings.length; i++) {
                if (dateStr >= campings[i].startDate && dateStr <= campings[i].endDate) {
                    return campings[i];
                }
            }
            return null;
        }

        window.changeMonth = function(delta) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
            render();
        };

        function getMonthYear() {
            return currentMonth.getFullYear() + 'ë…„ ' + (currentMonth.getMonth() + 1) + 'ì›”';
        }
        window.openLoginModal = function() {
            showLoginModal = true;
            isSignUp = false;
            render();
        };

        window.openSignUpModal = function() {
            showLoginModal = true;
            isSignUp = true;
            render();
        };

        window.closeLoginModal = function() {
            showLoginModal = false;
            isSignUp = false;
            render();
        };

        window.toggleAuthMode = function() {
            isSignUp = !isSignUp;
            render();
        };

        window.handleAuth = function() {
            var teamName = document.getElementById('authTeamName').value.trim();
            var phone = document.getElementById('authPhone').value.trim();

            if (!teamName || !phone) {
                alert('íŒ€ ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            var phoneRegex = /^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$/;
            if (!phoneRegex.test(phone)) {
                alert('ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                return;
            }

            if (isSignUp) {
                var existingUser = allUsers.find(function(u) { return u.phone === phone; });
                if (existingUser) {
                    alert('ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                var existingName = allUsers.find(function(u) { return u.name === teamName; });
                if (existingName) {
                    alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ íŒ€ ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                var colorIndex = allUsers.length % colorPalette.length;
                var newUser = {
                    name: teamName,
                    phone: phone,
                    colorIndex: colorIndex,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                db.collection('users').add(newUser).then(function(docRef) {
                    currentUser = { id: docRef.id, name: teamName, phone: phone, colorIndex: colorIndex };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showLoginModal = false;
                    isSignUp = false;
                    
                    allUsers.push(currentUser);
                    
                    init();
                    alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(function(error) {
                    alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
            } else {
                var user = allUsers.find(function(u) { 
                    return u.name === teamName && u.phone === phone; 
                });
                
                if (!user) {
                    alert('íŒ€ ì´ë¦„ ë˜ëŠ” íœ´ëŒ€í° ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showLoginModal = false;
                init();
            }
        };

        window.logout = function() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            render();
        };
        window.openAddModal = function(dateStr) {
            selectedDate = dateStr;
            showModal = true;
            showCampingDetail = false;
            render();
        };

        window.closeModal = function() {
            showModal = false;
            selectedDate = null;
            render();
        };

        window.setStatus = function(status) {
            if (!currentUser || !selectedDate) return;
            
            var camping = getCampingForDateRange(selectedDate);
            var datesToUpdate = [];
            
            if (camping) {
                var start = new Date(camping.startDate);
                var end = new Date(camping.endDate);
                for (var d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    datesToUpdate.push(formatDate(new Date(d)));
                }
            } else {
                datesToUpdate.push(selectedDate);
            }
            
            var updatePromises = [];
            for (var i = 0; i < datesToUpdate.length; i++) {
                var dateStr = datesToUpdate[i];
                var existing = null;
                for (var j = 0; j < schedules.length; j++) {
                    if (schedules[j].date === dateStr && schedules[j].userId === currentUser.id) {
                        existing = schedules[j];
                        break;
                    }
                }
                
                var data = {
                    title: status, 
                    date: dateStr, 
                    userId: currentUser.id,
                    userName: currentUser.name, 
                    color: colorPalette[currentUser.colorIndex]
                };

                if (existing) {
                    updatePromises.push(db.collection('schedules').doc(existing.id).update(data));
                } else {
                    updatePromises.push(db.collection('schedules').add(data));
                }
            }
            
            Promise.all(updatePromises).then(function() {
                showModal = false;
                selectedDate = null;
                render();
            });
        };

        window.deleteStatus = function() {
            if (!currentUser || !selectedDate) return;
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            var camping = getCampingForDateRange(selectedDate);
            var datesToDelete = [];
            
            if (camping) {
                var start = new Date(camping.startDate);
                var end = new Date(camping.endDate);
                for (var d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    datesToDelete.push(formatDate(new Date(d)));
                }
            } else {
                datesToDelete.push(selectedDate);
            }
            
            var deletePromises = [];
            for (var i = 0; i < datesToDelete.length; i++) {
                var dateStr = datesToDelete[i];
                for (var j = 0; j < schedules.length; j++) {
                    if (schedules[j].date === dateStr && schedules[j].userId === currentUser.id) {
                        deletePromises.push(db.collection('schedules').doc(schedules[j].id).delete());
                    }
                }
            }
            
            Promise.all(deletePromises).then(function() {
                showModal = false;
                selectedDate = null;
                render();
            });
        };
        window.openCampingDetail = function(campingId) {
            selectedCamping = campings.find(function(c) { return c.id === campingId; });
            if (selectedCamping) {
                showCampingDetail = true;
                showModal = false;
                render();
            }
        };

        window.closeCampingDetail = function() {
            showCampingDetail = false;
            selectedCamping = null;
            render();
        };

        window.openCampingModal = function(dateStr, campingId) {
            if (campingId) {
                editingCamping = campings.find(function(c) { return c.id === campingId; });
            } else {
                editingCamping = null;
            }
            selectedDate = dateStr;
            showCampingModal = true;
            showCampingDetail = false;
            render();
        };

        window.closeCampingModal = function() {
            showCampingModal = false;
            editingCamping = null;
            render();
        };

        window.saveCamping = function() {
            var name = document.getElementById('campingName').value.trim();
            var startDate = document.getElementById('campingStartDate').value;
            var endDate = document.getElementById('campingEndDate').value;
            var address = document.getElementById('campingAddress').value.trim();
            var website = document.getElementById('campingWebsite').value.trim();
            var info = document.getElementById('campingInfo').value.trim();

            if (!name || !startDate || !endDate) {
                alert('ìº í•‘ì¥ ì´ë¦„ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì•ì„œì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            var data = {
                name: name,
                startDate: startDate,
                endDate: endDate,
                address: address,
                website: website,
                info: info,
                createdBy: currentUser.id,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (editingCamping) {
                db.collection('campings').doc(editingCamping.id).update(data).then(function() {
                    showCampingModal = false;
                    editingCamping = null;
                    render();
                });
            } else {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                db.collection('campings').add(data).then(function() {
                    showCampingModal = false;
                    render();
                });
            }
        };

        window.deleteCamping = function(campingId, createdBy) {
            if (createdBy !== currentUser.id) {
                alert('ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                db.collection('campings').doc(campingId).delete().then(function() {
                    showCampingDetail = false;
                    showCampingModal = false;
                    selectedCamping = null;
                    editingCamping = null;
                    render();
                });
            }
        };
        function render() {
            var app = document.getElementById('app');

            if (!currentUser) {
                var loginModalHtml = '';
                if (showLoginModal) {
                    var colorNotice = isSignUp ? '<div class="text-xs text-blue-700 bg-blue-50 p-3 rounded border border-blue-200">ğŸ¨ ìƒ‰ìƒì€ ê°€ì… ìˆœì„œëŒ€ë¡œ ìë™ìœ¼ë¡œ ë°°ì •ë©ë‹ˆë‹¤</div>' : '';
                    
                    loginModalHtml = '<div class="fixed inset-0 bg-black/60 z-50 flex items-end" onclick="if(event.target===this)closeLoginModal()">' +
                        '<div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up max-h-[90vh] overflow-y-auto">' +
                            '<div class="flex justify-between items-center mb-5">' +
                                '<h3 class="text-xl font-bold">' + (isSignUp ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸') + '</h3>' +
                                '<button onclick="closeLoginModal()" class="text-3xl text-gray-500">Ã—</button>' +
                            '</div>' +
                            '<div class="space-y-4">' +
                                '<div>' +
                                    '<label class="block text-sm mb-2 font-bold">íŒ€ ì´ë¦„</label>' +
                                    '<input type="text" id="authTeamName" placeholder="ì˜ˆ) ì„œí•˜ë„¤, ë‹¤ì€ì´ë„¤" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg">' +
                                '</div>' +
                                '<div>' +
                                    '<label class="block text-sm mb-2 font-bold">íœ´ëŒ€í° ë²ˆí˜¸</label>' +
                                    '<input type="tel" id="authPhone" placeholder="010-1234-5678" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg">' +
                                '</div>' +
                                colorNotice +
                                '<button onclick="handleAuth()" class="w-full py-3 bg-green-600 text-white rounded-lg font-bold">' + (isSignUp ? 'ê°€ì…í•˜ê¸°' : 'ë¡œê·¸ì¸') + '</button>' +
                                '<button onclick="toggleAuthMode()" class="w-full text-sm text-gray-600">' + (isSignUp ? 'ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”? ë¡œê·¸ì¸' : 'ê³„ì •ì´ ì—†ë‚˜ìš”? íšŒì›ê°€ì…') + '</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }

                app.innerHTML = '<div class="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-b from-green-400 to-blue-400">' +
                    '<div class="text-center mb-8">' +
                        '<h1 class="text-6xl mb-4">ğŸ•ï¸</h1>' +
                        '<h2 class="text-4xl font-bold text-white mb-2">ê°™ì´ ë†€ëŸ¬ê°€ì</h2>' +
                        '<p class="text-white/90 text-lg">ìš°ë¦¬ ê°€ì¡± ì¼ì •ì„ í•¨ê»˜ ê´€ë¦¬í•´ìš”</p>' +
                    '</div>' +
                    '<div class="w-full max-w-sm space-y-3">' +
                        '<button onclick="openLoginModal()" class="w-full py-4 bg-white rounded-2xl shadow-lg font-bold text-lg text-green-600">ë¡œê·¸ì¸</button>' +
                        '<button onclick="openSignUpModal()" class="w-full py-4 bg-white/20 rounded-2xl font-bold text-lg text-white border-2 border-white">íšŒì›ê°€ì…</button>' +
                    '</div>' +
                    loginModalHtml +
                '</div>';
                return;
            }
            var firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            var lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            var dates = [];
            
            for (var d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d));
            }

            var datesHtml = '';
            for (var idx = 0; idx < dates.length; idx++) {
                var date = dates[idx];
                var dateStr = formatDate(date);
                var dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                var isWeekend = date.getDay() === 0 || date.getDay() === 6;
                var isToday = dateStr === formatDate(new Date());
                var holiday = holidays[dateStr];
                
                var camping = getCampingForDateRange(dateStr);
                var dateSchedules = schedules.filter(function(s) { return s.date === dateStr; });

                var attendingUsers = dateSchedules.filter(function(s) { return s.title === 'ì°¸ì„'; });
                var notAttendingUsers = dateSchedules.filter(function(s) { return s.title === 'ë¶ˆì°¸'; });
                var pendingUsers = dateSchedules.filter(function(s) { return s.title === 'ë³´ë¥˜'; });

                var membersStatusHtml = '';
                var chunks = [];
                for (var i = 0; i < allUsers.length; i += 3) {
                    chunks.push(allUsers.slice(i, i + 3));
                }
                
                for (var c = 0; c < chunks.length; c++) {
                    var chunk = chunks[c];
                    membersStatusHtml += '<div class="flex gap-1 mt-2">';
                    
                    for (var m = 0; m < chunk.length; m++) {
                        var member = chunk[m];
                        var userSchedule = dateSchedules.find(function(s) { return s.userId === member.id; });
                        var bgColor = 'bg-gray-100';
                        var textColor = 'text-gray-400';
                        
                        if (userSchedule) {
                            if (userSchedule.title === 'ì°¸ì„') {
                                bgColor = 'bg-green-100';
                                textColor = 'text-green-700';
                            } else if (userSchedule.title === 'ë³´ë¥˜') {
                                bgColor = 'bg-yellow-100';
                                textColor = 'text-yellow-700';
                            } else {
                                bgColor = 'bg-red-100';
                                textColor = 'text-red-700';
                            }
                        }
                        
                        membersStatusHtml += '<div class="flex-1 text-center py-1 rounded text-xs ' + bgColor + ' ' + textColor + ' font-medium">' + escapeHtml(member.name) + '</div>';
                    }
                    
                    var emptySlots = 3 - chunk.length;
                    for (var e = 0; e < emptySlots; e++) {
                        membersStatusHtml += '<div class="flex-1 py-1 rounded bg-gray-50 border border-gray-200"></div>';
                    }
                    membersStatusHtml += '</div>';
                }

                var statusSummary = '';
                if (attendingUsers.length > 0 || notAttendingUsers.length > 0 || pendingUsers.length > 0) {
                    statusSummary = '<div class="text-xs text-gray-600 mt-2">';
                    if (attendingUsers.length > 0) {
                        statusSummary += '<span class="text-green-600">ğŸ‘ ' + attendingUsers.length + 'ëª…</span>';
                    }
                    if (pendingUsers.length > 0) {
                        statusSummary += (attendingUsers.length > 0 ? ' Â· ' : '') + '<span class="text-yellow-600">â¸ï¸ ' + pendingUsers.length + 'ëª…</span>';
                    }
                    if (notAttendingUsers.length > 0) {
                        statusSummary += ((attendingUsers.length > 0 || pendingUsers.length > 0) ? ' Â· ' : '') + '<span class="text-red-600">ğŸ‘ ' + notAttendingUsers.length + 'ëª…</span>';
                    }
                    statusSummary += '</div>';
                }

                var campingHtml = '';
                if (camping) {
                    campingHtml = '<div onclick="openCampingDetail(\'' + camping.id + '\')" class="mt-2 bg-yellow-50 border border-yellow-200 rounded-lg p-2 cursor-pointer active:bg-yellow-100">' +
                        '<div class="flex items-center gap-2">' +
                            '<span class="text-lg">ğŸ•ï¸</span>' +
                            '<div class="flex-1 min-w-0">' +
                                '<div class="font-bold text-sm text-yellow-900 truncate">' + escapeHtml(camping.name) + '</div>' +
                                '<div class="text-xs text-yellow-700">' + camping.startDate + ' ~ ' + camping.endDate + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }

                var holidayHtml = holiday ? '<div class="text-xs text-red-500 font-medium mt-1">' + holiday + '</div>' : '';
                var todayBadge = isToday ? '<span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full ml-1">ì˜¤ëŠ˜</span>' : '';

                datesHtml += '<div class="bg-white rounded-xl p-4 shadow-sm border-2 ' + (isToday ? 'border-green-500' : 'border-transparent') + '">' +
                    '<div class="flex items-center justify-between mb-2">' +
                        '<div>' +
                            '<div class="flex items-center gap-2">' +
                                '<span class="text-2xl font-bold ' + (isWeekend || holiday ? 'text-red-500' : 'text-gray-800') + '">' + date.getDate() + '</span>' +
                                '<span class="text-sm ' + (isWeekend || holiday ? 'text-red-500' : 'text-gray-500') + '">' + dayOfWeek + '</span>' +
                                todayBadge +
                            '</div>' +
                            holidayHtml +
                            campingHtml +
                        '</div>' +
                        '<div class="flex flex-col gap-1">' +
                            '<button onclick="openAddModal(\'' + dateStr + '\')" class="text-blue-600 font-bold text-xl px-2">+</button>' +
                            (camping ? '' : '<button onclick="openCampingModal(\'' + dateStr + '\', null)" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-medium">ë“±ë¡</button>') +
                        '</div>' +
                    '</div>' +
                    membersStatusHtml +
                    statusSummary +
                '</div>';
            }
            var modalHtml = '';
            if (showModal) {
                var mySchedule = schedules.find(function(s) { return s.date === selectedDate && s.userId === currentUser.id; });
                var modalContent = '';
                
                if (mySchedule) {
                    modalContent = '<div class="space-y-3">' +
                        '<div class="p-4 bg-blue-50 rounded-lg">' +
                            '<div class="text-sm text-gray-600 mb-1">í˜„ì¬ ìƒíƒœ</div>' +
                            '<div class="text-lg font-bold text-blue-600">' + mySchedule.title + '</div>' +
                        '</div>' +
                        '<div class="grid grid-cols-3 gap-2">' +
                            '<button onclick="setStatus(\'ì°¸ì„\')" class="py-3 bg-green-600 text-white rounded-lg font-medium">ì°¸ì„</button>' +
                            '<button onclick="setStatus(\'ë³´ë¥˜\')" class="py-3 bg-yellow-600 text-white rounded-lg font-medium">ë³´ë¥˜</button>' +
                            '<button onclick="setStatus(\'ë¶ˆì°¸\')" class="py-3 bg-red-600 text-white rounded-lg font-medium">ë¶ˆì°¸</button>' +
                        '</div>' +
                        '<button onclick="deleteStatus()" class="w-full py-3 border border-gray-300 rounded-lg font-medium text-gray-700 mt-2">ì‚­ì œ</button>' +
                    '</div>';
                } else {
                    modalContent = '<div class="grid grid-cols-3 gap-3">' +
                        '<button onclick="setStatus(\'ì°¸ì„\')" class="py-4 bg-green-600 text-white rounded-xl font-bold text-lg">ğŸ‘ ì°¸ì„</button>' +
                        '<button onclick="setStatus(\'ë³´ë¥˜\')" class="py-4 bg-yellow-600 text-white rounded-xl font-bold text-lg">â¸ï¸ ë³´ë¥˜</button>' +
                        '<button onclick="setStatus(\'ë¶ˆì°¸\')" class="py-4 bg-red-600 text-white rounded-xl font-bold text-lg">ğŸ‘ ë¶ˆì°¸</button>' +
                    '</div>';
                }
                
                modalHtml = '<div class="fixed inset-0 bg-black/50 z-40 flex items-end" onclick="if(event.target===this)closeModal()">' +
                    '<div class="bg-white w-full rounded-t-3xl p-5 animate-slide-up">' +
                        '<div class="flex justify-between items-center mb-4">' +
                            '<h3 class="text-xl font-bold">' + selectedDate + '</h3>' +
                            '<button onclick="closeModal()" class="text-3xl text-gray-500">Ã—</button>' +
                        '</div>' +
                        modalContent +
                    '</div>' +
                '</div>';
            }

            var campingDetailHtml = '';
            if (showCampingDetail && selectedCamping) {
                var addressHtml = selectedCamping.address ? '<div>ğŸ“ ' + escapeHtml(selectedCamping.address) + '</div>' : '';
                var websiteHtml = selectedCamping.website ? '<div>ğŸ”— <a href="' + selectedCamping.website + '" target="_blank" class="text-blue-600">' + escapeHtml(selectedCamping.website) + '</a></div>' : '';
                var infoHtml = selectedCamping.info ? '<div class="bg-gray-50 rounded-lg p-4"><h5 class="font-medium mb-2">ğŸ“ ì•ˆë‚´ì‚¬í•­</h5><div class="text-sm text-gray-700 whitespace-pre-wrap">' + escapeHtml(selectedCamping.info) + '</div></div>' : '';
                var editButtonHtml = selectedCamping.createdBy === currentUser.id ? '<button onclick="openCampingModal(\'' + selectedCamping.startDate + '\', \'' + selectedCamping.id + '\')" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium">ìˆ˜ì •</button>' : '';
                
                campingDetailHtml = '<div class="fixed inset-0 bg-black/50 z-40 flex items-end" onclick="if(event.target===this)closeCampingDetail()">' +
                    '<div class="bg-white w-full rounded-t-3xl p-5 max-h-[90vh] overflow-y-auto animate-slide-up">' +
                        '<div class="flex justify-between items-center mb-4">' +
                            '<h3 class="text-xl font-bold">ğŸ•ï¸ ìº í•‘ì¥ ì •ë³´</h3>' +
                            '<button onclick="closeCampingDetail()" class="text-3xl text-gray-500">Ã—</button>' +
                        '</div>' +
                        '<div class="space-y-4">' +
                            '<div class="bg-yellow-50 rounded-lg p-4">' +
                                '<h4 class="font-bold text-lg mb-2">' + escapeHtml(selectedCamping.name) + '</h4>' +
                                '<div class="text-sm text-gray-600 space-y-1">' +
                                    '<div>ğŸ“… ' + selectedCamping.startDate + ' ~ ' + selectedCamping.endDate + '</div>' +
                                    addressHtml +
                                    websiteHtml +
                                '</div>' +
                            '</div>' +
                            infoHtml +
                            '<div class="flex gap-2">' +
                                editButtonHtml +
                                '<button onclick="closeCampingDetail()" class="flex-1 py-3 border border-gray-300 rounded-lg font-medium">ë‹«ê¸°</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }

            var campingModalHtml = '';
            if (showCampingModal) {
                var deleteButtonHtml = '';
                if (editingCamping && editingCamping.createdBy === currentUser.id) {
                    deleteButtonHtml = '<div class="pt-4 border-t">' +
                        '<button onclick="deleteCamping(\'' + editingCamping.id + '\', \'' + editingCamping.createdBy + '\')" class="w-full py-2 bg-red-100 text-red-700 rounded-lg font-medium">ìº í•‘ì¥ ì •ë³´ ì‚­ì œ</button>' +
                    '</div>';
                }
                
                campingModalHtml = '<div class="fixed inset-0 bg-black/50 z-50 flex items-end" onclick="if(event.target===this)closeCampingModal()">' +
                    '<div class="bg-white w-full rounded-t-3xl p-5 max-h-[90vh] overflow-y-auto animate-slide-up">' +
                        '<div class="flex justify-between items-center mb-4">' +
                            '<h3 class="text-xl font-bold">ğŸ•ï¸ ìº í•‘ì¥ ' + (editingCamping ? 'ìˆ˜ì •' : 'ë“±ë¡') + '</h3>' +
                            '<button onclick="closeCampingModal()" class="text-3xl text-gray-500">Ã—</button>' +
                        '</div>' +
                        '<div class="space-y-4">' +
                            '<div>' +
                                '<label class="block text-sm mb-1 font-medium">ìº í•‘ì¥ ì´ë¦„ *</label>' +
                                '<input type="text" id="campingName" value="' + (editingCamping ? escapeHtml(editingCamping.name) : '') + '" placeholder="ë³„ë¹›ìº í•‘ì¥" class="w-full px-4 py-3 border rounded-lg">' +
                            '</div>' +
                            '<div class="grid grid-cols-2 gap-2">' +
                                '<div>' +
                                    '<label class="block text-sm mb-1 font-medium">ì‹œì‘ì¼ *</label>' +
                                    '<input type="date" id="campingStartDate" value="' + (editingCamping ? editingCamping.startDate : selectedDate || '') + '" class="w-full px-4 py-3 border rounded-lg">' +
                                '</div>' +
                                '<div>' +
                                    '<label class="block text-sm mb-1 font-medium">ì¢…ë£Œì¼ *</label>' +
                                    '<input type="date" id="campingEndDate" value="' + (editingCamping ? editingCamping.endDate : selectedDate || '') + '" class="w-full px-4 py-3 border rounded-lg">' +
                                '</div>' +
                            '</div>' +
                            '<div class="text-xs text-gray-500 bg-blue-50 p-2 rounded">ğŸ’¡ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„¤ì •í•˜ë©´ 2ë°•3ì¼, 3ë°•4ì¼ ë“±ì˜ ì¼ì •ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>' +
                            '<div>' +
                                '<label class="block text-sm mb-1">ì£¼ì†Œ</label>' +
                                '<input type="text" id="campingAddress" value="' + (editingCamping && editingCamping.address ? escapeHtml(editingCamping.address) : '') + '" placeholder="ê²½ê¸°ë„ ê°€í‰êµ°..." class="w-full px-4 py-3 border rounded-lg">' +
                            '</div>' +
                            '<div>' +
                                '<label class="block text-sm mb-1">ì›¹ì‚¬ì´íŠ¸</label>' +
                                '<input type="url" id="campingWebsite" value="' + (editingCamping && editingCamping.website ? escapeHtml(editingCamping.website) : '') + '" placeholder="https://..." class="w-full px-4 py-3 border rounded-lg">' +
                            '</div>' +
                            '<div>' +
                                '<label class="block text-sm mb-1">ì•ˆë‚´ ë° ë©”ëª¨</label>' +
                                '<textarea id="campingInfo" maxlength="2000" placeholder="ìº í•‘ì¥ íŠ¹ì§•, ì£¼ì˜ì‚¬í•­ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš” (ìµœëŒ€ 2000ì)" class="w-full px-4 py-3 border rounded-lg resize-none" rows="5">' + (editingCamping && editingCamping.info ? escapeHtml(editingCamping.info) : '') + '</textarea>' +
                            '</div>' +
                            '<div class="flex gap-2 pt-2">' +
                                '<button onclick="closeCampingModal()" class="flex-1 py-3 border rounded-lg font-medium">ì·¨ì†Œ</button>' +
                                '<button onclick="saveCamping()" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium">ì €ì¥</button>' +
                            '</div>' +
                            deleteButtonHtml +
                        '</div>' +
                    '</div>' +
                '</div>';
            }
            var myColor = colorPalette[currentUser.colorIndex];

            app.innerHTML = '<div class="min-h-screen pb-20">' +
                '<div class="sticky top-0 z-10 bg-green-600 text-white shadow-lg">' +
                    '<div class="p-4">' +
                        '<div class="flex items-center justify-between mb-3">' +
                            '<div>' +
                                '<h1 class="text-2xl font-bold">ğŸ•ï¸ ê°™ì´ ë†€ëŸ¬ê°€ì</h1>' +
                            '</div>' +
                            '<button onclick="logout()" class="text-xs bg-white/20 px-3 py-1 rounded-full">ë¡œê·¸ì•„ì›ƒ</button>' +
                        '</div>' +
                        '<div class="flex items-center justify-between">' +
                            '<button onclick="changeMonth(-1)" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30">â†</button>' +
                            '<h2 class="text-xl font-bold">' + getMonthYear() + '</h2>' +
                            '<button onclick="changeMonth(1)" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30">â†’</button>' +
                        '</div>' +
                        '<div class="mt-2 flex items-center gap-2">' +
                            '<div class="w-3 h-3 rounded-full" style="background-color:' + myColor + '"></div>' +
                            '<span class="text-sm">' + escapeHtml(currentUser.name) + '</span>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="p-3 space-y-3">' + datesHtml + '</div>' +
                modalHtml +
                campingDetailHtml +
                campingModalHtml +
            '</div>';
        }

        function init() {
            db.collection('schedules').onSnapshot(function(snapshot) {
                schedules = [];
                snapshot.forEach(function(doc) {
                    schedules.push(Object.assign({ id: doc.id }, doc.data()));
                });
                render();
            });

            db.collection('campings').onSnapshot(function(snapshot) {
                campings = [];
                snapshot.forEach(function(doc) {
                    campings.push(Object.assign({ id: doc.id }, doc.data()));
                });
                render();
            });
        }

        db.collection('users').onSnapshot(function(snapshot) {
            allUsers = [];
            snapshot.forEach(function(doc) {
                var userData = doc.data();
                allUsers.push({
                    id: doc.id,
                    name: userData.name,
                    phone: userData.phone,
                    colorIndex: userData.colorIndex
                });
            });
            
            var saved = localStorage.getItem('currentUser');
            if (saved) {
                var savedUser = JSON.parse(saved);
                currentUser = allUsers.find(function(u) { return u.id === savedUser.id; });
                if (currentUser) {
                    init();
                } else {
                    localStorage.removeItem('currentUser');
                    render();
                }
            } else {
                render();
            }
        });
    </script>
</body>
</html>
