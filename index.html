<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ê°™ì´ ë†€ëŸ¬ê°€ì ğŸ•ï¸</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior-y: contain; }

    @keyframes slideUp { from { transform: translateY(100%);} to { transform: translateY(0);} }
    .animate-slide-up { animation: slideUp 0.3s ease-out; }
    input, textarea, select { font-size: 16px !important; }

    /* ë‚ ì§œ ì…ë ¥ UI */
    .date-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }
    .date-input { width: 100%; min-width: 0; display: block; }
    input[type="date"]::-webkit-date-and-time-value { min-height: 1.6em; }
    @media (max-width: 360px) { .date-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAu15qibhSy3rBEUYXOxRCqoBf-BlpLtJg",
      authDomain: "camp-4cd5d.firebaseapp.com",
      projectId: "camp-4cd5d",
      storageBucket: "camp-4cd5d.firebasestorage.app",
      messagingSenderId: "322221151055",
      appId: "1:322221151055:web:bf81c9f9310b4daf4f6b3a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const colorPalette = ['#6366f1','#ec4899','#10b981','#f59e0b','#8b5cf6','#06b6d4','#f97316','#14b8a6','#a855f7','#ef4444','#3b82f6','#84cc16'];

    let currentUser=null, allUsers=[], schedules=[], campings=[];
    let showModal=false, selectedDate=null, showCampingDetail=false, selectedCamping=null, showCampingModal=false, editingCamping=null;
    let currentMonth=new Date(), showLoginModal=false, isSignUp=false;
    let needScrollToToday=false;

    const normalizePhone = (v)=> (v||'').replace(/\D/g,'');
    function formatDate(date){const y=date.getFullYear();const m=String(date.getMonth()+1).padStart(2,'0');const d=String(date.getDate()).padStart(2,'0');return `${y}-${m}-${d}`;}
    function escapeHtml(text){if(!text)return'';return String(text).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function getCampingForDateRange(dateStr){for(let c of campings){if(dateStr>=c.startDate && dateStr<=c.endDate)return c;}return null;}
    function getDaysDiffInclusive(s,e){return Math.floor((new Date(e)-new Date(s))/(1000*60*60*24))+1;}
    function getMonthYear(){return `${currentMonth.getFullYear()}ë…„ ${currentMonth.getMonth()+1}ì›”`;}

    function scrollTodayIntoView(){
      const id=`day-${formatDate(new Date())}`;
      const el=document.getElementById(id);
      if(!el)return;
      el.scrollIntoView({behavior:'auto',block:'start'});
      const header=document.querySelector('.app-header');
      if(header)window.scrollBy(0,-(header.getBoundingClientRect().height+8));
    }

    window.goToToday=()=>{currentMonth=new Date();needScrollToToday=true;render();};
    window.changeMonth=(d)=>{currentMonth=new Date(currentMonth.getFullYear(),currentMonth.getMonth()+d,1);render();};

    window.openLoginModal=()=>{showLoginModal=true;isSignUp=false;render();};
    window.openSignUpModal=()=>{showLoginModal=true;isSignUp=true;render();};
    window.closeLoginModal=()=>{showLoginModal=false;isSignUp=false;render();};
    window.toggleAuthMode=()=>{isSignUp=!isSignUp;render();};

    window.handleAuth=()=>{
      const team=document.getElementById('authTeamName').value.trim();
      const phone=normalizePhone(document.getElementById('authPhone').value.trim());
      if(!team||!phone)return alert('íŒ€ ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      if(isSignUp){
        db.collection('users').where('phone','==',phone).get().then(r=>{
          if(!r.empty)return alert('ì´ë¯¸ ê°€ì…ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.');
          const colorIndex=allUsers.length%colorPalette.length;
          return db.collection('users').add({name:team,phone,colorIndex});
        }).then(doc=>{
          if(!doc)return;
          currentUser={id:doc.id,name:team,phone,colorIndex:allUsers.length%colorPalette.length};
          localStorage.setItem('currentUser',JSON.stringify(currentUser));
          showLoginModal=false;needScrollToToday=true;init();render();
        });
      }else{
        db.collection('users').where('name','==',team).where('phone','==',phone).get().then(s=>{
          if(s.empty)return alert('íšŒì›ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
          const u=s.docs[0];currentUser={id:u.id,...u.data()};
          localStorage.setItem('currentUser',JSON.stringify(currentUser));
          showLoginModal=false;needScrollToToday=true;init();render();
        });
      }
    };

    window.logout=()=>{currentUser=null;localStorage.removeItem('currentUser');render();};

    window.openCampingModal=(d)=>{selectedDate=d;showCampingModal=true;render();};
    window.closeCampingModal=()=>{showCampingModal=false;render();};
    window.saveCamping=()=>{
      const name=document.getElementById('campingName').value.trim();
      const start=document.getElementById('campingStartDate').value;
      const end=document.getElementById('campingEndDate').value;
      if(!name||!start||!end)return alert('ì´ë¦„ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      const data={name,startDate:start,endDate:end,createdBy:currentUser.id};
      db.collection('campings').add(data).then(()=>{showCampingModal=false;render();});
    };

    function render(){
      const app=document.getElementById('app');
      if(!currentUser){
        let modal='';
        if(showLoginModal){
          modal=`<div class='fixed inset-0 bg-black/60 flex items-end' onclick='if(event.target===this)closeLoginModal()'>
          <div class='bg-white w-full rounded-t-3xl p-6 animate-slide-up'>
            <h3 class='text-xl font-bold mb-4'>${isSignUp?'íšŒì›ê°€ì…':'ë¡œê·¸ì¸'}</h3>
            <input id='authTeamName' placeholder='íŒ€ ì´ë¦„' class='w-full border p-2 rounded mb-3'>
            <input id='authPhone' placeholder='íœ´ëŒ€í° ë²ˆí˜¸' class='w-full border p-2 rounded mb-3'>
            <button onclick='handleAuth()' class='w-full py-2 bg-green-600 text-white rounded-lg'>${isSignUp?'ê°€ì…':'ë¡œê·¸ì¸'}</button>
          </div></div>`;
        }

        app.innerHTML=`
        <div class='min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-green-400 to-blue-400 p-6'>
          <h1 class='text-5xl mb-4 text-white font-bold'>ê°™ì´ ë†€ëŸ¬ê°€ì</h1>
          <div class='w-full max-w-sm space-y-3'>
            <button onclick='openLoginModal()' class='w-full py-4 bg-white rounded-xl font-bold text-green-600 shadow'>ë¡œê·¸ì¸</button>
            <button onclick='openSignUpModal()' class='w-full py-4 bg-transparent border-2 border-white rounded-xl text-white font-bold'>íšŒì›ê°€ì…</button>
          </div>
          ${modal}
        </div>`;
        return;
      }

      const first=new Date(currentMonth.getFullYear(),currentMonth.getMonth(),1);
      const last=new Date(currentMonth.getFullYear(),currentMonth.getMonth()+1,0);
      const dates=[];for(let d=new Date(first);d<=last;d.setDate(d.getDate()+1))dates.push(new Date(d));
      let html='';
      for(const date of dates){
        const dateStr=formatDate(date);
        const camping=getCampingForDateRange(dateStr);
        const isToday=dateStr===formatDate(new Date());
        const multi=(camping&&getDaysDiffInclusive(camping.startDate,camping.endDate)>1)?' ring-2 ring-green-400':'';
        const border=isToday?' border-green-500':' border-transparent';
        html+=`<div id="day-${dateStr}" class="bg-white rounded-xl p-4 shadow-sm border-2${border}${multi}">
        <div class="flex justify-between items-center mb-2"><div><div class="text-xl font-bold">${date.getDate()}</div></div>
        <button onclick="openCampingModal('${dateStr}', null)" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">ë“±ë¡</button></div></div>`;
      }

      app.innerHTML=`<div class="min-h-screen">
      <div class="app-header bg-green-600 text-white shadow-lg">
      <div class="p-4 flex justify-between items-center">
      <div class="flex items-center justify-between">
        <button onclick="changeMonth(-1)" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30">â†</button>
        <h2 class="text-xl font-bold">${getMonthYear()}</h2>
        <button onclick="changeMonth(1)" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30">â†’</button>
      </div>
      <button onclick="goToToday()" class="px-3 py-1 bg-white text-green-700 rounded text-sm font-semibold">Today</button>
      </div></div><div class="p-3 space-y-3">${html}</div></div>`;

      if(needScrollToToday){needScrollToToday=false;requestAnimationFrame(scrollTodayIntoView);}
    }

    function init(){
      db.collection('schedules').onSnapshot(s=>{schedules=[];s.forEach(d=>schedules.push({id:d.id,...d.data()}));render();});
      db.collection('campings').onSnapshot(s=>{campings=[];s.forEach(d=>campings.push({id:d.id,...d.data()}));render();});
    }

    const saved=localStorage.getItem('currentUser');
    if(saved){try{currentUser=JSON.parse(saved);needScrollToToday=true;init();render();}catch(e){render();}}
    else render();

    db.collection('users').onSnapshot(s=>{allUsers=[];s.forEach(d=>allUsers.push({id:d.id,...d.data()}));render();});
  </script>
</body>
</html>
