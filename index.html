<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ìº í•‘ ìŠ¤ì¼€ì¤„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce { animation: bounce 1.5s infinite; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="fixed inset-0 bg-gradient-to-b from-indigo-600 via-purple-600 to-pink-500 flex flex-col items-center justify-center">
            <div class="text-center">
                <div class="text-8xl mb-6 animate-pulse">â›º</div>
                <div class="flex items-end justify-center gap-4 mb-6">
                    <div class="text-4xl animate-bounce" style="animation-delay: 0s">ğŸ§</div>
                    <div class="text-6xl">ğŸ”¥</div>
                    <div class="text-4xl animate-bounce" style="animation-delay: 0.3s">ğŸ§</div>
                </div>
                <h2 class="text-3xl font-bold text-white mb-2">ìº í•‘ ìŠ¤ì¼€ì¤„</h2>
                <p class="text-white/80 text-sm">ë¡œë”© ì¤‘...</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/firebase@8.10.1/firebase-app.js"></script>
    <script src="https://unpkg.com/firebase@8.10.1/firebase-firestore.js"></script>
    
    <script>
        console.log("ì•± ì‹œì‘");
        
        setTimeout(function() {
            if (typeof firebase === 'undefined') {
                document.getElementById('app').innerHTML = '<div class="p-6 text-center"><div class="text-red-600 text-xl font-bold">Firebase ë¡œë“œ ì‹¤íŒ¨</div><button onclick="location.reload()" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg">ë‹¤ì‹œ ì‹œë„</button></div>';
                return;
            }

            const firebaseConfig = {
                apiKey: "AIzaSyAu15qibhSy3rBEUYXOxRCqoBf-BlpLtJg",
                authDomain: "camp-4cd5d.firebaseapp.com",
                projectId: "camp-4cd5d",
                storageBucket: "camp-4cd5d.firebasestorage.app",
                messagingSenderId: "322221151055",
                appId: "1:322221151055:web:bf81c9f9310b4daf4f6b3a"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            
            let users = [];
            let schedules = [];
            let campings = [];
            let notes = [];
            let currentUser = JSON.parse(localStorage.getItem('campingUser') || 'null');
            let showLoading = !!currentUser;
            let selectedDate = null;
            let showModal = false;
            let showAuthModal = false;
            let showCampingModal = false;
            let showDetailPage = false;
            let authMode = 'login';
            let editingCamping = null;

            const familyColors = { 0: '#3b82f6', 1: '#ef4444', 2: '#10b981' };

            db.collection('users').onSnapshot(function(s) {
                users = [];
                s.forEach(function(d) { users.push({id: d.id, ...d.data()}); });
                render();
            });

            db.collection('schedules').onSnapshot(function(s) {
                schedules = [];
                s.forEach(function(d) { schedules.push({id: d.id, ...d.data()}); });
                render();
            });

            db.collection('campings').onSnapshot(function(s) {
                campings = [];
                s.forEach(function(d) { campings.push({id: d.id, ...d.data()}); });
                render();
            });

            db.collection('notes').onSnapshot(function(s) {
                notes = [];
                s.forEach(function(d) { notes.push({id: d.id, ...d.data()}); });
                render();
            });

            if (showLoading) {
                setTimeout(function() { showLoading = false; render(); }, 2000);
            }

            function getNext30Days() {
                var dates = [], today = new Date();
                for (var i = 0; i < 30; i++) {
                    var d = new Date(today);
                    d.setDate(today.getDate() + i);
                    dates.push(d);
                }
                return dates;
            }

            function formatDate(d) {
                return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            }

            function formatDateKo(d) {
                var days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                return (d.getMonth() + 1) + '/' + d.getDate() + ' (' + days[d.getDay()] + ')';
            }

            function getDateColor(d) {
                var day = d.getDay();
                return day === 0 ? 'text-red-600' : day === 6 ? 'text-blue-600' : 'text-gray-800';
            }

            window.openAuthModal = function(mode) {
                authMode = mode;
                showAuthModal = true;
                render();
            };

            window.closeAuthModal = function() {
                showAuthModal = false;
                render();
            };

            window.handleSignup = function() {
                var name = document.getElementById('signupName').value.trim();
                var phone = document.getElementById('signupPhone').value.trim();
                if (!name || !phone) return alert('ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (users.some(function(u) { return u.phone === phone; })) return alert('ì´ë¯¸ ê°€ì…ë¨');
                if (users.length >= 3) return alert('ì •ì› ë§ˆê°');
                
                db.collection('users').add({
                    name: name, phone: phone, colorIndex: users.length, createdAt: new Date().toISOString()
                }).then(function(ref) {
                    currentUser = {id: ref.id, name: name, phone: phone, colorIndex: users.length};
                    localStorage.setItem('campingUser', JSON.stringify(currentUser));
                    showLoading = true;
                    closeAuthModal();
                    render();
                    setTimeout(function() { showLoading = false; render(); }, 2000);
                });
            };

            window.handleLogin = function() {
                var name = document.getElementById('loginName').value.trim();
                var phone = document.getElementById('loginPhone').value.trim();
                if (!name || !phone) return alert('ì…ë ¥í•´ì£¼ì„¸ìš”');
                
                var found = users.find(function(u) { return u.name === name && u.phone === phone; });
                if (found) {
                    currentUser = found;
                    localStorage.setItem('campingUser', JSON.stringify(currentUser));
                    showLoading = true;
                    closeAuthModal();
                    render();
                    setTimeout(function() { showLoading = false; render(); }, 2000);
                } else {
                    alert('íšŒì› ì •ë³´ ì—†ìŒ');
                }
            };

            window.logout = function() {
                if (confirm('ë¡œê·¸ì•„ì›ƒ?')) {
                    currentUser = null;
                    localStorage.removeItem('campingUser');
                    render();
                }
            };

            window.openAddModal = function(dateStr) {
                if (!currentUser) return openAuthModal('login');
                selectedDate = dateStr;
                showModal = true;
                render();
            };

            window.closeModal = function() {
                showModal = false;
                selectedDate = null;
                render();
            };

            window.openCampingModal = function(dateStr, camping) {
                if (!currentUser) return alert('ë¡œê·¸ì¸ í•„ìš”');
                selectedDate = dateStr;
                editingCamping = camping || null;
                showCampingModal = true;
                render();
            };

            window.closeCampingModal = function() {
                showCampingModal = false;
                editingCamping = null;
                render();
            };

            window.saveCamping = function() {
                var name = document.getElementById('campingName').value.trim();
                var address = document.getElementById('campingAddress').value.trim();
                var website = document.getElementById('campingWebsite').value.trim();
                if (!name) return alert('ì´ë¦„ í•„ìˆ˜');

                var data = {
                    date: selectedDate, name: name, address: address, website: website,
                    createdBy: currentUser.id, createdByName: currentUser.name
                };

                if (editingCamping) {
                    if (editingCamping.createdBy !== currentUser.id) return alert('ê¶Œí•œ ì—†ìŒ');
                    db.collection('campings').doc(editingCamping.id).update(data).then(closeCampingModal);
                } else {
                    db.collection('campings').add(data).then(closeCampingModal);
                }
            };

            window.setStatus = function(status) {
                if (!currentUser || !selectedDate) return;
                
                var existing = schedules.find(function(s) { return s.date === selectedDate && s.userId === currentUser.id; });
                var data = {
                    title: status, date: selectedDate, userId: currentUser.id,
                    userName: currentUser.name, color: familyColors[currentUser.colorIndex]
                };

                if (existing) {
                    db.collection('schedules').doc(existing.id).update(data).then(closeModal);
                } else {
                    db.collection('schedules').add(data).then(closeModal);
                }
            };

            window.deleteStatus = function(id) {
                if (confirm('ì‚­ì œ?')) db.collection('schedules').doc(id).delete();
            };

            window.openDetailPage = function(dateStr) {
                selectedDate = dateStr;
                showDetailPage = true;
                render();
            };

            window.closeDetailPage = function() {
                showDetailPage = false;
                selectedDate = null;
                render();
            };

            window.addNote = function(userId) {
                var input = document.getElementById('noteInput-' + userId);
                var content = input.value.trim();
                if (!content) return;

                db.collection('notes').add({
                    date: selectedDate, userId: userId, content: content, createdAt: new Date().toISOString()
                }).then(function() { input.value = ''; });
            };

            window.deleteNote = function(id, userId) {
                if (userId !== currentUser.id) return alert('ê¶Œí•œ ì—†ìŒ');
                if (confirm('ì‚­ì œ?')) db.collection('notes').doc(id).delete();
            };

            function render() {
                var app = document.getElementById('app');

                if (showLoading) {
                    app.innerHTML = '<div class="fixed inset-0 bg-gradient-to-b from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center"><div class="text-center"><div class="text-9xl mb-6 animate-pulse">â›º</div><div class="flex items-end justify-center gap-6 mb-8"><div class="text-5xl animate-bounce">ğŸ§</div><div class="text-7xl">ğŸ”¥</div><div class="text-5xl animate-bounce" style="animation-delay:0.3s">ğŸ§</div></div><h2 class="text-3xl font-bold text-white">ìº í•‘ ìŠ¤ì¼€ì¤„</h2></div></div>';
                    return;
                }

                if (!currentUser) {
                    app.innerHTML = '<div class="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-b from-green-400 to-blue-400"><div class="text-center mb-8"><h1 class="text-6xl mb-4">ğŸ•ï¸</h1><h2 class="text-3xl font-bold text-white mb-2">ìº í•‘ ìŠ¤ì¼€ì¤„</h2><p class="text-white/90">ê°€ì¡±ë“¤ê³¼ ìº í•‘ ì¼ì •ì„ ê³µìœ í•˜ì„¸ìš”</p></div><div class="w-full max-w-sm space-y-3"><button onclick="openAuthModal(\'login\')" class="w-full py-4 bg-white text-green-700 rounded-lg font-bold text-lg shadow-lg">ë¡œê·¸ì¸</button><button onclick="openAuthModal(\'signup\')" class="w-full py-4 bg-green-600 text-white rounded-lg font-bold text-lg shadow-lg">íšŒì›ê°€ì…</button></div><div class="mt-8 text-sm text-white"><p>í˜„ì¬: ' + users.length + '/3 ê°€ì¡±</p></div></div>' + (showAuthModal ? '<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-2xl p-6"><h3 class="text-2xl font-bold mb-6 text-center">' + (authMode === 'login' ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…') + '</h3>' + (authMode === 'signup' ? '<div class="space-y-4"><div><label class="block text-sm font-medium mb-1">ê°€ì¡±ëª…</label><input type="text" id="signupName" placeholder="ê¹€ì”¨ë„¤" class="w-full px-4 py-3 border rounded-lg"></div><div><label class="block text-sm font-medium mb-1">ì „í™”ë²ˆí˜¸</label><input type="tel" id="signupPhone" placeholder="01012345678" class="w-full px-4 py-3 border rounded-lg"></div><button onclick="handleSignup()" class="w-full py-3 bg-green-600 text-white rounded-lg font-bold">ê°€ì…</button><button onclick="openAuthModal(\'login\')" class="w-full py-3 border rounded-lg">ë¡œê·¸ì¸ìœ¼ë¡œ</button></div>' : '<div class="space-y-4"><div><label class="block text-sm font-medium mb-1">ê°€ì¡±ëª…</label><input type="text" id="loginName" placeholder="ê¹€ì”¨ë„¤" class="w-full px-4 py-3 border rounded-lg"></div><div><label class="block text-sm font-medium mb-1">ì „í™”ë²ˆí˜¸</label><input type="tel" id="loginPhone" placeholder="01012345678" class="w-full px-4 py-3 border rounded-lg"></div><button onclick="handleLogin()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold">ë¡œê·¸ì¸</button><button onclick="openAuthModal(\'signup\')" class="w-full py-3 border rounded-lg">íšŒì›ê°€ì…ìœ¼ë¡œ</button></div>') + '</div></div>' : '');
                    return;
                }

                if (showDetailPage && selectedDate) {
                    var dateSchedules = schedules.filter(function(s) { return s.date === selectedDate; });
                    var camping = campings.find(function(c) { return c.date === selectedDate; });
                    var dateNotes = notes.filter(function(n) { return n.date === selectedDate; });
                    var dateObj = new Date(selectedDate + 'T00:00:00');
                    var attendingUsers = users.filter(function(u) {
                        var s = dateSchedules.find(function(ds) { return ds.userId === u.id; });
                        return s && s.title === 'ì°¸ì—¬';
                    });

                    app.innerHTML = '<div class="min-h-screen bg-gray-50"><div class="sticky top-0 z-10 bg-green-600 text-white shadow-lg p-4 flex items-center gap-3"><button onclick="closeDetailPage()" class="text-2xl">â†</button><h2 class="text-xl font-bold">' + formatDateKo(dateObj) + '</h2></div><div class="p-4 space-y-4"><div class="bg-white rounded-lg p-4 shadow"><h3 class="font-bold text-lg mb-3">ğŸ•ï¸ ìº í•‘ì¥ ì •ë³´</h3>' + (camping ? '<div><div class="font-bold text-xl text-green-700">' + camping.name + '</div>' + (camping.address ? '<div class="text-sm text-gray-600 mt-2">ğŸ“ ' + camping.address + '</div>' : '') + (camping.website ? '<a href="' + camping.website + '" target="_blank" class="text-sm text-blue-600 underline block mt-2">ğŸ”— ì›¹ì‚¬ì´íŠ¸</a>' : '') + '<div class="text-xs text-gray-400 mt-2">ë“±ë¡: ' + camping.createdByName + '</div></div>' : '<div class="text-gray-400 text-center py-4">ë“±ë¡ëœ ìº í•‘ì¥ ì—†ìŒ</div>') + '</div><div class="bg-white rounded-lg p-4 shadow"><h3 class="font-bold text-lg mb-3">ğŸ“ ì¤€ë¹„ì‚¬í•­</h3>' + (attendingUsers.length > 0 ? '<div class="space-y-4">' + attendingUsers.map(function(u) {
                        var userNotes = dateNotes.filter(function(n) { return n.userId === u.id; });
                        var color = familyColors[u.colorIndex];
                        return '<div class="border-l-4 pl-3" style="border-color:' + color + '"><div class="font-bold mb-2">' + u.name + '</div><div class="space-y-2 mb-3">' + userNotes.map(function(n) {
                            return '<div class="flex items-start gap-2 group"><span style="color:' + color + '">â€¢</span><div class="flex-1 text-sm">' + n.content + '</div>' + (n.userId === currentUser.id ? '<button onclick="deleteNote(\'' + n.id + '\',\'' + n.userId + '\')" class="text-red-600 text-xs px-2 opacity-0 group-hover:opacity-100">ì‚­ì œ</button>' : '') + '</div>';
                        }).join('') + '</div>' + (u.id === currentUser.id ? '<div class="flex gap-2"><input type="text" id="noteInput-' + u.id + '" placeholder="ì¤€ë¹„í•  ê²ƒ" class="flex-1 px-3 py-2 border rounded-lg text-sm" onkeypress="if(event.key===\'Enter\')addNote(\'' + u.id + '\')"><button onclick="addNote(\'' + u.id + '\')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm">ì¶”ê°€</button></div>' : '') + '</div>';
                    }).join('') + '</div>' : '<div class="text-gray-400 text-center py-4">ì°¸ì—¬ ê°€ì¡± ì—†ìŒ</div>') + '</div></div></div>';
                    return;
                }

                var dates = getNext30Days();
                var today = new Date();
                var todayStr = formatDate(today);
                var myColor = familyColors[currentUser.colorIndex];

                var datesHtml = dates.map(function(date) {
                    var dateStr = formatDate(date);
                    var isToday = dateStr === todayStr;
                    var dateSchedules = schedules.filter(function(s) { return s.date === dateStr; });
                    var camping = campings.find(function(c) { return c.date === dateStr; });
                    var dateColor = getDateColor(date);
                    var isSunday = date.getDay() === 0;
                    var isSaturday = date.getDay() === 6;
                    var attendingCount = 0;

                    var membersHtml = '<div class="grid grid-cols-3 gap-1 mt-2">';
                    for (var j = 0; j < 3; j++) {
                        if (j < users.length) {
                            var user = users[j];
                            var status = dateSchedules.find(function(s) { return s.userId === user.id; });
                            var color = familyColors[user.colorIndex];
                            if (status) {
                                if (status.title === 'ì°¸ì—¬') attendingCount++;
                                var emoji = status.title === 'ì°¸ì—¬' ? 'âœ“' : status.title === 'ë¶ˆì°¸' ? 'âœ—' : '?';
                                membersHtml += '<div class="text-center py-2 rounded text-white text-sm font-bold" style="background-color:' + color + '"><div>' + emoji + '</div><div class="text-xs mt-1 truncate px-1">' + user.name + '</div></div>';
                            } else {
                                membersHtml += '<div class="text-center py-2 rounded bg-gray-200 text-gray-400 text-sm"><div>?</div><div class="text-xs mt-1 truncate px-1">' + user.name + '</div></div>';
                            }
                        } else {
                            membersHtml += '<div class="text-center py-2 rounded bg-gray-100 text-gray-300 text-xs">ë¹ˆìë¦¬</div>';
                        }
                    }
                    membersHtml += '</div>';

                    var summary = '';
                    if (attendingCount === users.length && users.length > 0) {
                        summary = '<div class="mt-2 text-center text-sm font-bold text-green-600">âœ“ ëª¨ë‘ ì°¸ì—¬!</div>';
                    } else if (attendingCount > 0) {
                        summary = '<div class="mt-2 text-center text-sm text-gray-600">' + attendingCount + 'ê°€ì¡± ì°¸ì—¬</div>';
                    }

                    return '<div class="bg-white rounded-lg p-4 shadow-sm border-2 ' + (isToday ? 'border-green-500' : isSunday ? 'border-red-200' : isSaturday ? 'border-blue-200' : 'border-gray-200') + '"><div class="flex items-center justify-between mb-2"><div class="flex-1" onclick="openDetailPage(\'' + dateStr + '\')"><div class="font-bold text-lg ' + (isToday ? 'text-green-600' : dateColor) + '">' + formatDateKo(date) + '</div>' + (camping ? '<div class="text-sm text-green-700 font-semibold mt-1">ğŸ•ï¸ ' + camping.name + '</div>' : '') + '</div><div class="flex gap-1">' + (!camping || camping.createdBy === currentUser.id ? '<button onclick="openCampingModal(\'' + dateStr + '\', ' + (camping ? 'JSON.parse(\'' + JSON.stringify(camping).replace(/'/g, "\\'") + '\')' : 'null') + ')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">' + (camping ? 'ìˆ˜ì •' : 'ë“±ë¡') + '</button>' : '') + '<button onclick="openAddModal(\'' + dateStr + '\')" class="text-blue-600 font-bold text-xl px-2">+</button></div></div>' + membersHtml + summary + '</div>';
                }).join('');

                app.innerHTML = '<div class="min-h-screen pb-20"><div class="sticky top-0 z-10 bg-green-600 text-white shadow-lg p-4"><div class="flex items-center justify-between"><div><h1 class="text-2xl font-bold">ğŸ•ï¸ ìº í•‘ ìŠ¤ì¼€ì¤„</h1><p class="text-sm text-green-100">ë‹¤ìŒ 30ì¼</p></div><button onclick="logout()" class="text-xs bg-white/20 px-3 py-1 rounded-full">ë¡œê·¸ì•„ì›ƒ</button></div><div class="mt-2 flex items-center gap-2"><div class="w-3 h-3 rounded-full" style="background-color:' + myColor + '"></div><span>' + currentUser.name + '</span></div></div><div class="p-3 space-y-3">' + datesHtml + '</div>' + (showModal ? '<div class="fixed inset-0 bg-black/50 z-50 flex items-end"><div class="bg-white w-full rounded-t-3xl p-5"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">' + formatDateKo(new Date(selectedDate + 'T00:00:00')) + '</h3><button onclick="closeModal()" class="text-3xl">Ã—</button></div><div><p class="text-sm mb-2">' + currentUser.name + ' ì°¸ì—¬ ì—¬ë¶€</p><div class="flex gap-2"><button onclick="setStatus(\'ì°¸ì—¬\')" class="flex-1 py-4 bg-green-600 text-white rounded-lg font-bold">âœ“ ì°¸ì—¬</button><button onclick="setStatus(\'ë¶ˆì°¸\')" class="flex-1 py-4 bg-red-600 text-white rounded-lg font-bold">âœ— ë¶ˆì°¸</button><button onclick="setStatus(\'ë³´ë¥˜\')" class="flex-1 py-4 bg-gray-600 text-white rounded-lg font-bold">? ë³´ë¥˜</button></div></div></div></div>' : '') + (showCampingModal ? '<div class="fixed inset-0 bg-black/50 z-50 flex items-end"><div class="bg-white w-full rounded-t-3xl p-5"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">ğŸ•ï¸ ìº í•‘ì¥ ' + (editingCamping ? 'ìˆ˜ì •' : 'ë“±ë¡') + '</h3><button onclick="closeCampingModal()" class="text-3xl">Ã—</button></div><div class="space-y-4"><div><label class="block text-sm mb-1">ì´ë¦„ *</label><input type="text" id="campingName" value="' + (editingCamping ? editingCamping.name : '') + '" class="w-full px-4 py-3 border rounded-lg"></div><div><label class="block text-sm mb-1">ì£¼ì†Œ</label><input type="text" id="campingAddress" value="' + (editingCamping ? editingCamping.address : '') + '" class="w-full px-4 py-3 border rounded-lg"></div><div><label class="block text-sm mb-1">ì›¹ì‚¬ì´íŠ¸</label><input type="url" id="campingWebsite" value="' + (editingCamping ? editingCamping.website : '') + '" class="w-full px-4 py-3 border rounded-lg"></div><div class="flex gap-2"><button onclick="closeCampingModal()" class="flex-1 py-3 border rounded-lg">ì·¨ì†Œ</button><button onclick="saveCamping()" class="flex-1 py-3 bg-green-600 text-white rounded-lg">ì €ì¥</button></div></div></div></div>' : '') + '</div>';
            }

        }, 1000);
    </script>
</body>
</html>
