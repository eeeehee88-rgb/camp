<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ê°™ì´ ë†€ëŸ¬ê°€ì ğŸ•ï¸</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior-y: contain; }
    @keyframes slideUp { from { transform: translateY(100%);} to { transform: translateY(0);} }
    .animate-slide-up { animation: slideUp 0.3s ease-out; }
    input, textarea, select { font-size: 16px !important; }

    /* ë‚ ì§œ ì…ë ¥ ê²¹ì¹¨ ë°©ì§€ (ëª¨ë°”ì¼ í™•ì‹¤íˆ ë¶„ë¦¬) */
    .date-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 1rem; 
    }
    .date-input { 
      width: 100%; 
      min-width: 140px; 
      display: block; 
      padding: 0.7rem 0.8rem; 
      font-size: 15px !important; 
    }
    input[type="date"]::-webkit-date-and-time-value { min-height: 1.6em; }
    @media (max-width: 420px) { 
      .date-grid { gap: 0.8rem; } 
      .date-input{ padding: 0.6rem 0.7rem; } 
    }
    @media (max-width: 360px) { 
      .date-grid { grid-template-columns: 1fr; } 
    }

    /* ëª¨ë‹¥ë¶ˆ ê¹œë¹¡ì„ íš¨ê³¼ */
    @keyframes flicker { 
      0%{opacity:0.9; transform:scale(1);} 
      50%{opacity:1; transform:scale(1.05);} 
      100%{opacity:0.9; transform:scale(0.97);} 
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script>
    /* =========================
       Firebase ì„¤ì • (camp-4cd5d)
       ========================= */
    const firebaseConfig = {
      apiKey: "AIzaSyAu15qibhSy3rBEUYXOxRCqoBf-BlpLtJg",
      authDomain: "camp-4cd5d.firebaseapp.com",
      projectId: "camp-4cd5d",
      storageBucket: "camp-4cd5d.firebasestorage.app",
      messagingSenderId: "322221151055",
      appId: "1:322221151055:web:bf81c9f9310b4daf4f6b3a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* =========================
       ë¡œë”© ì´ë¯¸ì§€ (base64 ì‚½ì…)
       ========================= */
    const splashImg = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoAAAAHgCAIAAAC2l9lHAA...<ì¤‘ëµ>...`;

    /* =========================
       ê¸°ë³¸ ì„¤ì • ë° ìƒíƒœ
       ========================= */
    const colorPalette = ['#6366f1','#ec4899','#10b981','#f59e0b','#8b5cf6','#06b6d4','#f97316','#14b8a6','#a855f7','#ef4444','#3b82f6','#84cc16'];
    let currentUser = null, allUsers = [], schedules = [], campings = [];
    let showModal=false, selectedDate=null, showCampingModal=false, editingCamping=null;
    let showSplash=false, isSignUp=false, showLoginModal=false;
    let currentMonth = new Date();

    const normalizePhone = v => (v||'').replace(/\D/g,'');

    /* =========================
       ê³µí†µ í•¨ìˆ˜
       ========================= */
    function formatDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
    function escapeHtml(t){if(!t)return'';return String(t).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}

    function showLoadingSplash(cb){
      showSplash=true; render();
      setTimeout(()=>{showSplash=false;cb&&cb();render();},2000);
    }

    /* =========================
       ì¸ì¦
       ========================= */
    window.handleAuth = function(){
      const name=document.getElementById('authTeamName').value.trim();
      const phone=normalizePhone(document.getElementById('authPhone').value.trim());
      if(!name||!phone)return alert('íŒ€ ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

      if(isSignUp){
        db.collection('users').where('phone','==',phone).get().then(r=>{
          if(!r.empty)return alert('ì´ë¯¸ ê°€ì…ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.');
          const colorIndex=allUsers.length%colorPalette.length;
          return db.collection('users').add({name,phone,colorIndex});
        }).then(doc=>{
          if(!doc)return;
          currentUser={id:doc.id,name,phone,colorIndex:allUsers.length%colorPalette.length};
          localStorage.setItem('currentUser',JSON.stringify(currentUser));
          showLoginModal=false;
          showLoadingSplash(()=>init());
        });
      }else{
        db.collection('users').where('name','==',name).where('phone','==',phone).get().then(s=>{
          if(s.empty)return alert('ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          const u=s.docs[0];currentUser={id:u.id,...u.data()};
          localStorage.setItem('currentUser',JSON.stringify(currentUser));
          showLoginModal=false;
          showLoadingSplash(()=>init());
        });
      }
    };

    window.openLoginModal=()=>{showLoginModal=true;isSignUp=false;render();};
    window.openSignUpModal=()=>{showLoginModal=true;isSignUp=true;render();};
    window.closeLoginModal=()=>{showLoginModal=false;render();};

    window.logout=()=>{currentUser=null;localStorage.removeItem('currentUser');render();};

    /* =========================
       ì¼ì • ë“±ë¡ (ë‚ ì§œ ë¶„ë¦¬ ìˆ˜ì •)
       ========================= */
    window.openCampingModal=(d)=>{selectedDate=d;showCampingModal=true;render();};
    window.closeCampingModal=()=>{showCampingModal=false;render();};

    window.saveCamping=function(){
      const name=document.getElementById('campingName').value.trim();
      const start=document.getElementById('campingStartDate').value;
      const end=document.getElementById('campingEndDate').value;
      if(!name||!start||!end)return alert('ì´ë¦„ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      const data={name,startDate:start,endDate:end,createdBy:currentUser.id};
      db.collection('campings').add(data).then(()=>{showCampingModal=false;render();});
    };

    /* =========================
       ë Œë”ë§
       ========================= */
    function render(){
      const app=document.getElementById('app');

      if(showSplash){
        app.innerHTML=`
          <div class="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-b from-green-400 to-blue-400">
            <div class="relative w-80 h-80 md:w-96 md:h-96">
              <img src="${splashImg}" alt="ìº í•‘ ë¡œë”©" class="w-full h-full object-contain rounded-lg shadow-lg">
              <div class="absolute left-1/2 bottom-8 -translate-x-1/2 w-16 h-16 bg-orange-400 rounded-full blur-md opacity-70 animate-[flicker_1s_infinite]"></div>
            </div>
            <p class="mt-8 text-white/90 font-medium">ë¡œë”© ì¤‘...</p>
          </div>`;
        return;
      }

      if(!currentUser){
        let modal='';
        if(showLoginModal){
          modal=`<div class="fixed inset-0 bg-black/60 flex items-end" onclick="if(event.target===this)closeLoginModal()">
            <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up">
              <h3 class="text-xl font-bold mb-4">${isSignUp?'íšŒì›ê°€ì…':'ë¡œê·¸ì¸'}</h3>
              <input id="authTeamName" placeholder="íŒ€ ì´ë¦„" class="w-full border p-3 rounded mb-3">
              <input id="authPhone" placeholder="íœ´ëŒ€í° ë²ˆí˜¸" class="w-full border p-3 rounded mb-3">
              <button onclick="handleAuth()" class="w-full py-3 bg-green-600 text-white rounded-lg font-bold">${isSignUp?'ê°€ì…í•˜ê¸°':'ë¡œê·¸ì¸'}</button>
            </div></div>`;
        }
        app.innerHTML=`
        <div class="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-b from-green-400 to-blue-400">
          <div class="text-center mb-8">
            <h1 class="text-6xl mb-4">ğŸ•ï¸</h1>
            <h2 class="text-4xl font-bold text-white mb-2">ê°™ì´ ë†€ëŸ¬ê°€ì</h2>
            <p class="text-white/90 text-lg">ëª¨ë‘ ê°™ì´ ì¼ì •ì„ ê³µìœ í•´ìš”</p>
          </div>
          <div class="w-full max-w-sm space-y-3">
            <button onclick="openLoginModal()" class="w-full py-4 bg-white rounded-2xl shadow-lg font-bold text-lg text-green-600">ë¡œê·¸ì¸</button>
            <button onclick="openSignUpModal()" class="w-full py-4 bg-white/20 rounded-2xl font-bold text-lg text-white border-2 border-white">íšŒì›ê°€ì…</button>
          </div>
          ${modal}
        </div>`;
        return;
      }

      app.innerHTML=`
      <div class="min-h-screen p-4">
        <div class="flex justify-between items-center mb-4">
          <h1 class="text-2xl font-bold">ğŸ•ï¸ ê°™ì´ ë†€ëŸ¬ê°€ì</h1>
          <button onclick="logout()" class="text-xs bg-green-600 text-white rounded-full px-3 py-1">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <button onclick="openCampingModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg">ì¼ì • ë“±ë¡</button>
        ${showCampingModal?`
          <div class="fixed inset-0 bg-black/50 flex items-end" onclick="if(event.target===this)closeCampingModal()">
            <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up">
              <h3 class="text-xl font-bold mb-4">ğŸ•ï¸ ì¼ì • ë“±ë¡</h3>
              <input id="campingName" placeholder="ìº í•‘ì¥ ì´ë¦„" class="w-full border p-3 rounded mb-3">
              <div class="date-grid mb-3">
                <input type="date" id="campingStartDate" class="date-input border rounded">
                <input type="date" id="campingEndDate" class="date-input border rounded">
              </div>
              <div class="flex gap-2">
                <button onclick="closeCampingModal()" class="flex-1 border py-2 rounded">ì·¨ì†Œ</button>
                <button onclick="saveCamping()" class="flex-1 bg-green-600 text-white py-2 rounded">ì €ì¥</button>
              </div>
            </div>
          </div>`:''}
      </div>`;
    }

    /* =========================
       ì´ˆê¸°í™”
       ========================= */
    function init(){
      db.collection('campings').onSnapshot(s=>{
        campings=[];s.forEach(d=>campings.push({id:d.id,...d.data()}));render();
      });
    }

    const saved=localStorage.getItem('currentUser');
    if(saved){try{currentUser=JSON.parse(saved);showLoadingSplash(()=>init());}catch(e){render();}}
    else render();
  </script>
</body>
</html>
