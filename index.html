<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ê°™ì´ ë†€ëŸ¬ê°€ì ğŸ•ï¸</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior-y: contain; }
    
    @keyframes slideUp { 
      from { transform: translateY(100%);} 
      to { transform: translateY(0);} 
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    
    @keyframes sway {
      0%, 100% { transform: rotate(-3deg); }
      50% { transform: rotate(3deg); }
    }
    
    @keyframes flicker {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }
    
    .animate-slide-up { animation: slideUp 0.3s ease-out; }
    .animate-bounce { animation: bounce 2s ease-in-out infinite; }
    .animate-sway { animation: sway 3s ease-in-out infinite; }
    .animate-flicker { animation: flicker 1.5s ease-in-out infinite; }
    
    input, textarea, select { font-size: 16px !important; }

    /* ë‚ ì§œì…ë ¥ UI */
    .date-grid {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 1rem;
    }
    .date-input {
      width: 100%;
      min-width: 150px;
      display: block;
      padding: 0.7rem 0.8rem;
      font-size: 15px !important;
    }
    input[type="date"]::-webkit-date-and-time-value { min-height: 1.6em; }
    @media (max-width: 420px) {
      .date-grid { gap: 0.9rem; }
      .date-input { min-width: 140px; padding: 0.6rem 0.7rem; }
    }
    @media (max-width: 360px) { .date-grid { grid-template-columns: 1fr; } }

    /* sticky í—¤ë” */
    .app-header { position: sticky; top: 0; z-index: 10; }
    
    /* ë¡œë”© í™”ë©´ */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script>
    /* Firebase ì„¤ì • */
    const firebaseConfig = {
      apiKey: "AIzaSyAu15qibhSy3rBEUYXOxRCqoBf-BlpLtJg",
      authDomain: "camp-4cd5d.firebaseapp.com",
      projectId: "camp-4cd5d",
      storageBucket: "camp-4cd5d.firebasestorage.app",
      messagingSenderId: "322221151055",
      appId: "1:322221151055:web:bf81c9f9310b4daf4f6b3a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ìƒìˆ˜/ìƒíƒœ */
    const holidays = {
      '2025-01-01': 'ì‹ ì •','2025-01-28': 'ì„¤ë‚  ì—°íœ´','2025-01-29': 'ì„¤ë‚ ','2025-01-30': 'ì„¤ë‚  ì—°íœ´','2025-03-01': 'ì‚¼ì¼ì ˆ','2025-05-05': 'ì–´ë¦°ì´ë‚ ','2025-05-06': 'ëŒ€ì²´ê³µíœ´ì¼','2025-06-06': 'í˜„ì¶©ì¼','2025-08-15': 'ê´‘ë³µì ˆ','2025-10-03': 'ê°œì²œì ˆ','2025-10-05': 'ì¶”ì„ ì—°íœ´','2025-10-06': 'ì¶”ì„','2025-10-07': 'ì¶”ì„ ì—°íœ´','2025-10-08': 'ëŒ€ì²´ê³µíœ´ì¼','2025-10-09': 'í•œê¸€ë‚ ','2025-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
      '2026-01-01': 'ì‹ ì •','2026-02-16': 'ì„¤ë‚  ì—°íœ´','2026-02-17': 'ì„¤ë‚ ','2026-02-18': 'ì„¤ë‚  ì—°íœ´','2026-03-01': 'ì‚¼ì¼ì ˆ','2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼','2026-05-05': 'ì–´ë¦°ì´ë‚ ','2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ','2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼','2026-06-06': 'í˜„ì¶©ì¼','2026-08-15': 'ê´‘ë³µì ˆ','2026-09-24': 'ì¶”ì„ ì—°íœ´','2026-09-25': 'ì¶”ì„','2026-09-26': 'ì¶”ì„ ì—°íœ´','2026-10-03': 'ê°œì²œì ˆ','2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼','2026-10-09': 'í•œê¸€ë‚ ','2026-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤'
    };
    const colorPalette = ['#6366f1','#ec4899','#10b981','#f59e0b','#8b5cf6','#06b6d4','#f97316','#14b8a6','#a855f7','#ef4444','#3b82f6','#84cc16'];

    let currentUser = null;
    let allUsers = [];
    let schedules = [];
    let campings = [];
    let campingNotes = [];
    let showModal = false;
    let selectedDate = null;
    let showCampingDetail = false;
    let selectedCamping = null;
    let showCampingModal = false;
    let editingCamping = null;
    let currentMonth = new Date();
    let showLoginModal = false;
    let isSignUp = false;
    let isLoading = false;

    let needScrollToToday = false;

    /* ìœ í‹¸ */
    const normalizePhone = (v)=> (v||'').replace(/\D/g,'');
    function formatDate(date){ const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
    function escapeHtml(text){ if(!text) return ''; return String(text).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function getCampingForDateRange(dateStr){ for (let i=0;i<campings.length;i++){ if(dateStr>=campings[i].startDate && dateStr<=campings[i].endDate){ return campings[i]; } } return null; }
    function getDaysDiffInclusive(startDate, endDate){ const s=new Date(startDate); const e=new Date(endDate); return Math.floor((e - s)/(1000*60*60*24)) + 1; }
    function getMonthYear(){ return `${currentMonth.getFullYear()}ë…„ ${currentMonth.getMonth()+1}ì›”`; }

    /* ì˜¤ëŠ˜ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤ */
    function scrollTodayIntoView() {
      const todayId = `day-${formatDate(new Date())}`;
      const el = document.getElementById(todayId);
      if (!el) return;
      el.scrollIntoView({ behavior: 'auto', block: 'start' });

      const header = document.querySelector('.app-header');
      const offset = header ? header.getBoundingClientRect().height + 8 : 0;
      if (offset) window.scrollBy(0, -offset);
    }

    /* Today ë²„íŠ¼ */
    window.goToToday = function() {
      currentMonth = new Date();
      needScrollToToday = true;
      render();
    };

    /* ì›” ì´ë™ */
    window.changeMonth = function(delta){ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+delta, 1); render(); };

    /* ì¸ì¦ ëª¨ë‹¬ */
    window.openLoginModal = function(){ showLoginModal=true; isSignUp=false; render(); };
    window.openSignUpModal = function(){ showLoginModal=true; isSignUp=true; render(); };
    window.closeLoginModal = function(){ showLoginModal=false; isSignUp=false; render(); };
    window.toggleAuthMode = function(){ isSignUp=!isSignUp; render(); };

    /* ë¡œê·¸ì¸/íšŒì›ê°€ì… */
    window.handleAuth = function(){
      const teamName = document.getElementById('authTeamName').value.trim();
      const phoneRaw = document.getElementById('authPhone').value.trim();
      const phone = normalizePhone(phoneRaw);

      if(!teamName || !phone){ alert('íŒ€ ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      const phoneRegex = /^01[0-9]{8,9}$/;
      if(!phoneRegex.test(phone)){ alert('ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }

      if(isSignUp){
        db.collection('users').where('phone','==',phone).limit(1).get().then(sp=>{
          if(!sp.empty){ alert('ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'); throw 'dup-phone'; }
          return db.collection('users').where('name','==',teamName).limit(1).get();
        }).then(sn=>{
          if(!sn.empty){ alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ íŒ€ ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); throw 'dup-name'; }
          const colorIndex = allUsers.length % colorPalette.length;
          const newUser = { name: teamName, phone: phone, colorIndex, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
          return db.collection('users').add(newUser);
        }).then(docRef=>{
          currentUser = { id: docRef.id, name: teamName, phone: phone, colorIndex: (allUsers.length % colorPalette.length) };
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          showLoginModal=false; isSignUp=false;
          allUsers.push(currentUser);
          
          isLoading = true;
          render();
          setTimeout(() => {
            isLoading = false;
            needScrollToToday = true;
            init();
            render();
          }, 2000);
        }).catch(err=>{ if(err!=='dup-phone' && err!=='dup-name'){ alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+err); } });
      } else {
        db.collection('users').where('name','==',teamName).where('phone','==',phone).limit(1).get().then(snap=>{
          if(snap.empty){ alert('íŒ€ ì´ë¦„ ë˜ëŠ” íœ´ëŒ€í° ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
          const doc = snap.docs[0]; const u = doc.data();
          currentUser = { id: doc.id, name: u.name, phone: u.phone, colorIndex: u.colorIndex };
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          showLoginModal=false;
          
          isLoading = true;
          render();
          setTimeout(() => {
            isLoading = false;
            needScrollToToday = true;
            init();
            render();
          }, 2000);
        }).catch(err=>{ alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+err.message); });
      }
    };

    window.logout = function(){ currentUser=null; localStorage.removeItem('currentUser'); render(); };

    /* ìƒíƒœ ëª¨ë‹¬ */
    window.openAddModal = function(dateStr){ selectedDate=dateStr; showModal=true; showCampingDetail=false; render(); };
    window.closeModal = function(){ showModal=false; selectedDate=null; render(); };

    window.setStatus = function(status){
      if(!currentUser || !selectedDate) return;
      const camping = getCampingForDateRange(selectedDate);
      const datesToUpdate = [];
      if(camping){
        const s=new Date(camping.startDate), e=new Date(camping.endDate);
        for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) datesToUpdate.push(formatDate(new Date(d)));
      } else { datesToUpdate.push(selectedDate); }

      const ops = datesToUpdate.map(dateStr=>{
        const existing = schedules.find(s=>s.date===dateStr && s.userId===currentUser.id);
        const data = { title: status, date: dateStr, userId: currentUser.id, userName: currentUser.name, color: colorPalette[currentUser.colorIndex] };
        return existing ? db.collection('schedules').doc(existing.id).update(data) : db.collection('schedules').add(data);
      });

      Promise.all(ops).then(()=>{ showModal=false; selectedDate=null; render(); });
    };

    window.deleteStatus = function(){
      if(!currentUser || !selectedDate) return;
      if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const camping = getCampingForDateRange(selectedDate);
      const datesToDelete = [];
      if(camping){
        const s=new Date(camping.startDate), e=new Date(camping.endDate);
        for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) datesToDelete.push(formatDate(new Date(d)));
      } else { datesToDelete.push(selectedDate); }

      const delOps = [];
      for(const dateStr of datesToDelete){
        for(const s of schedules){ if(s.date===dateStr && s.userId===currentUser.id){ delOps.push(db.collection('schedules').doc(s.id).delete()); } }
      }
      Promise.all(delOps).then(()=>{ showModal=false; selectedDate=null; render(); });
    };

    /* ë†€ëŸ¬ê°ˆê³³ ìƒì„¸/ë“±ë¡ */
    window.openCampingDetail = function(campingId){ 
      selectedCamping = campings.find(c=>c.id===campingId); 
      if(selectedCamping){ 
        showCampingDetail=true; 
        showModal=false; 
        render(); 
      } 
    };
    
    window.closeCampingDetail = function(){ showCampingDetail=false; selectedCamping=null; render(); };
    window.openCampingModal = function(dateStr, campingId){ editingCamping = campingId ? campings.find(c=>c.id===campingId) : null; selectedDate=dateStr; showCampingModal=true; showCampingDetail=false; render(); };
    window.closeCampingModal = function(){ showCampingModal=false; editingCamping=null; render(); };

    /* ë©”ëª¨ ì €ì¥ */
    window.saveNote = function() {
      if (!selectedCamping || !currentUser) return;
      const noteText = document.getElementById('campingNote').value.trim();
      
      const existing = campingNotes.find(n => n.campingId === selectedCamping.id && n.userId === currentUser.id);
      const data = {
        campingId: selectedCamping.id,
        userId: currentUser.id,
        userName: currentUser.name,
        note: noteText,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (existing) {
        db.collection('campingNotes').doc(existing.id).update(data).then(() => {
          alert('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      } else {
        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        db.collection('campingNotes').add(data).then(() => {
          alert('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }
    };

    window.saveCamping = function(){
      const name = document.getElementById('campingName').value.trim();
      const startDate = document.getElementById('campingStartDate').value;
      const endDate = document.getElementById('campingEndDate').value;
      const address = document.getElementById('campingAddress').value.trim();
      const website = document.getElementById('campingWebsite').value.trim();
      const info = document.getElementById('campingInfo').value.trim();

      if(!name || !startDate || !endDate){ alert('ìº í•‘ì¥ ì´ë¦„ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      if(new Date(startDate) > new Date(endDate)){ alert('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì•ì„œì•¼ í•©ë‹ˆë‹¤.'); return; }

      const data = { name, startDate, endDate, address, website, info, createdBy: currentUser.id, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
      const after = ()=>{ showCampingModal=false; editingCamping=null; render(); };
      if(editingCamping){ db.collection('campings').doc(editingCamping.id).update(data).then(after); }
      else { data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); db.collection('campings').add(data).then(after); }
    };

    window.deleteCamping = function(campingId, createdBy){
      if(createdBy !== currentUser.id){ alert('ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
      if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      db.collection('campings').doc(campingId).delete().then(()=>{ showCampingDetail=false; showCampingModal=false; selectedCamping=null; editingCamping=null; render(); });
    };

    /* ë Œë”ë§ */
    function render(){
      const app = document.getElementById('app');

      // ë¡œë”© í™”ë©´
      if(isLoading){
        app.innerHTML = `
        <div class="loading-screen">
          <div class="text-center mb-8">
            <div class="text-8xl mb-4 animate-sway">ğŸ•ï¸</div>
            <div class="text-6xl mb-4 animate-flicker">ğŸ”¥</div>
            <div class="text-5xl animate-bounce">ğŸš¶</div>
          </div>
          <h2 class="text-2xl font-bold text-white mb-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</h2>
          <p class="text-white/80">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤</p>
        </div>`;
        return;
      }

      // ë¡œê·¸ì¸ í™”ë©´
      if(!currentUser){
        let loginModalHtml='';
        if(showLoginModal){
          const colorNotice = isSignUp ? '<div class="text-xs text-blue-700 bg-blue-50 p-3 rounded border border-blue-200">ğŸ¨ ìƒ‰ìƒì€ ê°€ì… ìˆœì„œëŒ€ë¡œ ìë™ìœ¼ë¡œ ë°°ì •ë©ë‹ˆë‹¤</div>' : '';
          loginModalHtml = `
          <div class="fixed inset-0 bg-black/60 z-50 flex items-end" onclick="if(event.target===this)closeLoginModal()">
            <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-5">
                <h3 class="text-xl font-bold">${isSignUp ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}</h3>
                <button onclick="closeLoginModal()" class="text-3xl text-gray-500">Ã—</button>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm mb-2 font-bold">íŒ€ ì´ë¦„</label>
                  <input type="text" id="authTeamName" placeholder="ì˜ˆ) ì„œí•˜ë„¤, ë‹¤ì€ì´ë„¤" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm mb-2 font-bold">íœ´ëŒ€í° ë²ˆí˜¸</label>
                  <input type="tel" id="authPhone" placeholder="010-1234-5678" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg">
                </div>
                ${colorNotice}
                <button onclick="handleAuth()" class="w-full py-3 bg-green-600 text-white rounded-lg font-bold">${isSignUp ? 'ê°€ì…í•˜ê¸°' : 'ë¡œê·¸ì¸'}</button>
                <button onclick="toggleAuthMode()" class="w-full text-sm text-gray-600">${isSignUp ? 'ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”? ë¡œê·¸ì¸' : 'ê³„ì •ì´ ì—†ë‚˜ìš”? íšŒì›ê°€ì…'}</button>
              </div>
            </div>
          </div>`;
        }

        app.innerHTML = `
        <div class="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-b from-green-400 to-blue-400">
          <div class="text-center mb-8">
            <h1 class="text-6xl mb-4">ğŸ•ï¸</h1>
            <h2 class="text-4xl font-bold text-white mb-2">ê°™ì´ ë†€ëŸ¬ê°€ì</h2>
            <p class="text-white/90 text-lg">ëª¨ë‘ ê°™ì´ ì¼ì •ì„ ê³µìœ í•´ìš”</p>
          </div>
          <div class="w-full max-w-sm space-y-3">
            <button onclick="openLoginModal()" class="w-full py-4 bg-white rounded-2xl shadow-lg font-bold text-lg text-green-600">ë¡œê·¸ì¸</button>
            <button onclick="openSignUpModal()" class="w-full py-4 bg-white/20 rounded-2xl font-bold text-lg text-white border-2 border-white">íšŒì›ê°€ì…</button>
          </div>
          ${loginModalHtml}
        </div>`;
        return;
      }

      // ë‹¬ë ¥ ë°ì´í„°
      const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
      const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0);
      const dates = []; 
      for(let d=new Date(firstDay); d<=lastDay; d.setDate(d.getDate()+1)) dates.push(new Date(d));

      let datesHtml = '';
      for(const date of dates){
        const dateStr = formatDate(date);
        const dayOfWeek = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][date.getDay()];
        const isWeekend = date.getDay()===0||date.getDay()===6;
        const isToday = dateStr===formatDate(new Date());
        const holiday = holidays[dateStr];

        const camping = getCampingForDateRange(dateStr);
        const dateSchedules = schedules.filter(s=>s.date===dateStr);
        const attendingUsers = dateSchedules.filter(s=>s.title==='ì°¸ì„');
        const notAttendingUsers = dateSchedules.filter(s=>s.title==='ë¶ˆì°¸');
        const pendingUsers = dateSchedules.filter(s=>s.title==='ë³´ë¥˜');

        // ë©¤ë²„ ìƒíƒœ 3ì—´
        let membersStatusHtml='';
        const chunks=[]; 
        for(let i=0;i<allUsers.length;i+=3) chunks.push(allUsers.slice(i,i+3));
        for(const chunk of chunks){
          membersStatusHtml += '<div class="flex gap-1 mt-2">';
          for(const member of chunk){
            const userSchedule = dateSchedules.find(s=>s.userId===member.id);
            let bg='bg-gray-100', t='text-gray-400';
            if(userSchedule){
              if(userSchedule.title==='ì°¸ì„'){ bg='bg-green-100'; t='text-green-700'; }
              else if(userSchedule.title==='ë³´ë¥˜'){ bg='bg-yellow-100'; t='text-yellow-700'; }
              else { bg='bg-red-100'; t='text-red-700'; }
            }
            membersStatusHtml += `<div class="flex-1 text-center py-1 rounded text-xs ${bg} ${t} font-medium">${escapeHtml(member.name)}</div>`;
          }
          const empty=3-chunk.length; 
          for(let e=0;e<empty;e++){ membersStatusHtml += '<div class="flex-1 py-1 rounded bg-gray-50 border border-gray-200"></div>'; }
          membersStatusHtml += '</div>';
        }

        let statusSummary='';
        if(attendingUsers.length||notAttendingUsers.length||pendingUsers.length){
          statusSummary = '<div class="text-xs text-gray-600 mt-2">' +
            (attendingUsers.length?`<span class="text-green-600">ğŸ‘ ${attendingUsers.length}ëª…</span>`:'') +
            (pendingUsers.length?`${attendingUsers.length?' Â· ':''}<span class="text-yellow-600">â¸ï¸ ${pendingUsers.length}ëª…</span>`:'') +
            (notAttendingUsers.length?`${(attendingUsers.length||pendingUsers.length)?' Â· ':''}<span class="text-red-600">ğŸ‘ ${notAttendingUsers.length}ëª…</span>`:'') +
            '</div>';
        }

        // ë†€ëŸ¬ê°ˆê³³ ì¹´ë“œ
        let campingHtml='';
        if(camping){
          const totalDays = getDaysDiffInclusive(camping.startDate, camping.endDate);
          const infoDays = totalDays>1 ? ` Â· ì´ ${totalDays}ì¼` : '';
          campingHtml = `
            <div onclick="openCampingDetail('${camping.id}')" class="mt-2 bg-yellow-50 border border-yellow-200 rounded-lg p-2 cursor-pointer active:bg-yellow-100">
              <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ•ï¸</span>
                <div class="flex-1 min-w-0">
                  <div class="font-bold text-sm text-yellow-900 truncate">${escapeHtml(camping.name)}</div>
                  <div class="text-xs text-yellow-700">${camping.startDate} ~ ${camping.endDate}${infoDays}</div>
                </div>
              </div>
            </div>`;
        }

        const holidayHtml = holiday ? `<div class="text-xs text-red-500 font-medium mt-1">${holiday}</div>` : '';
        const todayBadge = isToday ? '<span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full ml-1">ì˜¤ëŠ˜</span>' : '';
        const multiDayRing = (camping && getDaysDiffInclusive(camping.startDate, camping.endDate) > 1) ? ' ring-2 ring-green-400' : '';
        const todayBorder = isToday ? ' border-green-500' : ' border-transparent';

        const actionButtons = `
          <div class="flex items-center gap-2 whitespace-nowrap">
            ${!camping ? `<button onclick="openCampingModal('${dateStr}', null)" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-medium">ë“±ë¡</button>` : ''}
            <button onclick="openAddModal('${dateStr}')" class="text-blue-600 font-bold text-xl px-2">+</button>
          </div>`;

        datesHtml += `
          <div id="day-${dateStr}" class="bg-white rounded-xl p-4 shadow-sm border-2${todayBorder}${multiDayRing}">
            <div class="flex items-center justify-between mb-2">
              <div>
                <div class="flex items-center gap-2">
                  <span class="text-2xl font-bold ${ (isWeekend||holiday) ? 'text-red-500':'text-gray-800' }">${date.getDate()}</span>
                  <span class="text-sm ${ (isWeekend||holiday) ? 'text-red-500':'text-gray-500' }">${dayOfWeek}</span>
                  ${todayBadge}
                </div>
                ${holidayHtml}
                ${campingHtml}
              </div>
              ${actionButtons}
            </div>
            ${membersStatusHtml}
            ${statusSummary}
          </div>`;
      }

      // ìƒíƒœ ëª¨ë‹¬
      let modalHtml='';
      if(showModal){
        const mySchedule = schedules.find(s=>s.date===selectedDate && s.userId===currentUser.id);
        let modalContent='';
        if(mySchedule){
          modalContent = `
            <div class="space-y-3">
              <div class="p-4 bg-blue-50 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">í˜„ì¬ ìƒíƒœ</div>
                <div class="text-lg font-bold text-blue-600">${mySchedule.title}</div>
              </div>
              <div class="grid grid-cols-3 gap-2">
                <button onclick="setStatus('ì°¸ì„')" class="py-3 bg-green-600 text-white rounded-lg font-medium">ì°¸ì„</button>
                <button onclick="setStatus('ë³´ë¥˜')" class="py-3 bg-yellow-600 text-white rounded-lg font-medium">ë³´ë¥˜</button>
                <button onclick="setStatus('ë¶ˆì°¸')" class="py-3 bg-red-600 text-white rounded-lg font-medium">ë¶ˆì°¸</button>
              </div>
              <button onclick="deleteStatus()" class="w-full py-3 border border-gray-300 rounded-lg font-medium text-gray-700 mt-2">ì‚­ì œ</button>
            </div>`;
        } else {
          modalContent = `
            <div class="grid grid-cols-3 gap-3">
              <button onclick="setStatus('ì°¸ì„')" class="py-4 bg-green-600 text-white rounded-xl font-bold text-lg">ğŸ‘ ì°¸ì„</button>
              <button onclick="setStatus('ë³´ë¥˜')" class="py-4 bg-yellow-600 text-white rounded-xl font-bold text-lg">â¸ï¸ ë³´ë¥˜</button>
              <button onclick="setStatus('ë¶ˆì°¸')" class="py-4 bg-red-600 text-white rounded-xl font-bold text-lg">ğŸ‘ ë¶ˆì°¸</button>
            </div>`;
        }
        modalHtml = `
          <div class="fixed inset-0 bg-black/50 z-40 flex items-end" onclick="if(event.target===this)closeModal()">
            <div class="bg-white w-full rounded-t-3xl p-5 animate-slide-up">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">${selectedDate}</h3>
                <button onclick="closeModal()" class="text-3xl text-gray-500">Ã—</button>
              </div>
              ${modalContent}
            </div>
          </div>`;
      }

      // ìƒì„¸ ëª¨ë‹¬ (ë©”ëª¨ ê¸°ëŠ¥ í¬í•¨)
      let campingDetailHtml='';
      if(showCampingDetail && selectedCamping){
        const addressHtml = selectedCamping.address ? `<div>ğŸ“ ${escapeHtml(selectedCamping.address)}</div>` : '';
        const websiteHtml = selectedCamping.website ? `<div>ğŸ”— <a href="${selectedCamping.website}" target="_blank" class="text-blue-600">${escapeHtml(selectedCamping.website)}</a></div>` : '';
        const infoHtml = selectedCamping.info ? `<div class="bg-gray-50 rounded-lg p-4"><h5 class="font-medium mb-2">ğŸ“ ì•ˆë‚´ì‚¬í•­</h5><div class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(selectedCamping.info)}</div></div>` : '';
        const editButtonHtml = selectedCamping.createdBy === currentUser.id ? `<button onclick="openCampingModal('${selectedCamping.startDate}', '${selectedCamping.id}')" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium">ìˆ˜ì •</button>` : '';
        const totalDays = getDaysDiffInclusive(selectedCamping.startDate, selectedCamping.endDate);
        const daysHtml = totalDays>1 ? `<div class="text-sm text-gray-700">ì´ ${totalDays}ì¼</div>` : '';

        // ë‚´ ë©”ëª¨ ê°€ì ¸ì˜¤ê¸°
        const myNote = campingNotes.find(n => n.campingId === selectedCamping.id && n.userId === currentUser.id);
        const noteText = myNote ? myNote.note : '';

        // ë‹¤ë¥¸ ì‚¬ëŒë“¤ ë©”ëª¨
        const otherNotes = campingNotes.filter(n => n.campingId === selectedCamping.id && n.userId !== currentUser.id);
        let otherNotesHtml = '';
        if(otherNotes.length > 0){
          otherNotesHtml = '<div class="bg-blue-50 rounded-lg p-4"><h5 class="font-medium mb-2">ğŸ’¬ ë‹¤ë¥¸ ë©¤ë²„ ë©”ëª¨</h5><div class="space-y-2">';
          for(const note of otherNotes){
            otherNotesHtml += `<div class="text-sm"><span class="font-semibold">${escapeHtml(note.userName)}:</span> ${escapeHtml(note.note)}</div>`;
          }
          otherNotesHtml += '</div></div>';
        }

        campingDetailHtml = `
          <div class="fixed inset-0 bg-black/50 z-40 flex items-end" onclick="if(event.target===this)closeCampingDetail()">
            <div class="bg-white w-full rounded-t-3xl p-5 max-h-[90vh] overflow-y-auto animate-slide-up">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ğŸ•ï¸ ë†€ëŸ¬ê°ˆê³³ ì •ë³´</h3>
                <button onclick="closeCampingDetail()" class="text-3xl text-gray-500">Ã—</button>
              </div>
              <div class="space-y-4">
                <div class="bg-yellow-50 rounded-lg p-4">
                  <h4 class="font-bold text-lg mb-2">${escapeHtml(selectedCamping.name)}</h4>
                  <div class="text-sm text-gray-600 space-y-1">
                    <div>ğŸ“… ${selectedCamping.startDate} ~ ${selectedCamping.endDate}</div>
                    ${daysHtml}
                    ${addressHtml}
                    ${websiteHtml}
                  </div>
                </div>
                ${infoHtml}
                
                <div class="bg-green-50 rounded-lg p-4">
                  <h5 class="font-medium mb-2">âœï¸ ë‚´ ë©”ëª¨</h5>
                  <textarea id="campingNote" placeholder="ê°œì¸ ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”..." class="w-full px-3 py-2 border rounded-lg resize-none" rows="3">${escapeHtml(noteText)}</textarea>
                  <button onclick="saveNote()" class="mt-2 w-full py-2 bg-green-600 text-white rounded-lg font-medium">ë©”ëª¨ ì €ì¥</button>
                </div>
                
                ${otherNotesHtml}
                
                <div class="flex gap-2">
                  ${editButtonHtml}
                  <button onclick="closeCampingDetail()" class="flex-1 py-3 border border-gray-300 rounded-lg font-medium">ë‹«ê¸°</button>
                </div>
              </div>
            </div>
          </div>`;
      }

      // í—¤ë” + Today ë²„íŠ¼
      const myColor = colorPalette[currentUser.colorIndex];
      app.innerHTML = `
        <div class="min-h-screen pb-20">
          <div class="app-header bg-green-600 text-white shadow-lg">
            <div class="p-4">
              <div class="flex items-center justify-between mb-3">
                <div><h1 class="text-2xl font-bold">ğŸ•ï¸ ê°™ì´ ë†€ëŸ¬ê°€ì</h1></div>
                <button onclick="logout()" class="text-xs bg-white/20 px-3 py-1 rounded-full">ë¡œê·¸ì•„ì›ƒ</button>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <button onclick="changeMonth(-1)" class="px-2 py-1 bg-white/20 rounded text-lg hover:bg-white/30">â†</button>
                  <h2 class="text-lg font-bold min-w-[120px] text-center">${getMonthYear()}</h2>
                  <button onclick="changeMonth(1)" class="px-2 py-1 bg-white/20 rounded text-lg hover:bg-white/30">â†’</button>
                </div>
                <button onclick="goToToday()" class="px-3 py-1.5 bg-white text-green-700 rounded-lg text-sm font-semibold shadow-sm active:opacity-80">Today</button>
              </div>
              <div class="mt-2 flex items-center gap-2">
                <div class="w-3 h-3 rounded-full" style="background-color:${myColor}"></div>
                <span class="text-sm">${escapeHtml(currentUser.name)}</span>
              </div>
            </div>
          </div>
          <div class="p-3 space-y-3">${datesHtml}</div>
          ${modalHtml}
          ${campingDetailHtml}
          ${showCampingModal ? renderCampingModal() : ''}
        </div>`;

      // ë Œë” ì§í›„ ì˜¤ëŠ˜ë¡œ ìŠ¤í¬ë¡¤
      if (needScrollToToday) {
        needScrollToToday = false;
        requestAnimationFrame(()=>{ scrollTodayIntoView(); requestAnimationFrame(scrollTodayIntoView); });
      }
    }

    // ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬
    function renderCampingModal(){
      const editing = editingCamping;
      const deleteButtonHtml = (editing && editing.createdBy===currentUser.id)
        ? `<div class="pt-4 border-t"><button onclick="deleteCamping('${editing.id}', '${editing.createdBy}')" class="w-full py-2 bg-red-100 text-red-700 rounded-lg font-medium">ì¼ì • ì •ë³´ ì‚­ì œ</button></div>`
        : '';

      return `
      <div class="fixed inset-0 bg-black/50 z-50 flex items-end" onclick="if(event.target===this)closeCampingModal()">
        <div class="bg-white w-full rounded-t-3xl p-5 max-h-[90vh] overflow-y-auto animate-slide-up">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">ğŸ•ï¸ ì¼ì • ${editing ? 'ìˆ˜ì •' : 'ë“±ë¡'}</h3>
            <button onclick="closeCampingModal()" class="text-3xl text-gray-500">Ã—</button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm mb-1 font-medium">ë†€ëŸ¬ê°€ëŠ” ê³³ *</label>
              <input type="text" id="campingName" value="${editing ? escapeHtml(editing.name) : ''}" placeholder="ë³„ë¹›ìº í•‘ì¥" class="w-full px-4 py-3 border rounded-lg">
            </div>
            <div class="date-grid">
              <div>
                <label class="block text-sm mb-1 font-medium">ì‹œì‘ì¼ *</label>
                <input type="date" id="campingStartDate" value="${editing ? editing.startDate : (selectedDate || '')}" class="date-input px-4 py-3 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm mb-1 font-medium">ì¢…ë£Œì¼ *</label>
                <input type="date" id="campingEndDate" value="${editing ? editing.endDate : (selectedDate || '')}" class="date-input px-4 py-3 border rounded-lg">
              </div>
            </div>
            <div class="text-xs text-gray-500 bg-blue-50 p-2 rounded">ğŸ’¡ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„¤ì •í•˜ë©´ 2ë°•3ì¼, 3ë°•4ì¼ ë“±ì˜ ì¼ì •ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
            <div>
              <label class="block text-sm mb-1">ì£¼ì†Œ</label>
              <input type="text" id="campingAddress" value="${editing && editing.address ? escapeHtml(editing.address) : ''}" placeholder="ê²½ê¸°ë„ ê°€í‰êµ°..." class="w-full px-4 py-3 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm mb-1">ì›¹ì‚¬ì´íŠ¸</label>
              <input type="url" id="campingWebsite" value="${editing && editing.website ? escapeHtml(editing.website) : ''}" placeholder="https://..." class="w-full px-4 py-3 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm mb-1">ì•ˆë‚´ ë° ë©”ëª¨</label>
              <textarea id="campingInfo" maxlength="2000" placeholder="ìº í•‘ì¥ íŠ¹ì§•, ì£¼ì˜ì‚¬í•­ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš” (ìµœëŒ€ 2000ì)" class="w-full px-4 py-3 border rounded-lg resize-none" rows="5">${editing && editing.info ? escapeHtml(editing.info) : ''}</textarea>
            </div>
            <div class="flex gap-2 pt-2">
              <button onclick="closeCampingModal()" class="flex-1 py-3 border rounded-lg font-medium">ì·¨ì†Œ</button>
              <button onclick="saveCamping()" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium">ì €ì¥</button>
            </div>
            ${deleteButtonHtml}
          </div>
        </div>
      </div>`;
    }

    /* ì‹¤ì‹œê°„ êµ¬ë… & ë¶€íŒ… */
    function init(){
      db.collection('schedules').onSnapshot(snap=>{ 
        schedules=[]; 
        snap.forEach(doc=>{ schedules.push(Object.assign({ id: doc.id }, doc.data())); }); 
        render(); 
      });
      
      db.collection('campings').onSnapshot(snap=>{ 
        campings=[]; 
        snap.forEach(doc=>{ campings.push(Object.assign({ id: doc.id }, doc.data())); }); 
        render(); 
      });
      
      db.collection('campingNotes').onSnapshot(snap=>{ 
        campingNotes=[]; 
        snap.forEach(doc=>{ campingNotes.push(Object.assign({ id: doc.id }, doc.data())); }); 
        render(); 
      });
    }

    // ì €ì¥ëœ ë¡œê·¸ì¸ ë³µì› + ì˜¤ëŠ˜ ìµœìƒë‹¨
    (function boot(){
      const saved = localStorage.getItem('currentUser');
      if(saved){
        try{
          currentUser = JSON.parse(saved);
          isLoading = true;
          render();
          setTimeout(() => {
            isLoading = false;
            needScrollToToday = true;
            init();
            render();
          }, 1500);
          return;
        }catch(e){ localStorage.removeItem('currentUser'); }
      }
      render();
    })();

    // ìœ ì € ëª©ë¡ ìºì‹œ
    db.collection('users').onSnapshot(snapshot=>{
      allUsers = [];
      snapshot.forEach(doc=>{
        const u=doc.data();
        allUsers.push({ id: doc.id, name: u.name, phone: normalizePhone(u.phone), colorIndex: u.colorIndex });
      });
      render();
    });
  </script>
</body>
</html>
